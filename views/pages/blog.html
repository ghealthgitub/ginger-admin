<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Blog Posts | Ginger Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/admin.css">
<style>
.post-thumb{width:60px;height:40px;border-radius:6px;object-fit:cover;background:var(--gray-100);display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:var(--gray-300)}
.post-thumb img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.post-actions{display:flex;gap:6px;flex-wrap:wrap}
.post-actions a,.post-actions button{font-size:.78rem;padding:3px 8px;border-radius:4px;cursor:pointer;font-family:inherit;text-decoration:none}
.action-edit{background:var(--gray-100);color:var(--navy);border:1px solid var(--gray-200)}.action-edit:hover{background:var(--gray-200)}
.action-quick{background:#EBF5FF;color:#2563EB;border:1px solid #BFDBFE}.action-quick:hover{background:#DBEAFE}
.action-view{background:#F0FDF4;color:#059669;border:1px solid #BBF7D0}.action-view:hover{background:#DCFCE7}
.action-delete{background:#FEF2F2;color:#DC2626;border:1px solid #FECACA}.action-delete:hover{background:#FEE2E2}

/* Quick Edit Inline - Full Width Row */
.quick-edit-row td{background:#F0F5FF!important;border-top:2px solid var(--teal)!important;border-bottom:2px solid var(--teal)!important}
.quick-edit{background:#F0F5FF;padding:20px 24px}
.quick-edit__grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
.quick-edit .form-group{margin-bottom:0}
.quick-edit .form-label{font-size:.78rem;font-weight:700;margin-bottom:4px;color:var(--navy)}
.quick-edit .form-input,.quick-edit .form-select,.quick-edit .form-textarea{font-size:.85rem;padding:8px 12px;background:#fff;border:1.5px solid var(--gray-300);border-radius:6px}
.quick-edit .form-input:focus,.quick-edit .form-select:focus,.quick-edit .form-textarea:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(0,128,128,.1)}
.quick-edit__title{font-size:.82rem;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px;padding-bottom:8px;border-bottom:2px solid var(--teal)}
.quick-edit__actions{display:flex;gap:8px;margin-top:16px;padding-top:12px;border-top:1px solid rgba(0,128,128,.2)}

.post-title-col{max-width:300px}
.post-title-col strong{display:block;color:var(--navy);font-size:.92rem}
.post-title-col .post-slug{font-size:.72rem;color:var(--gray-400);font-family:monospace}

.toolbar{display:flex;gap:12px;margin-bottom:16px;align-items:center;flex-wrap:wrap}
.filter-group{display:flex;gap:8px;align-items:center}
</style><script src="/js/sidebar.js" defer></script>
</head>
<body><div class="layout"><aside class="sidebar" id="sidebar"></aside>

<main class="main"><header class="topbar"><button class="topbar__menu" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button><h1 class="topbar__title" id="pageTitle">Blog Posts</h1><div class="topbar__actions"><a href="/blog/new" class="btn btn--primary">+ New Post</a></div></header>
<div class="content">
    <div class="toolbar">
        <input type="text" class="search-input" placeholder="Search posts..." id="searchInput" oninput="filterPosts()" style="flex:1;max-width:400px">
        <div class="filter-group">
            <select class="form-select" id="catFilter" onchange="filterPosts()" style="width:auto;font-size:.85rem"><option value="">All Categories</option><option>Guide</option><option>Cost</option><option>Treatment</option><option>Patient Story</option><option>News</option><option>Tips</option></select>
            <select class="form-select" id="statusFilter" onchange="filterPosts()" style="width:auto;font-size:.85rem"><option value="">All Status</option><option value="published">Published</option><option value="draft">Draft</option></select>
        </div>
    </div>
    <div class="card"><div class="card__body">
        <table class="data-table"><thead><tr><th style="width:70px">Image</th><th>Title</th><th>Category</th><th>Tags</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="list"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody></table>
    </div></div>
</div></main></div>

<script>
let posts = [];
async function safeFetch(url, options) {
    for (let attempt = 0; attempt < 3; attempt++) {
        try {
            const r = await fetch(url, options);
            if (r.status === 429) { await new Promise(ok => setTimeout(ok, 1000 * (attempt + 1))); continue; }
            return r;
        } catch(e) { if (attempt === 2) throw e; await new Promise(ok => setTimeout(ok, 1000)); }
    }
}
async function load() {
    try {
        const r = await safeFetch('/api/blog');
        if (!r || !r.ok) { document.getElementById('list').innerHTML = '<tr><td colspan="7" class="empty-state">Error loading posts. Please refresh.</td></tr>'; return; }
        posts = await r.json();
        document.getElementById('pageTitle').textContent = `Blog Posts (${posts.length})`;
        filterPosts();
    } catch(e) { document.getElementById('list').innerHTML = '<tr><td colspan="7" class="empty-state">Error loading. Please refresh.</td></tr>'; }
}

function filterPosts() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const cat = document.getElementById('catFilter').value;
    const status = document.getElementById('statusFilter').value;
    const filtered = posts.filter(p =>
        (!q || p.title.toLowerCase().includes(q)) &&
        (!cat || p.category === cat) &&
        (!status || p.status === status)
    );
    const tb = document.getElementById('list');
    if (!filtered.length) { tb.innerHTML = '<tr><td colspan="7" class="empty-state">No posts found</td></tr>'; return; }
    tb.innerHTML = filtered.map(p => `
        <tr id="row-${p.id}">
            <td><div class="post-thumb">${p.cover_image ? `<img src="${p.cover_image}" onerror="this.parentElement.innerHTML='üìù'">` : 'üìù'}</div></td>
            <td class="post-title-col">
                <strong><a href="/blog/edit/${p.id}" style="color:var(--navy)">${p.title}</a></strong>
                <span class="post-slug">/blog/${p.slug}/</span>
                <div class="post-actions" style="margin-top:4px">
                    <a href="/blog/edit/${p.id}" class="action-edit">Edit</a>
                    <button class="action-quick" onclick="toggleQuickEdit(${p.id})">Quick Edit</button>
                    ${p.status === 'published' ? `<a href="https://ginger.healthcare/blog/${p.slug}/" target="_blank" class="action-view">View</a>` : `<a href="/blog/edit/${p.id}" class="action-view" style="background:#FFF7ED;color:#D97706;border-color:#FED7AA">Preview</a>`}
                    <button class="action-delete" onclick="deletePost(${p.id})">Trash</button>
                </div>
            </td>
            <td><span class="badge" style="background:var(--gray-100);color:var(--gray-600);font-size:.75rem">${p.category || '-'}</span></td>
            <td style="font-size:.78rem;color:var(--gray-400)">${(p.tags||[]).join(', ') || '-'}</td>
            <td><span class="badge badge--${p.status}">${p.status}</span></td>
            <td style="font-size:.78rem;color:var(--gray-400)">${p.published_at ? new Date(p.published_at).toLocaleDateString() : '-'}</td>
            <td></td>
        </tr>
        <tr class="quick-edit-row" id="qe-row-${p.id}" style="display:none">
            <td colspan="7" style="padding:0;border:none">
                <div class="quick-edit open">
                    <div class="quick-edit__title">QUICK EDIT</div>
                    <div class="quick-edit__grid">
                        <div>
                            <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="qe-title-${p.id}" value="${p.title}"></div>
                            <div class="form-group" style="margin-top:12px"><label class="form-label">Slug</label><input class="form-input" id="qe-slug-${p.id}" value="${p.slug}"></div>
                            <div class="form-group" style="margin-top:12px"><label class="form-label">Status</label><select class="form-select" id="qe-status-${p.id}"><option value="draft" ${p.status==='draft'?'selected':''}>Draft</option><option value="published" ${p.status==='published'?'selected':''}>Published</option></select></div>
                        </div>
                        <div>
                            <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="qe-cat-${p.id}"><option value="">None</option><option ${p.category==='Guide'?'selected':''}>Guide</option><option ${p.category==='Cost'?'selected':''}>Cost</option><option ${p.category==='Treatment'?'selected':''}>Treatment</option><option ${p.category==='Patient Story'?'selected':''}>Patient Story</option><option ${p.category==='News'?'selected':''}>News</option><option ${p.category==='Tips'?'selected':''}>Tips</option></select></div>
                            <div class="form-group" style="margin-top:12px"><label class="form-label">Read Time (min)</label><input class="form-input" type="number" id="qe-read-${p.id}" value="${p.read_time||''}"></div>
                            <div class="form-group" style="margin-top:12px"><label class="form-label">Tags</label><input class="form-input" id="qe-tags-${p.id}" value="${(p.tags||[]).join(', ')}" placeholder="Separate tags with commas"></div>
                        </div>
                        <div>
                            <div class="form-group"><label class="form-label">Excerpt</label><textarea class="form-textarea" id="qe-excerpt-${p.id}" style="min-height:140px;font-size:.85rem" placeholder="Brief summary...">${(p.excerpt||'').replace(/"/g,'&amp;quot;')}</textarea></div>
                        </div>
                    </div>
                    <div class="quick-edit__actions">
                        <button class="btn btn--primary btn--sm" onclick="quickSave(${p.id})">üíæ Update</button>
                        <button class="btn btn--outline btn--sm" onclick="toggleQuickEdit(${p.id})">Cancel</button>
                    </div>
                </div>
            </td>
        </tr>
    `).join('');
}

function toggleQuickEdit(id) {
    const row = document.getElementById('qe-row-' + id);
    row.style.display = row.style.display === 'none' ? '' : 'none';
}

async function quickSave(id) {
    const tagsVal = document.getElementById('qe-tags-' + id).value;
    const data = {
        title: document.getElementById('qe-title-' + id).value,
        slug: document.getElementById('qe-slug-' + id).value,
        status: document.getElementById('qe-status-' + id).value,
        category: document.getElementById('qe-cat-' + id).value,
        excerpt: document.getElementById('qe-excerpt-' + id).value,
        read_time: parseInt(document.getElementById('qe-read-' + id).value) || null,
        tags: tagsVal ? tagsVal.split(',').map(t => t.trim()).filter(t => t) : []
    };
    const r = await fetch('/api/blog/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    if (r.ok) { load(); } else { alert('Save failed'); }
}

async function deletePost(id) {
    if (!confirm('Delete this post?')) return;
    await fetch('/api/blog/' + id, { method: 'DELETE' });
    load();
}

// Load user
// Auth handled by sidebar.js;
load();
</body></html>
