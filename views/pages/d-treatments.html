<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Destination Treatments | Ginger Admin</title><link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/admin.css"><link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>.ql-editor{min-height:150px;font-size:.92rem;line-height:1.7;font-family:"DM Sans",sans-serif}.ql-toolbar{border-color:var(--gray-200)!important;background:var(--gray-50);border-radius:8px 8px 0 0}.ql-container{border-color:var(--gray-200)!important;border-radius:0 0 8px 8px}.combo-label{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:50px;font-size:.75rem;font-weight:600;background:rgba(14,165,160,.1);color:var(--teal)}.mp-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;align-items:center;justify-content:center}.mp-bg.open{display:flex}
.mp-modal{background:#fff;border-radius:12px;width:720px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.mp-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--gray-200);font-weight:600;font-size:.95rem;color:var(--navy)}
.mp-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:16px;overflow-y:auto;max-height:50vh;min-height:200px}
.mp-item{border:2px solid var(--gray-200);border-radius:8px;overflow:hidden;cursor:pointer;aspect-ratio:1;transition:all .15s}.mp-item:hover{border-color:var(--teal)}.mp-item.selected{border-color:var(--ginger);box-shadow:0 0 0 2px rgba(242,101,34,.3)}
.mp-item img{width:100%;height:100%;object-fit:cover}
.mp-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 20px;border-top:1px solid var(--gray-200)}
.img-pick{display:flex;align-items:center;gap:10px;padding:10px;border:1.5px dashed var(--gray-300);border-radius:8px;min-height:56px}
.img-pick__preview{width:48px;height:48px;border-radius:6px;overflow:hidden;flex-shrink:0;background:var(--gray-100);display:flex;align-items:center;justify-content:center;font-size:1.5rem}
.img-pick__preview img{width:100%;height:100%;object-fit:cover}
.img-pick__actions{display:flex;gap:6px;flex-wrap:wrap}
</style>
</head><body><div class="layout"><aside class="sidebar" id="sidebar"></aside>
<main class="main"><header class="topbar"><button class="topbar__menu" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button><h1 class="topbar__title">üåê Destination Treatments <span class="combo-label">Page A</span></h1><div class="topbar__actions"><button class="btn btn--primary" onclick="openModal()">+ Add D. Treatment</button></div></header><div class="content"><div class="toolbar"><input type="text" class="search-input" placeholder="Search..." id="searchInput" oninput="filter()"><select class="form-select" style="width:auto" id="destFilter" onchange="filter()"><option value="">All Destinations</option></select><select class="form-select" style="width:auto" id="specFilter" onchange="filter()"><option value="">All Specialties</option></select></div><div class="card"><div class="card__body"><table class="data-table"><thead><tr><th>Name</th><th>Destination</th><th>Treatment</th><th>Cost (USD)</th><th>Status</th><th>Actions</th></tr></thead><tbody id="list"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody></table></div></div></div>
<div class="modal-overlay" id="modal"><div class="modal" style="max-width:720px"><div class="modal__header"><h3 id="modalTitle">Add Destination Treatment</h3><button class="modal__close" onclick="closeModal()">‚úï</button></div><div class="modal__body">
<div class="form-row"><div class="form-group"><label class="form-label">Destination</label><select class="form-select" id="f_destination" onchange="autoName()"></select></div><div class="form-group"><label class="form-label">Specialty (for grouping)</label><select class="form-select" id="f_specialty" onchange="filterTreatments()"></select></div></div>
<div class="form-row"><div class="form-group"><label class="form-label">Treatment</label><select class="form-select" id="f_treatment" onchange="autoName()"></select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f_status"><option value="draft">Draft</option><option value="published">Published</option></select></div></div>
<div class="form-row"><div class="form-group"><label class="form-label">Page Title (auto-generated)</label><input type="text" class="form-input" id="f_name" placeholder="e.g. CABG Surgery in India"></div><div class="form-group"><label class="form-label">Slug</label><input type="text" class="form-input" id="f_slug" placeholder="e.g. cabg"></div></div>
<div class="form-group"><label class="form-label">Short Description</label><textarea class="form-textarea" id="f_desc" rows="2" placeholder="Brief description for this treatment in this country"></textarea></div>
<div class="form-group"><label class="form-label">Long Description (Rich Text)</label><div id="f_longdesc_editor"></div></div>
<div class="form-row"><div class="form-group"><label class="form-label">Cost Min (USD)</label><input type="number" class="form-input" id="f_cost_min" placeholder="e.g. 3500"></div><div class="form-group"><label class="form-label">Cost Max (USD)</label><input type="number" class="form-input" id="f_cost_max" placeholder="e.g. 7000"></div></div>
<div class="form-row"><div class="form-group"><label class="form-label">Cost Includes</label><input type="text" class="form-input" id="f_cost_includes" placeholder="e.g. Hospital stay, surgeon fees, pre-op tests"></div><div class="form-group"><label class="form-label">Hospital Stay</label><input type="text" class="form-input" id="f_hospital_stay" placeholder="e.g. 5-7 days"></div></div>
<div class="form-row"><div class="form-group"><label class="form-label">Image</label>
<div class="img-pick" id="imgPick"><div class="img-pick__preview" id="imgPreview">üñºÔ∏è</div><div class="img-pick__actions"><button type="button" class="btn btn--outline btn--sm" onclick="openMediaPicker('f_image','imgPreview')">Choose Image</button><button type="button" class="btn btn--outline btn--sm" id="imgRemove" style="display:none" onclick="clearImage('f_image','imgPreview','imgRemove')">‚úï</button></div></div>
<input type="hidden" id="f_image"></div><div class="form-group"><label class="form-label">Hero Background</label>
<div class="img-pick" id="heroPick"><div class="img-pick__preview" id="heroPreview">üåÑ</div><div class="img-pick__actions"><button type="button" class="btn btn--outline btn--sm" onclick="openMediaPicker('f_hero_bg','heroPreview')">Choose Image</button><button type="button" class="btn btn--outline btn--sm" id="heroRemove" style="display:none" onclick="clearImage('f_hero_bg','heroPreview','heroRemove')">‚úï</button></div></div>
<input type="hidden" id="f_hero_bg"></div></div>
<div class="form-row"><div class="form-group"><label class="form-label">Meta Title</label><input type="text" class="form-input" id="f_meta_title" placeholder="SEO title"></div><div class="form-group"><label class="form-label">Meta Description</label><input type="text" class="form-input" id="f_meta_desc" placeholder="SEO description"></div></div>
</div><div class="modal__footer"><button class="btn btn--outline" onclick="closeModal()">Cancel</button><button class="btn btn--primary" onclick="saveItem()">Save</button></div></div></div>
<!-- Media Picker -->
<div class="mp-bg" id="mediaPicker" onclick="if(event.target===this)closeMediaPicker()">
<div class="mp-modal"><div class="mp-header"><span>Select Image</span><div style="display:flex;align-items:center;gap:8px"><label class="btn btn--outline btn--sm" style="cursor:pointer">üì§ Upload<input type="file" accept="image/*" onchange="uploadFile(this)" style="display:none"></label><button style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--gray-400)" onclick="closeMediaPicker()">‚úï</button></div></div>
<div id="uploadStatus" style="display:none;padding:8px 20px;font-size:.82rem;color:var(--teal);background:var(--gray-50);border-bottom:1px solid var(--gray-200)"></div>
<div class="mp-grid" id="mediaGrid"></div>
<div class="mp-footer"><button class="btn btn--outline btn--sm" onclick="closeMediaPicker()">Cancel</button><button class="btn btn--primary btn--sm" onclick="confirmMedia()">Use This Image</button></div></div></div>
</main></div>
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
let items=[],dests=[],specs=[],treats=[],editId=null,quillLong=null;

function autoName(){
    const d=dests.find(x=>x.id==document.getElementById('f_destination').value);
    const t=treats.find(x=>x.id==document.getElementById('f_treatment').value);
    if(d&&t){
        document.getElementById('f_name').value=t.name+' in '+d.name;
        document.getElementById('f_slug').value=t.slug;
    }
}

function filterTreatments(){
    const sid=document.getElementById('f_specialty').value;
    const ft=document.getElementById('f_treatment');
    const filtered=sid?treats.filter(t=>t.specialty_id==sid):treats;
    ft.innerHTML='<option value="">Select treatment</option>'+filtered.map(t=>'<option value="'+t.id+'">'+t.name+'</option>').join('');
}

async function load(){
    const[r1,r2,r3,r4]=await Promise.all([fetch('/api/d-treatments'),fetch('/api/destinations'),fetch('/api/specialties'),fetch('/api/treatments')]);
    items=await r1.json();dests=await r2.json();specs=await r3.json();treats=await r4.json();
    const df=document.getElementById('destFilter'),sf=document.getElementById('specFilter');
    const fd=document.getElementById('f_destination'),fs=document.getElementById('f_specialty'),ft=document.getElementById('f_treatment');
    df.innerHTML='<option value="">All Destinations</option>'+dests.map(d=>'<option value="'+d.id+'">'+(d.flag||'')+' '+d.name+'</option>').join('');
    sf.innerHTML='<option value="">All Specialties</option>'+specs.map(s=>'<option value="'+s.id+'">'+s.name+'</option>').join('');
    fd.innerHTML='<option value="">Select destination</option>'+dests.map(d=>'<option value="'+d.id+'">'+(d.flag||'')+' '+d.name+'</option>').join('');
    fs.innerHTML='<option value="">Select specialty</option>'+specs.map(s=>'<option value="'+s.id+'">'+s.name+'</option>').join('');
    ft.innerHTML='<option value="">Select treatment</option>'+treats.map(t=>'<option value="'+t.id+'">'+t.name+'</option>').join('');
    filter();
}

function filter(){
    const q=document.getElementById('searchInput').value.toLowerCase();
    const did=document.getElementById('destFilter').value;
    const sid=document.getElementById('specFilter').value;
    const f=items.filter(i=>{
        const matchQ=!q||(i.name||'').toLowerCase().includes(q)||(i.destination_name||'').toLowerCase().includes(q)||(i.treatment_name||'').toLowerCase().includes(q);
        const matchD=!did||i.destination_id==did;
        const matchS=!sid||i.specialty_id==sid;
        return matchQ&&matchD&&matchS;
    });
    const tb=document.getElementById('list');
    if(!f.length){tb.innerHTML='<tr><td colspan="6" class="empty-state">No destination treatments found. Click "+ Add D. Treatment" to create one.</td></tr>';return}
    tb.innerHTML=f.map(i=>{
        const cost=i.cost_min_usd?'$'+Number(i.cost_min_usd).toLocaleString()+(i.cost_max_usd?' ‚Äì $'+Number(i.cost_max_usd).toLocaleString():''):'-';
        var viewUrl='https://ginger.healthcare/destinations/'+(i.destination_slug||'')+'/'+(i.specialty_slug||'')+'/'+(i.treatment_slug||i.slug)+'/';
        return '<tr><td><strong>'+i.name+'</strong></td><td>'+(i.destination_flag||'')+' '+(i.destination_name||'-')+'</td><td>'+(i.treatment_name||'-')+'</td><td>'+cost+'</td><td><span class="badge badge--'+i.status+'">'+i.status+'</span></td><td><a href="'+viewUrl+'" target="_blank" class="btn btn--outline btn--sm" title="View on site">üëÅ</a> <button class="btn btn--outline btn--sm" onclick="editItem('+i.id+')">Edit</button> <button class="btn btn--danger btn--sm" onclick="deleteItem('+i.id+')">üóë</button></td></tr>'
    }).join('');
}

function initQuill(){
    if(!quillLong){quillLong=new Quill('#f_longdesc_editor',{theme:'snow',placeholder:'Detailed content about this treatment in this country ‚Äî hospitals, doctors, process, costs...',modules:{toolbar:[['bold','italic','underline'],[{'header':[2,3,false]}],[{'list':'ordered'},{'list':'bullet'}],['link','image'],['clean']]}})}
}

function openModal(){
    editId=null;document.getElementById('modalTitle').textContent='Add Destination Treatment';
    document.getElementById('modal').classList.add('open');
    ['f_name','f_slug','f_desc','f_image','f_hero_bg','f_meta_title','f_meta_desc','f_cost_min','f_cost_max','f_cost_includes','f_hospital_stay'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('f_destination').value='';document.getElementById('f_specialty').value='';document.getElementById('f_treatment').value='';document.getElementById('f_status').value='draft';clearImage('f_image','imgPreview','imgRemove');clearImage('f_hero_bg','heroPreview','heroRemove');
    setTimeout(()=>{initQuill();quillLong.root.innerHTML=''},100);
}

function editItem(id){
    const i=items.find(x=>x.id===id);if(!i)return;editId=id;
    document.getElementById('modalTitle').textContent='Edit: '+i.name;
    document.getElementById('modal').classList.add('open');
    document.getElementById('f_destination').value=i.destination_id||'';
    document.getElementById('f_specialty').value=i.specialty_id||'';
    filterTreatments();
    setTimeout(()=>{document.getElementById('f_treatment').value=i.treatment_id||''},50);
    document.getElementById('f_name').value=i.name||'';
    document.getElementById('f_slug').value=i.slug||'';
    document.getElementById('f_desc').value=i.description||'';
    document.getElementById('f_cost_min').value=i.cost_min_usd||'';
    document.getElementById('f_cost_max').value=i.cost_max_usd||'';
    document.getElementById('f_cost_includes').value=i.cost_includes||'';
    document.getElementById('f_hospital_stay').value=i.hospital_stay||'';
    document.getElementById('f_image').value=i.image||'';
    document.getElementById('f_hero_bg').value=i.hero_bg||'';
    document.getElementById('f_meta_title').value=i.meta_title||'';
    document.getElementById('f_meta_desc').value=i.meta_description||'';
    document.getElementById('f_status').value=i.status||'draft';
    setTimeout(()=>{initQuill();quillLong.root.innerHTML=i.long_description||''},150);
    showImagePreview('f_image','imgPreview','imgRemove');showImagePreview('f_hero_bg','heroPreview','heroRemove');
}

function closeModal(){document.getElementById('modal').classList.remove('open')}

async function saveItem(){
    const data={
        destination_id:parseInt(document.getElementById('f_destination').value)||null,
        treatment_id:parseInt(document.getElementById('f_treatment').value)||null,
        specialty_id:parseInt(document.getElementById('f_specialty').value)||null,
        name:document.getElementById('f_name').value,
        slug:document.getElementById('f_slug').value,
        description:document.getElementById('f_desc').value,
        long_description:quillLong?quillLong.root.innerHTML:'',
        cost_min_usd:parseInt(document.getElementById('f_cost_min').value)||null,
        cost_max_usd:parseInt(document.getElementById('f_cost_max').value)||null,
        cost_includes:document.getElementById('f_cost_includes').value,
        hospital_stay:document.getElementById('f_hospital_stay').value,
        image:document.getElementById('f_image').value,
        hero_bg:document.getElementById('f_hero_bg').value,
        meta_title:document.getElementById('f_meta_title').value,
        meta_description:document.getElementById('f_meta_desc').value,
        status:document.getElementById('f_status').value
    };
    if(!data.destination_id||!data.treatment_id){alert('Please select both destination and treatment');return}
    if(!data.name){alert('Name is required');return}
    const url=editId?'/api/d-treatments/'+editId:'/api/d-treatments';
    const method=editId?'PUT':'POST';
    const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    if(r.ok){closeModal();load()}else{const e=await r.json();alert(e.error||'Error saving')}
}

async function deleteItem(id){if(!confirm('Delete this destination treatment?'))return;await fetch('/api/d-treatments/'+id,{method:'DELETE'});load()}
let mpTargetInput=null,mpTargetPreview=null,selectedMediaUrl=null;
async function openMediaPicker(inputId,previewId){
    mpTargetInput=inputId;mpTargetPreview=previewId;selectedMediaUrl=null;
    document.getElementById('mediaPicker').classList.add('open');
    try{
        const r=await fetch('/api/media');const media=await r.json();
        document.getElementById('mediaGrid').innerHTML=media.filter(m=>m.mime_type&&m.mime_type.startsWith('image/')).map(m=>'<div class="mp-item" onclick="pickMedia(this,\''+m.url+'\')"><img src="'+m.url+'"></div>').join('')||'<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--gray-400)">No images. Upload one first.</div>';
    }catch(e){console.error(e)}
}
function closeMediaPicker(){document.getElementById('mediaPicker').classList.remove('open')}
function pickMedia(el,url){document.querySelectorAll('.mp-item').forEach(i=>i.classList.remove('selected'));el.classList.add('selected');selectedMediaUrl=url}
function confirmMedia(){
    if(!selectedMediaUrl){alert('Select an image');return}
    document.getElementById(mpTargetInput).value=selectedMediaUrl;
    var src=selectedMediaUrl.startsWith('http')?selectedMediaUrl:'https://enter.ginger.healthcare'+selectedMediaUrl;
    document.getElementById(mpTargetPreview).innerHTML='<img src="'+src+'">';
    var rmBtn=mpTargetInput==='f_image'?'imgRemove':'heroRemove';
    document.getElementById(rmBtn).style.display='';
    closeMediaPicker();
}
function clearImage(inputId,previewId,rmBtnId){
    document.getElementById(inputId).value='';
    document.getElementById(previewId).innerHTML=inputId==='f_image'?'üñºÔ∏è':'üåÑ';
    document.getElementById(rmBtnId).style.display='none';
}
async function uploadFile(input){
    var file=input.files[0];if(!file)return;
    var status=document.getElementById('uploadStatus');status.style.display='';status.textContent='‚è≥ Uploading '+file.name+'...';
    try{var fd=new FormData();fd.append('file',file);var r=await fetch('/api/media/upload',{method:'POST',body:fd});
    if(r.ok){status.textContent='‚úÖ Uploaded! Refreshing...';input.value='';setTimeout(()=>{status.style.display='none';openMediaPicker(mpTargetInput,mpTargetPreview)},500)}
    else{var e=await r.json();status.textContent='‚ùå '+(e.error||'Failed')}}catch(e){status.textContent='‚ùå '+e.message}
}
function showImagePreview(inputId,previewId,rmBtnId){
    var v=document.getElementById(inputId).value;
    if(v){var src=v.startsWith('http')?v:'https://enter.ginger.healthcare'+v;document.getElementById(previewId).innerHTML='<img src="'+src+'">';document.getElementById(rmBtnId).style.display=''}
    else{document.getElementById(previewId).innerHTML=inputId==='f_image'?'üñºÔ∏è':'üåÑ';document.getElementById(rmBtnId).style.display='none'}
}
load();
</script>
<script src="/js/sidebar.js"></script>
</body></html>
