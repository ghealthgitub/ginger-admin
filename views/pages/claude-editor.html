<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AI Visual Editor | Ginger Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
:root{--navy:#0B2545;--navy-light:#13315C;--navy-deep:#071A33;--ginger:#F26522;--ginger-dark:#D9531E;--teal:#0EA5A0;--white:#FFFFFF;--gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;--gray-400:#9CA3AF;--gray-500:#6B7280;--gray-600:#4B5563;--gray-700:#374151}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',system-ui,sans-serif;color:var(--gray-700);background:var(--navy-deep);font-size:14px;-webkit-font-smoothing:antialiased;height:100vh;overflow:hidden}

/* TOP BAR */
.topbar{display:flex;align-items:center;gap:12px;padding:10px 20px;background:var(--navy-deep);border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
.topbar__logo{display:flex;align-items:center;gap:8px;color:#fff;font-weight:700;font-size:.95rem;text-decoration:none}
.topbar__logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--ginger),var(--ginger-dark));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:800;color:#fff}
.topbar__back{color:rgba(255,255,255,.5);font-size:.82rem;text-decoration:none;padding:6px 12px;border:1px solid rgba(255,255,255,.12);border-radius:6px;transition:all .2s}
.topbar__back:hover{color:#fff;border-color:rgba(255,255,255,.3)}
.topbar__title{flex:1;color:#fff;font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.topbar__status{font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:50px;text-transform:uppercase}
.topbar__status--draft{background:rgba(251,191,36,.15);color:#FBBF24;border:1px solid rgba(251,191,36,.3)}
.topbar__status--published{background:rgba(16,185,129,.15);color:#10B981;border:1px solid rgba(16,185,129,.3)}
.topbar__actions{display:flex;gap:8px}
.topbar__btn{padding:7px 16px;border-radius:6px;font-weight:600;font-size:.82rem;cursor:pointer;border:none;font-family:inherit;transition:all .2s}
.topbar__btn--save{background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}
.topbar__btn--save:hover{background:rgba(255,255,255,.15);color:#fff}
.topbar__btn--publish{background:var(--ginger);color:#fff;box-shadow:0 2px 8px rgba(242,101,34,.3)}
.topbar__btn--publish:hover{background:var(--ginger-dark)}
.topbar__saved{color:rgba(255,255,255,.35);font-size:.78rem;display:none}

/* MAIN LAYOUT */
.editor-layout{display:grid;grid-template-columns:420px 1fr;height:calc(100vh - 53px)}

/* LEFT: CLAUDE CHAT */
.chat-panel{display:flex;flex-direction:column;background:linear-gradient(180deg,#0B2545,#0D1B2A);border-right:1px solid rgba(255,255,255,.06)}
.chat-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
.chat-header__title{color:#fff;font-size:1rem;font-weight:700;display:flex;align-items:center;gap:8px}
.chat-header__title span{font-size:1.1rem}
.chat-header__sub{color:rgba(255,255,255,.35);font-size:.78rem;margin-top:4px}

.chat-messages{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px}
.chat-messages::-webkit-scrollbar{width:4px}.chat-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}

.msg{padding:12px 16px;border-radius:12px;font-size:.88rem;line-height:1.65;max-width:95%;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg--user{background:rgba(242,101,34,.12);color:rgba(255,255,255,.9);align-self:flex-end;border-bottom-right-radius:4px}
.msg--ai{background:rgba(255,255,255,.05);color:rgba(255,255,255,.8);align-self:flex-start;border-bottom-left-radius:4px}
.msg--ai code{background:rgba(0,0,0,.3);padding:1px 5px;border-radius:3px;font-size:.82rem}
.msg--system{background:rgba(14,165,160,.1);color:var(--teal);align-self:center;font-size:.8rem;font-weight:600;border-radius:20px;padding:6px 16px}

.msg__actions{display:flex;gap:6px;margin-top:10px}
.msg__btn{padding:5px 12px;border-radius:6px;font-size:.78rem;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s}
.msg__btn--insert{background:var(--teal);color:#fff}.msg__btn--insert:hover{background:#0c918c}
.msg__btn--append{background:rgba(255,255,255,.08);color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.12)}.msg__btn--append:hover{color:#fff;background:rgba(255,255,255,.15)}
.msg__btn--copy{background:rgba(255,255,255,.08);color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.12)}.msg__btn--copy:hover{color:#fff;background:rgba(255,255,255,.15)}

/* Quick Actions */
.chat-quick{display:flex;flex-wrap:wrap;gap:6px;padding:10px 20px;border-top:1px solid rgba(255,255,255,.06)}
.quick-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.5);border-radius:8px;padding:6px 12px;font-size:.78rem;cursor:pointer;font-family:inherit;transition:all .2s}
.quick-btn:hover{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.2)}

/* Input Area */
.chat-input{display:flex;gap:10px;padding:14px 20px;border-top:1px solid rgba(255,255,255,.06);background:rgba(0,0,0,.2)}
.chat-input textarea{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 16px;color:#fff;font-size:.88rem;font-family:inherit;resize:none;min-height:48px;max-height:120px;line-height:1.5}
.chat-input textarea::placeholder{color:rgba(255,255,255,.25)}
.chat-input textarea:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 2px rgba(14,165,160,.15)}
.chat-input button{align-self:flex-end;background:var(--ginger);color:#fff;border:none;border-radius:10px;padding:12px 20px;font-weight:700;font-size:.88rem;cursor:pointer;font-family:inherit;transition:all .2s;white-space:nowrap}
.chat-input button:hover{background:var(--ginger-dark)}
.chat-input button:disabled{opacity:.4;cursor:not-allowed}

/* RIGHT: EDITOR + PREVIEW */
.editor-panel{display:flex;flex-direction:column;background:var(--white);overflow:hidden}

/* Editor Tabs */
.editor-tabs{display:flex;align-items:center;padding:0 20px;border-bottom:2px solid var(--gray-200);background:var(--gray-50)}
.editor-tab{padding:12px 20px;font-size:.88rem;font-weight:600;color:var(--gray-400);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.editor-tab.active{color:var(--teal);border-bottom-color:var(--teal)}
.editor-tab:hover:not(.active){color:var(--gray-600)}
.editor-tabs__info{margin-left:auto;font-size:.78rem;color:var(--gray-400)}

/* Quill in Visual Editor */
.editor-content{flex:1;overflow:hidden;display:flex;flex-direction:column}
.editor-content .ql-toolbar{border:none!important;border-bottom:1px solid var(--gray-200)!important;border-radius:0!important;background:#F0F5FF;padding:8px 16px!important}
.editor-content .ql-container{border:none!important;flex:1;overflow-y:auto}
.editor-content .ql-editor{min-height:100%;padding:30px 40px;font-size:1rem;line-height:1.9;font-family:'DM Sans',sans-serif;color:var(--gray-700)}
.editor-content .ql-editor h1,.editor-content .ql-editor h2,.editor-content .ql-editor h3{font-family:'Playfair Display',serif;color:var(--navy);margin:16px 0 10px}
.editor-content .ql-editor h1{font-size:2rem}.editor-content .ql-editor h2{font-size:1.5rem}.editor-content .ql-editor h3{font-size:1.2rem}
.editor-content .ql-editor p{margin-bottom:14px}
.editor-content .ql-editor img{max-width:100%;border-radius:8px}

/* Preview Tab */
.preview-content{flex:1;overflow-y:auto;padding:30px 40px;display:none}
.preview-content.active{display:block}
.preview-content h1,.preview-content h2,.preview-content h3{font-family:'Playfair Display',serif;color:var(--navy);margin:16px 0 10px}
.preview-content h1{font-size:2rem}.preview-content h2{font-size:1.5rem}.preview-content h3{font-size:1.2rem}
.preview-content p{margin-bottom:14px;line-height:1.9;color:var(--gray-600)}
.preview-content ul,.preview-content ol{padding-left:24px;margin-bottom:14px}
.preview-content li{margin-bottom:6px;line-height:1.7}
.preview-content img{max-width:100%;border-radius:8px;margin:12px 0}
.preview-content a{color:var(--teal)}
.preview-content blockquote{border-left:4px solid var(--teal);padding:12px 20px;margin:16px 0;background:var(--gray-50);border-radius:0 8px 8px 0}

/* Typing indicator */
.typing{display:flex;gap:4px;padding:8px 14px}
.typing span{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.3);animation:blink 1.4s infinite}
.typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}

/* Responsive */
@media(max-width:900px){.editor-layout{grid-template-columns:1fr}.chat-panel{max-height:40vh}}
</style></head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <a href="#" class="topbar__logo" onclick="return false"><div class="topbar__logo-icon">G</div></a>
    <a href="#" id="backLink" class="topbar__back">‚Üê Back to Editor</a>
    <div class="topbar__title" id="postTitle">Loading...</div>
    <span class="topbar__status topbar__status--draft" id="statusBadge">Draft</span>
    <span class="topbar__saved" id="savedIndicator">‚úì Saved</span>
    <div class="topbar__actions">
        <button class="topbar__btn topbar__btn--save" onclick="savePost('draft')">üíæ Save Draft</button>
        <button class="topbar__btn topbar__btn--publish" onclick="savePost('published')">üöÄ Publish</button>
    </div>
</div>

<!-- MAIN LAYOUT -->
<div class="editor-layout">

<!-- LEFT: CLAUDE CHAT -->
<div class="chat-panel">
    <div class="chat-header">
        <div class="chat-header__title"><span>ü§ñ</span> AI Writer</div>
        <div class="chat-header__sub">Ask AI to write, edit, improve, or restructure your content</div>
    </div>

    <div class="chat-messages" id="chatMessages">
        <div class="msg msg--system">‚ú® AI Visual Editor Ready</div>
        <div class="msg msg--ai">Hi! I'm your AI writing assistant. I can see your current post content. Tell me what you'd like to do ‚Äî write new sections, improve existing content, fix grammar, optimize for SEO, or anything else.</div>
    </div>

    <div class="chat-quick">
        <button class="quick-btn" onclick="sendChat('Write a comprehensive blog post about the title topic')">‚ú® Write full post</button>
        <button class="quick-btn" onclick="sendChat('Improve the SEO of the current content')">üìà Improve SEO</button>
        <button class="quick-btn" onclick="sendChat('Make it more engaging with better subheadings and formatting')">üéØ Make engaging</button>
        <button class="quick-btn" onclick="sendChat('Fix grammar and improve readability')">‚úèÔ∏è Fix grammar</button>
        <button class="quick-btn" onclick="sendChat('Add a compelling introduction paragraph')">üìù Add intro</button>
        <button class="quick-btn" onclick="sendChat('Add a conclusion with call-to-action')">üé¨ Add conclusion</button>
        <button class="quick-btn" onclick="sendChat('Generate meta title and description for SEO')">üè∑Ô∏è Meta tags</button>
        <button class="quick-btn" onclick="sendChat('Shorten and make more concise')">‚úÇÔ∏è Make concise</button>
    </div>

    <div class="chat-input">
        <textarea id="chatInput" rows="2" placeholder="Ask AI to write, edit, improve..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
        <button onclick="sendChat()" id="sendBtn">Send ‚ú®</button>
    </div>
</div>

<!-- RIGHT: EDITOR + PREVIEW -->
<div class="editor-panel">
    <div class="editor-tabs">
        <div class="editor-tab active" id="tabEditor" onclick="switchTab('editor')">‚úèÔ∏è Editor</div>
        <div class="editor-tab" id="tabPreview" onclick="switchTab('preview')">üëÅÔ∏è Preview</div>
        <div class="editor-tabs__info"><span id="wordCount">0 words</span></div>
    </div>

    <div class="editor-content" id="editorWrap">
        <div id="editor"></div>
    </div>

    <div class="preview-content" id="previewWrap"></div>
</div>

</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
// ===== INIT =====
const postId = window.location.pathname.split('/claude/')[1];
document.getElementById('backLink').href = '/blog/edit/' + postId;

// ===== QUILL =====
const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Start writing or ask AI to generate content...',
    modules: { toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['blockquote', 'code-block'],
        ['link', 'image'],
        [{ 'align': [] }],
        ['clean']
    ]}
});

quill.on('text-change', () => {
    const text = quill.getText().trim();
    document.getElementById('wordCount').textContent = (text ? text.split(/\s+/).length : 0) + ' words';
});

// ===== TABS =====
function switchTab(tab) {
    if (tab === 'preview') {
        document.getElementById('editorWrap').style.display = 'none';
        document.getElementById('previewWrap').classList.add('active');
        document.getElementById('previewWrap').innerHTML = quill.root.innerHTML;
        document.getElementById('tabEditor').classList.remove('active');
        document.getElementById('tabPreview').classList.add('active');
    } else {
        document.getElementById('editorWrap').style.display = 'flex';
        document.getElementById('previewWrap').classList.remove('active');
        document.getElementById('tabEditor').classList.add('active');
        document.getElementById('tabPreview').classList.remove('active');
    }
}

// ===== LOAD POST =====
let postData = {};
async function loadPost() {
    try {
        const r = await fetch('/api/blog/' + postId);
        postData = await r.json();
        document.getElementById('postTitle').textContent = postData.title || 'Untitled';
        document.title = 'AI Editor: ' + (postData.title || 'Untitled');
        quill.root.innerHTML = postData.content || '';
        const badge = document.getElementById('statusBadge');
        badge.textContent = postData.status || 'draft';
        badge.className = 'topbar__status topbar__status--' + (postData.status || 'draft');
        // Update word count
        const text = quill.getText().trim();
        document.getElementById('wordCount').textContent = (text ? text.split(/\s+/).length : 0) + ' words';
    } catch(e) { console.error('Load failed:', e); }
}
loadPost();

// ===== SAVE =====
async function savePost(status) {
    const data = {
        ...postData,
        content: quill.root.innerHTML,
        status: status || postData.status || 'draft'
    };
    if (status === 'published') data.status = 'published';
    try {
        const r = await fetch('/api/blog/' + postId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (r.ok) {
            postData = await r.json();
            const badge = document.getElementById('statusBadge');
            badge.textContent = postData.status;
            badge.className = 'topbar__status topbar__status--' + postData.status;
            const saved = document.getElementById('savedIndicator');
            saved.style.display = 'inline';
            setTimeout(() => saved.style.display = 'none', 3000);
        } else {
            const e = await r.json();
            alert('Error: ' + (e.error || 'Save failed'));
        }
    } catch(e) { alert('Save failed'); }
}

// ===== CLAUDE CHAT =====
let isGenerating = false;
async function sendChat(customMsg) {
    const input = document.getElementById('chatInput');
    const msg = customMsg || input.value.trim();
    if (!msg || isGenerating) return;
    input.value = '';
    isGenerating = true;
    document.getElementById('sendBtn').disabled = true;

    const messages = document.getElementById('chatMessages');

    // User message
    const userDiv = document.createElement('div');
    userDiv.className = 'msg msg--user';
    userDiv.textContent = msg;
    messages.appendChild(userDiv);

    // Loading indicator
    const loadDiv = document.createElement('div');
    loadDiv.className = 'msg msg--ai';
    loadDiv.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
    messages.appendChild(loadDiv);
    messages.scrollTop = messages.scrollHeight;

    try {
        const currentContent = quill.root.innerHTML;
        const title = postData.title || '';
        const fullPrompt = `Context - Blog title: "${title}"\nCurrent content (first 800 chars): ${currentContent.substring(0, 800)}\n\nRequest: ${msg}\n\nRespond with HTML content only (use h2, h3, p, ul, li, strong, em tags). No markdown. No code fences.`;

        const r = await fetch('/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: fullPrompt, type: 'blog', context: title })
        });
        const data = await r.json();

        if (r.ok) {
            const content = data.content;
            const preview = content.replace(/<[^>]*>/g, '').substring(0, 200);
            loadDiv.innerHTML = preview + (content.length > 200 ? '...' : '') +
                `<div class="msg__actions">
                    <button class="msg__btn msg__btn--insert" onclick="insertContent(this)" data-content="${encodeURIComponent(content)}">üìã Replace editor</button>
                    <button class="msg__btn msg__btn--append" onclick="appendContent(this)" data-content="${encodeURIComponent(content)}">‚ûï Append</button>
                    <button class="msg__btn msg__btn--copy" onclick="copyContent(this)" data-content="${encodeURIComponent(content)}">üìÑ Copy HTML</button>
                </div>`;
        } else {
            loadDiv.innerHTML = '‚ùå Error: ' + (data.error || 'Generation failed');
        }
    } catch(e) {
        loadDiv.innerHTML = '‚ùå Connection failed. Please try again.';
    }

    isGenerating = false;
    document.getElementById('sendBtn').disabled = false;
    messages.scrollTop = messages.scrollHeight;
}

function insertContent(btn) {
    const content = decodeURIComponent(btn.dataset.content);
    quill.root.innerHTML = content;
    showNotification('Content inserted into editor');
}

function appendContent(btn) {
    const content = decodeURIComponent(btn.dataset.content);
    quill.root.innerHTML += content;
    showNotification('Content appended to editor');
}

function copyContent(btn) {
    const content = decodeURIComponent(btn.dataset.content);
    navigator.clipboard.writeText(content).then(() => showNotification('HTML copied to clipboard'));
}

function showNotification(text) {
    const msg = document.createElement('div');
    msg.className = 'msg msg--system';
    msg.textContent = '‚úì ' + text;
    document.getElementById('chatMessages').appendChild(msg);
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
}

// Auto-resize textarea
document.getElementById('chatInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Auth check
(async()=>{try{const r=await fetch('/api/auth/me');if(!r.ok)return window.location.href='/login'}catch(e){window.location.href='/login'}})();
</script></body></html>
