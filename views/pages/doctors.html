<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Doctors | Ginger Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/admin.css">
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
:root{--navy:#0B2545;--teal:#0EA5A0;--ginger:#F26522;--gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;--gray-400:#9CA3AF;--gray-500:#6B7280;--gray-600:#4B5563}
.status-tabs{display:flex;gap:4px;margin-bottom:16px;font-size:.85rem}.status-tab{padding:4px 0;color:var(--gray-500);cursor:pointer;border:none;background:none;font-family:inherit;font-size:.85rem;transition:color .2s}.status-tab:hover{color:var(--navy)}.status-tab.active{color:var(--navy);font-weight:700}.status-tab .count{color:var(--gray-400);font-weight:400}.status-tab.active .count{color:var(--teal)}.tab-sep{color:var(--gray-300);padding:0 6px;user-select:none}
.toolbar{display:flex;gap:10px;margin-bottom:14px;align-items:center;flex-wrap:wrap}.bulk-bar{display:flex;gap:8px;align-items:center}.bulk-bar select,.filter-group select{padding:5px 10px;border:1px solid var(--gray-300);border-radius:5px;font-size:.82rem;font-family:inherit;background:#fff}.bulk-bar .btn-apply{padding:5px 14px;border:1px solid var(--gray-300);border-radius:5px;font-size:.82rem;cursor:pointer;background:var(--gray-50);font-family:inherit;font-weight:600;color:var(--gray-600);transition:all .2s}.bulk-bar .btn-apply:hover{background:var(--teal);color:#fff;border-color:var(--teal)}
.search-wrap{flex:1;max-width:260px;position:relative}.search-wrap input{width:100%;padding:6px 10px 6px 30px;border:1px solid var(--gray-300);border-radius:5px;font-size:.82rem;font-family:inherit}.search-wrap input:focus{outline:none;border-color:var(--teal)}.search-wrap::before{content:'üîç';position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:.75rem}
.pagination-info{margin-left:auto;font-size:.82rem;color:var(--gray-500);display:flex;align-items:center;gap:8px}.pagination-info select{padding:3px 6px;border:1px solid var(--gray-200);border-radius:4px;font-size:.78rem;font-family:inherit}.pag-btn{padding:3px 8px;border:1px solid var(--gray-200);border-radius:4px;cursor:pointer;background:#fff;font-size:.78rem;font-family:inherit;color:var(--gray-500)}.pag-btn:hover:not(:disabled){background:var(--teal);color:#fff;border-color:var(--teal)}.pag-btn:disabled{opacity:.4;cursor:not-allowed}
.selected-bar{background:rgba(14,165,160,.06);border:1px solid rgba(14,165,160,.2);border-radius:6px;padding:8px 14px;margin-bottom:10px;display:none;align-items:center;gap:12px;font-size:.82rem;color:var(--teal);font-weight:600}.selected-bar .btn-clear{background:none;border:none;color:var(--gray-400);cursor:pointer;font-size:.78rem;font-family:inherit;text-decoration:underline}
.data-table{width:100%;border-collapse:collapse}.data-table th{font-size:.72rem;text-transform:uppercase;letter-spacing:.5px;color:var(--gray-500);font-weight:700;padding:8px 10px;border-bottom:2px solid var(--gray-200);text-align:left;white-space:nowrap;cursor:pointer;user-select:none}.data-table th:hover{color:var(--navy)}.data-table th .sort-icon{font-size:.6rem;margin-left:3px;opacity:.4}.data-table td{padding:8px 10px;border-bottom:1px solid var(--gray-100);font-size:.85rem;vertical-align:middle}.data-table tr:hover td{background:var(--gray-50)}.data-table tr.selected td{background:rgba(14,165,160,.04)}
.cb-cell{width:36px;text-align:center}.cb-cell input{width:15px;height:15px;cursor:pointer;accent-color:var(--teal)}
.item-title-cell{min-width:200px}.item-title-cell strong{display:block;color:var(--navy);font-size:.88rem;line-height:1.3}.item-title-cell strong a{color:inherit;text-decoration:none}.item-title-cell strong a:hover{color:var(--teal)}.item-title-cell .item-slug{font-size:.7rem;color:var(--gray-400);font-family:'DM Sans',monospace;margin-top:1px}.item-title-cell .item-sub{font-size:.75rem;color:var(--gray-400)}
.row-actions{display:flex;gap:4px;margin-top:4px;opacity:0;transition:opacity .15s}tr:hover .row-actions{opacity:1}.row-actions a,.row-actions button{font-size:.72rem;padding:2px 7px;border-radius:3px;cursor:pointer;font-family:inherit;text-decoration:none;border:none;background:none;color:var(--gray-500)}.row-actions a:hover,.row-actions button:hover{color:var(--teal)}.row-actions .act-del{color:#EF4444}.row-actions .act-del:hover{color:#DC2626;text-decoration:underline}.row-actions .sep{color:var(--gray-300)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.72rem;font-weight:600}.badge--published{background:#D1FAE5;color:#059669}.badge--draft{background:#FEF3C7;color:#D97706}
.spec-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.72rem;font-weight:600;background:#EDE9FE;color:#7C3AED}
.date-cell{font-size:.78rem;color:var(--gray-500);white-space:nowrap}.empty-state{text-align:center;padding:40px;color:var(--gray-400);font-size:.92rem}
.btn-new{display:inline-flex;align-items:center;gap:5px;padding:7px 16px;background:var(--teal);color:#fff;border:none;border-radius:6px;font-size:.85rem;font-weight:700;cursor:pointer;font-family:inherit;transition:background .2s}.btn-new:hover{background:#0c918c}
.quick-edit-row td{background:#F0F5FF!important;border-top:2px solid var(--teal)!important;border-bottom:2px solid var(--teal)!important}.quick-edit{padding:16px 20px}.quick-edit__title{font-size:.78rem;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--teal)}.quick-edit__grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}.quick-edit .form-group{margin-bottom:0}.quick-edit .form-label{font-size:.75rem;font-weight:700;margin-bottom:3px;color:var(--navy);display:block}.quick-edit .form-input,.quick-edit .form-select{font-size:.82rem;padding:6px 10px;background:#fff;border:1.5px solid var(--gray-300);border-radius:5px;width:100%;font-family:inherit;box-sizing:border-box}.quick-edit .form-input:focus,.quick-edit .form-select:focus{border-color:var(--teal);outline:none}.quick-edit__actions{display:flex;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid rgba(14,165,160,.2)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px}.modal-overlay.open{display:flex}.modal{background:#fff;border-radius:12px;width:100%;max-width:740px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}.modal__header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid var(--gray-200)}.modal__header h3{font-family:'Playfair Display',serif;color:var(--navy);font-size:1.1rem;margin:0}.modal__close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--gray-400);padding:4px 8px;border-radius:6px}.modal__close:hover{background:var(--gray-100);color:var(--navy)}.modal__body{padding:20px 24px}.modal__footer{display:flex;gap:8px;justify-content:flex-end;padding:16px 24px;border-top:1px solid var(--gray-200)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:14px}.form-group{margin-bottom:14px}.form-label{font-size:.78rem;font-weight:700;color:var(--navy);margin-bottom:4px;display:block}.form-input,.form-select,.form-textarea{width:100%;padding:8px 12px;border:1.5px solid var(--gray-200);border-radius:6px;font-family:inherit;font-size:.85rem;box-sizing:border-box}.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--teal);outline:none}.form-textarea{resize:vertical;min-height:60px}
.ql-editor{min-height:120px;font-size:.88rem;line-height:1.7;font-family:"DM Sans",sans-serif}.ql-toolbar{border-color:var(--gray-200)!important;background:var(--gray-50);border-radius:8px 8px 0 0}.ql-container{border-color:var(--gray-200)!important;border-radius:0 0 8px 8px}
.tx-wrap{position:relative}.tx-chips{display:flex;flex-wrap:wrap;gap:6px;padding:8px 10px;border:1.5px solid var(--gray-200);border-radius:6px;min-height:38px;cursor:text;background:#fff;align-items:center}.tx-chips:focus-within{border-color:var(--teal)}.tx-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(14,165,160,.1);color:var(--teal);border-radius:4px;font-size:.78rem;font-weight:600;white-space:nowrap}.tx-chip button{background:none;border:none;color:var(--gray-400);cursor:pointer;font-size:.85rem;padding:0 2px;line-height:1}.tx-chip button:hover{color:#EF4444}.tx-input{border:none;outline:none;font-size:.82rem;font-family:inherit;min-width:120px;flex:1;padding:2px 0}.tx-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--gray-200);border-top:none;border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,.1)}.tx-dropdown.open{display:block}.tx-option{padding:7px 12px;font-size:.82rem;cursor:pointer;display:flex;align-items:center;gap:8px}.tx-option:hover{background:rgba(14,165,160,.06)}.tx-option.selected{background:rgba(14,165,160,.1);color:var(--teal);font-weight:600}.tx-option .tx-spec{font-size:.7rem;color:var(--gray-400);margin-left:auto}.tx-hint{font-size:.7rem;color:var(--gray-400);margin-top:3px}
</style>
<script src="/js/sidebar.js" defer></script>
</head>
<body><div class="layout"><aside class="sidebar" id="sidebar"></aside>
<main class="main"><header class="topbar"><button class="topbar__menu" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button><h1 class="topbar__title" id="pageTitle">Doctors</h1><div class="topbar__actions"><a href="/doctors/new" class="btn-new">+ Add Doctor</a></div></header>
<div class="content">
    <div class="status-tabs">
        <button class="status-tab active" onclick="setTab('')" data-status="">All <span class="count" id="cAll"></span></button><span class="tab-sep">|</span>
        <button class="status-tab" onclick="setTab('published')" data-status="published">Published <span class="count" id="cPub"></span></button><span class="tab-sep">|</span>
        <button class="status-tab" onclick="setTab('draft')" data-status="draft">Drafts <span class="count" id="cDra"></span></button>
    </div>
    <div class="selected-bar" id="selectedBar"><span id="selectedCount">0 selected</span><button class="btn-clear" onclick="clearSel()">Clear</button></div>
    <div class="toolbar">
        <div class="bulk-bar"><select id="bulkAction"><option value="">Bulk Actions</option><option value="publish">Set Published</option><option value="draft">Set Draft</option><option value="delete">Move to Trash</option></select><button class="btn-apply" onclick="applyBulk()">Apply</button></div>
        <div class="filter-group"><select id="countryFilter" onchange="doFilter()"><option value="">All Countries</option></select></div>
        <div class="search-wrap"><input type="text" placeholder="Search doctors..." id="searchInput" oninput="doFilter()"></div>
        <div class="pagination-info"><span id="pageInfo"></span><button class="pag-btn" id="prevBtn" onclick="changePage(-1)" disabled>‚Äπ</button><button class="pag-btn" id="nextBtn" onclick="changePage(1)" disabled>‚Ä∫</button><select id="perPage" onchange="perPage=+this.value;curPage=1;doFilter()"><option value="20">20</option><option value="50">50</option><option value="100">100</option></select></div>
    </div>
    <div class="card"><div class="card__body" style="padding:0;overflow-x:auto">
        <table class="data-table"><thead><tr>
            <th class="cb-cell"><input type="checkbox" id="selAll" onchange="toggleAll(this.checked)"></th>
            <th onclick="sortBy('name')">Doctor <span class="sort-icon">‚Üï</span></th>
            <th onclick="sortBy('specialty')">Specialty <span class="sort-icon">‚Üï</span></th>
            <th onclick="sortBy('country')">Country <span class="sort-icon">‚Üï</span></th>
            <th onclick="sortBy('exp')">Experience <span class="sort-icon">‚Üï</span></th>
            <th>Featured</th>
            <th onclick="sortBy('status')">Status <span class="sort-icon">‚Üï</span></th>
            <th onclick="sortBy('date')">Date <span class="sort-icon">‚Üï</span></th>
        </tr></thead><tbody id="list"><tr><td colspan="8" class="empty-state">Loading...</td></tr></tbody></table>
    </div></div>
</div></main></div>

<div class="modal-overlay" id="modal"><div class="modal">
    <div class="modal__header"><h3 id="modalTitle">Add Doctor</h3><button class="modal__close" onclick="closeModal()">‚úï</button></div>
    <div class="modal__body">
        <div class="form-row"><div class="form-group"><label class="form-label">Doctor Name *</label><input class="form-input" id="f_name" oninput="if(!editId)document.getElementById('f_slug').value=this.value.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'')"></div><div class="form-group"><label class="form-label">Slug *</label><input class="form-input" id="f_slug"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Title / Degrees</label><input class="form-input" id="f_title" placeholder="MBBS, MD, FRCS"></div><div class="form-group"><label class="form-label">Specialties</label><div class="tx-wrap"><div class="tx-chips" id="spChips" onclick="document.getElementById('spInput').focus()"><input class="tx-input" id="spInput" placeholder="Type to search specialties..." autocomplete="off" oninput="filterSpecialties()" onfocus="showSpDropdown()" /></div><div class="tx-dropdown" id="spDropdown"></div></div><div class="tx-hint">First selected = primary specialty shown on cards.</div></div></div>
        <input type="hidden" id="f_specialty">
        <div class="form-row"><div class="form-group"><label class="form-label">Hospital</label><select class="form-select" id="f_hospital_id"><option value="">Select hospital...</option></select></div><div class="form-group"><label class="form-label">Country / Destination</label><select class="form-select" id="f_destination_id"><option value="">Select destination...</option></select></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Experience (years)</label><input type="number" class="form-input" id="f_exp"></div><div class="form-group"><label class="form-label">Image URL</label><input class="form-input" id="f_image"></div></div>
        <div class="form-group"><label class="form-label">Short Description</label><textarea class="form-textarea" id="f_desc"></textarea></div>
        <div class="form-group"><label class="form-label">Detailed Description</label><div id="quillEditor"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Qualifications</label><input class="form-input" id="f_qualifications" placeholder="MBBS, MD (comma-separated)"></div><div class="form-group"><label class="form-label">Languages</label><input class="form-input" id="f_languages" placeholder="English, Hindi (comma-separated)"></div></div>
        <div class="form-group"><label class="form-label">Treatments Performed</label><div class="tx-wrap"><div class="tx-chips" id="txChips" onclick="document.getElementById('txInput').focus()"><input class="tx-input" id="txInput" placeholder="Type to search treatments..." autocomplete="off" oninput="filterTreatments()" onfocus="showTxDropdown()" /></div><div class="tx-dropdown" id="txDropdown"></div></div><div class="tx-hint">Select treatments this doctor performs. Filtered by specialty when set. Used to show doctors on treatment pages.</div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Is Featured</label><select class="form-select" id="f_featured"><option value="false">No</option><option value="true">Yes</option></select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f_status"><option value="draft">Draft</option><option value="published">Published</option></select></div></div>
    </div>
    <div class="modal__footer"><button class="btn btn--outline" onclick="closeModal()">Cancel</button><button class="btn btn--primary" onclick="saveItem()">Save Doctor</button></div>
</div></div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
let items=[],hospitals=[],allTreatments=[],allSpecialties=[],allDestinations=[],selectedTreatments=[],selectedSpecs=[],sel=new Set(),curPage=1,perPage=20,sortField='date',sortDir='desc',activeTab='',editId=null,quill=null;
const API='/api/doctors';
async function safeFetch(u,o){for(let i=0;i<3;i++){try{const r=await fetch(u,o);if(r.status===429){await new Promise(ok=>setTimeout(ok,1000*(i+1)));continue;}return r;}catch(e){if(i===2)throw e;await new Promise(ok=>setTimeout(ok,1000));}}};
async function loadHospitals(){try{const r=await safeFetch('/api/hospitals');if(r&&r.ok){hospitals=await r.json();const s=document.getElementById('f_hospital_id');s.innerHTML='<option value="">Select hospital...</option>';hospitals.forEach(h=>{s.innerHTML+='<option value="'+h.id+'">'+(h.destination_name?h.destination_name+' ‚Äî ':'')+h.name+'</option>';});}}catch(e){}}
async function loadDestinations(){try{const r=await safeFetch('/api/destinations');if(r&&r.ok){allDestinations=await r.json();const s=document.getElementById('f_destination_id');s.innerHTML='<option value="">Auto (from hospital) or select...</option>';allDestinations.forEach(d=>{s.innerHTML+='<option value="'+d.id+'">'+d.flag+' '+d.name+'</option>';});}}catch(e){}}
function getDestSlug(doc){if(doc.destination_slug)return doc.destination_slug;const d=allDestinations.find(x=>x.id===doc.destination_id);if(d)return d.slug;if(doc.country){const dc=allDestinations.find(x=>x.name.toLowerCase()===doc.country.toLowerCase());if(dc)return dc.slug;}return 'india';}
function getDestName(id){const d=allDestinations.find(x=>x.id===id);return d?d.name:'';}
async function loadTreatments(){try{const r=await safeFetch('/api/treatments');if(r&&r.ok){allTreatments=await r.json();}}catch(e){}}
async function loadSpecialties(){try{const r=await safeFetch('/api/specialties');if(r&&r.ok){allSpecialties=await r.json();}}catch(e){}}

// ===== SPECIALTY CHIP PICKER =====
function getFilteredSpecs(){
    const query=document.getElementById('spInput').value.toLowerCase();
    return allSpecialties.filter(s=>{
        if(selectedSpecs.includes(s.name))return false;
        return !query||s.name.toLowerCase().includes(query);
    });
}
function filterSpecialties(){renderSpDropdown();document.getElementById('spDropdown').classList.add('open');}
function showSpDropdown(){renderSpDropdown();document.getElementById('spDropdown').classList.add('open');}
function renderSpDropdown(){
    const filtered=getFilteredSpecs();
    const dd=document.getElementById('spDropdown');
    if(!filtered.length){dd.innerHTML='<div class="tx-option" style="color:var(--gray-400);cursor:default">No specialties found</div>';return;}
    dd.innerHTML=filtered.slice(0,20).map(s=>`<div class="tx-option" onmousedown="addSpec('${s.name.replace(/'/g,"\\'")}')"><span>‚úö ${esc(s.name)}</span><span class="tx-spec">${esc(s.category||'')}</span></div>`).join('');
}
function addSpec(name){
    if(!selectedSpecs.includes(name)){selectedSpecs.push(name);renderSpChips();syncPrimarySpec();}
    document.getElementById('spInput').value='';renderSpDropdown();
}
function removeSpec(name){
    selectedSpecs=selectedSpecs.filter(s=>s!==name);renderSpChips();syncPrimarySpec();renderSpDropdown();
}
function renderSpChips(){
    const container=document.getElementById('spChips');
    const input=document.getElementById('spInput');
    container.querySelectorAll('.tx-chip').forEach(c=>c.remove());
    selectedSpecs.forEach((name,i)=>{
        const chip=document.createElement('span');chip.className='tx-chip';
        if(i===0)chip.style.background='rgba(242,101,34,.15)';if(i===0)chip.style.color='#F26522';
        chip.innerHTML=(i===0?'‚òÖ ':'')+esc(name)+'<button type="button" onclick="removeSpec(\''+name.replace(/'/g,"\\'")+'\')">‚úï</button>';
        container.insertBefore(chip,input);
    });
}
function syncPrimarySpec(){
    document.getElementById('f_specialty').value=selectedSpecs.length?selectedSpecs[0]:'';
    // Re-filter treatments dropdown when specialty changes
    if(document.getElementById('txDropdown').classList.contains('open'))filterTreatments();
}

// ===== TREATMENT CHIP PICKER =====
function getFilteredTreatments(){
    const query=document.getElementById('txInput').value.toLowerCase();
    const specs=selectedSpecs.map(s=>s.toLowerCase());
    return allTreatments.filter(t=>{
        if(selectedTreatments.includes(t.name))return false;
        const matchQuery=!query||t.name.toLowerCase().includes(query);
        const matchSpec=!specs.length||(t.specialty_name&&specs.includes(t.specialty_name.toLowerCase()));
        return matchQuery&&matchSpec;
    });
}
function filterTreatments(){renderTxDropdown();document.getElementById('txDropdown').classList.add('open');}
function showTxDropdown(){renderTxDropdown();document.getElementById('txDropdown').classList.add('open');}
function hideTxDropdown(){setTimeout(()=>{document.getElementById('txDropdown').classList.remove('open');},150);}
function renderTxDropdown(){
    const filtered=getFilteredTreatments();
    const dd=document.getElementById('txDropdown');
    if(!filtered.length){dd.innerHTML='<div class="tx-option" style="color:var(--gray-400);cursor:default">No treatments found</div>';return;}
    dd.innerHTML=filtered.slice(0,20).map(t=>`<div class="tx-option" onmousedown="addTreatment('${t.name.replace(/'/g,"\\'")}')"><span>‚úö ${esc(t.name)}</span><span class="tx-spec">${esc(t.specialty_name||'')}</span></div>`).join('');
}
function addTreatment(name){
    if(!selectedTreatments.includes(name)){selectedTreatments.push(name);renderTxChips();}
    document.getElementById('txInput').value='';renderTxDropdown();
}
function removeTreatment(name){
    selectedTreatments=selectedTreatments.filter(t=>t!==name);renderTxChips();renderTxDropdown();
}
function renderTxChips(){
    const container=document.getElementById('txChips');
    const input=document.getElementById('txInput');
    const chips=container.querySelectorAll('.tx-chip');
    chips.forEach(c=>c.remove());
    selectedTreatments.forEach(name=>{
        const chip=document.createElement('span');chip.className='tx-chip';
        chip.innerHTML=esc(name)+'<button type="button" onclick="removeTreatment(\''+name.replace(/'/g,"\\'")+'\')">‚úï</button>';
        container.insertBefore(chip,input);
    });
}
document.addEventListener('click',e=>{if(!e.target.closest('.tx-wrap')){document.getElementById('txDropdown').classList.remove('open');document.getElementById('spDropdown').classList.remove('open');}});
async function load(){try{const r=await safeFetch(API);if(!r||!r.ok)return;items=await r.json();
const countries=[...new Set(items.map(i=>i.country).filter(Boolean))].sort();
document.getElementById('countryFilter').innerHTML='<option value="">All Countries</option>'+countries.map(c=>'<option>'+c+'</option>').join('');
updateCounts();doFilter();}catch(e){document.getElementById('list').innerHTML='<tr><td colspan="8" class="empty-state">Error loading.</td></tr>';}}
function updateCounts(){const pub=items.filter(i=>i.status==='published').length,dra=items.filter(i=>i.status==='draft').length;document.getElementById('cAll').textContent='('+items.length+')';document.getElementById('cPub').textContent='('+pub+')';document.getElementById('cDra').textContent='('+dra+')';document.getElementById('pageTitle').textContent='Doctors ('+items.length+')';}
function setTab(s){activeTab=s;curPage=1;document.querySelectorAll('.status-tab').forEach(t=>t.classList.toggle('active',t.dataset.status===s));doFilter();}
function doFilter(){
    const q=document.getElementById('searchInput').value.toLowerCase(),co=document.getElementById('countryFilter').value;
    let f=items.filter(i=>(!activeTab||i.status===activeTab)&&(!q||i.name.toLowerCase().includes(q)||(i.specialty||'').toLowerCase().includes(q)||(i.title||'').toLowerCase().includes(q))&&(!co||i.country===co));
    f.sort((a,b)=>{let va,vb;if(sortField==='name'){va=a.name.toLowerCase();vb=b.name.toLowerCase();}else if(sortField==='specialty'){va=(a.specialty||'');vb=(b.specialty||'');}else if(sortField==='country'){va=(a.country||'');vb=(b.country||'');}else if(sortField==='exp'){va=+(a.experience_years||0);vb=+(b.experience_years||0);}else if(sortField==='status'){va=a.status;vb=b.status;}else{va=a.created_at||'';vb=b.created_at||'';}return sortDir==='asc'?(va<vb?-1:va>vb?1:0):(va>vb?-1:va<vb?1:0);});
    const total=f.length,tp=Math.max(1,Math.ceil(total/perPage));if(curPage>tp)curPage=tp;const start=(curPage-1)*perPage,page=f.slice(start,start+perPage);
    document.getElementById('pageInfo').textContent=total+' items ¬∑ page '+curPage+' of '+tp;document.getElementById('prevBtn').disabled=curPage<=1;document.getElementById('nextBtn').disabled=curPage>=tp;render(page);
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function render(list){
    const tb=document.getElementById('list');if(!list.length){tb.innerHTML='<tr><td colspan="8" class="empty-state">No doctors found</td></tr>';return;}
    tb.innerHTML=list.map(s=>{const ck=sel.has(s.id)?'checked':'',sc=sel.has(s.id)?' selected':'';const dt=new Date(s.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    const hospName=s.hospital_id?((hospitals.find(h=>h.id===s.hospital_id)||{}).name||''):'';
    return `<tr id="row-${s.id}" class="${sc}">
        <td class="cb-cell"><input type="checkbox" ${ck} onchange="toggleSel(${s.id},this.checked)"></td>
        <td class="item-title-cell">
            <strong><a href="#" onclick="editItem(${s.id});return false">${esc(s.name)}</a></strong>
            <span class="item-sub">${esc(s.title||'')}</span>
            <span class="item-slug">/destinations/${esc(getDestSlug(s))}/doctors/${esc(s.slug)}/</span>
            <div class="row-actions"><a href="/doctors/edit/${s.id}">Edit</a><span class="sep">|</span><button onclick="editItem(${s.id})">Quick Edit</button><span class="sep">|</span><a href="https://ginger.healthcare/destinations/${esc(getDestSlug(s))}/doctors/${esc(s.slug)}/" target="_blank">View</a><span class="sep">|</span><button class="act-del" onclick="deleteItem(${s.id})">Trash</button></div>
        </td>
        <td>${s.specialty?'<span class="spec-badge">'+esc(s.specialty)+'</span>':'‚Äî'}</td>
        <td>${esc(s.country||'‚Äî')}</td>
        <td>${s.experience_years?s.experience_years+' yrs':'‚Äî'}</td>
        <td style="text-align:center">${s.is_featured?'<span style="color:#F59E0B;font-size:.9rem">‚òÖ</span>':'‚Äî'}</td>
        <td><span class="badge badge--${s.status}">${s.status}</span></td>
        <td class="date-cell">${dt}</td>
    </tr>
    <tr class="quick-edit-row" id="qe-${s.id}" style="display:none"><td colspan="8" style="padding:0;border:none"><div class="quick-edit">
        <div class="quick-edit__title">QUICK EDIT ‚Äî ${esc(s.name)}</div>
        <div class="quick-edit__grid">
            <div><div class="form-group"><label class="form-label">Name</label><input class="form-input" id="qn-${s.id}" value="${esc(s.name)}"></div><div class="form-group" style="margin-top:10px"><label class="form-label">Slug</label><input class="form-input" id="qs-${s.id}" value="${esc(s.slug)}"></div></div>
            <div><div class="form-group"><label class="form-label">Specialty</label><input class="form-input" id="qp-${s.id}" value="${esc(s.specialty||'')}"></div><div class="form-group" style="margin-top:10px"><label class="form-label">Experience (yrs)</label><input class="form-input" type="number" id="qx-${s.id}" value="${s.experience_years||''}"></div></div>
            <div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="qt-${s.id}"><option value="draft" ${s.status==='draft'?'selected':''}>Draft</option><option value="published" ${s.status==='published'?'selected':''}>Published</option></select></div><div class="form-group" style="margin-top:10px"><label class="form-label">Featured</label><select class="form-select" id="qf-${s.id}"><option value="false" ${!s.is_featured?'selected':''}>No</option><option value="true" ${s.is_featured?'selected':''}>Yes</option></select></div></div>
        </div>
        <div class="quick-edit__actions"><button class="btn btn--primary btn--sm" onclick="quickSave(${s.id})" style="padding:6px 16px;font-size:.82rem">üíæ Update</button><button class="btn btn--outline btn--sm" onclick="toggleQE(${s.id})" style="padding:6px 16px;font-size:.82rem">Cancel</button></div>
    </div></td></tr>`;}).join('');document.getElementById('selAll').checked=false;
}
function toggleSel(id,c){if(c)sel.add(id);else sel.delete(id);updateSelUI();const r=document.getElementById('row-'+id);if(r)r.classList.toggle('selected',c);}
function toggleAll(c){document.querySelectorAll('#list input[type="checkbox"]').forEach(cb=>{cb.checked=c;const tr=cb.closest('tr');const id=+tr.id.replace('row-','');if(id){if(c)sel.add(id);else sel.delete(id);tr.classList.toggle('selected',c);}});updateSelUI();}
function updateSelUI(){const b=document.getElementById('selectedBar');if(sel.size){b.style.display='flex';document.getElementById('selectedCount').textContent=sel.size+' selected';}else b.style.display='none';}
function clearSel(){sel.clear();document.querySelectorAll('#list input[type="checkbox"]').forEach(cb=>{cb.checked=false;cb.closest('tr').classList.remove('selected');});document.getElementById('selAll').checked=false;updateSelUI();}
async function applyBulk(){const action=document.getElementById('bulkAction').value;if(!action)return alert('Select a bulk action');if(!sel.size)return alert('Select items first');if(!confirm(action+' '+sel.size+' item(s)?'))return;try{const r=await fetch(API+'/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids:[...sel],action})});const d=await r.json();if(r.ok){alert('‚úÖ '+d.count+' item(s) updated');sel.clear();document.getElementById('bulkAction').value='';load();}else alert(d.error||'Failed');}catch(e){alert(e.message);}}
function sortBy(f){if(sortField===f)sortDir=sortDir==='asc'?'desc':'asc';else{sortField=f;sortDir=f==='date'?'desc':'asc';}doFilter();}
function changePage(d){curPage+=d;doFilter();window.scrollTo({top:0,behavior:'smooth'});}
function toggleQE(id){const r=document.getElementById('qe-'+id);if(r)r.style.display=r.style.display==='none'?'':'none';}
async function quickSave(id){const data={name:document.getElementById('qn-'+id).value,slug:document.getElementById('qs-'+id).value,specialty:document.getElementById('qp-'+id).value,experience_years:+document.getElementById('qx-'+id).value||null,status:document.getElementById('qt-'+id).value,is_featured:document.getElementById('qf-'+id).value==='true'};try{const r=await fetch(API+'/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(r.ok)load();else alert('Save failed');}catch(e){alert('Save failed');}}
async function deleteItem(id){if(!confirm('Delete permanently?'))return;try{await fetch(API+'/'+id,{method:'DELETE'});sel.delete(id);load();}catch(e){alert('Failed');}}
function initQuill(){if(quill)return;quill=new Quill('#quillEditor',{theme:'snow',placeholder:'Detailed description...',modules:{toolbar:[['bold','italic','underline'],[{'header':[2,3,false]}],[{'list':'ordered'},{'list':'bullet'}],['link','image'],['clean']]}});}
function openModal(){editId=null;document.getElementById('modalTitle').textContent='Add Doctor';document.getElementById('modal').classList.add('open');['f_name','f_slug','f_title','f_specialty','f_image','f_desc','f_qualifications','f_languages'].forEach(f=>document.getElementById(f).value='');document.getElementById('f_exp').value='';document.getElementById('f_hospital_id').value='';document.getElementById('f_destination_id').value='';document.getElementById('f_status').value='draft';document.getElementById('f_featured').value='false';selectedSpecs=[];renderSpChips();document.getElementById('spInput').value='';selectedTreatments=[];renderTxChips();document.getElementById('txInput').value='';initQuill();quill.root.innerHTML='';}
function editItem(id){const s=items.find(i=>i.id===id);if(!s)return;editId=id;document.getElementById('modalTitle').textContent='Edit Doctor';document.getElementById('modal').classList.add('open');document.getElementById('f_name').value=s.name||'';document.getElementById('f_slug').value=s.slug||'';document.getElementById('f_title').value=s.title||'';document.getElementById('f_specialty').value=s.specialty||'';document.getElementById('f_hospital_id').value=s.hospital_id||'';document.getElementById('f_destination_id').value=s.destination_id||'';document.getElementById('f_exp').value=s.experience_years||'';document.getElementById('f_image').value=s.image||'';document.getElementById('f_desc').value=s.description||'';document.getElementById('f_qualifications').value=(s.qualifications||[]).join(', ');document.getElementById('f_languages').value=(s.languages||[]).join(', ');selectedSpecs=s.specialties&&s.specialties.length?[...s.specialties]:(s.specialty?[s.specialty]:[]);renderSpChips();document.getElementById('spInput').value='';selectedTreatments=[...(s.treatments||[])];renderTxChips();document.getElementById('txInput').value='';document.getElementById('f_featured').value=s.is_featured?'true':'false';document.getElementById('f_status').value=s.status||'draft';initQuill();quill.root.innerHTML=s.long_description||'';}
function closeModal(){document.getElementById('modal').classList.remove('open');}
async function saveItem(){
    const destId=+document.getElementById('f_destination_id').value||null;
    const specId=selectedSpecs.length?((allSpecialties.find(s=>s.name===selectedSpecs[0])||{}).id||null):null;
    const data={name:document.getElementById('f_name').value,slug:document.getElementById('f_slug').value,title:document.getElementById('f_title').value,specialty:selectedSpecs.length?selectedSpecs[0]:'',specialty_id:specId,specialties:selectedSpecs,hospital_id:+document.getElementById('f_hospital_id').value||null,destination_id:destId,country:destId?getDestName(destId):'',experience_years:+document.getElementById('f_exp').value||null,description:document.getElementById('f_desc').value,long_description:quill?quill.root.innerHTML:'',image:document.getElementById('f_image').value,qualifications:document.getElementById('f_qualifications').value?document.getElementById('f_qualifications').value.split(',').map(s=>s.trim()).filter(s=>s):[],languages:document.getElementById('f_languages').value?document.getElementById('f_languages').value.split(',').map(s=>s.trim()).filter(s=>s):[],treatments:selectedTreatments,is_featured:document.getElementById('f_featured').value==='true',status:document.getElementById('f_status').value};
    if(!data.name)return alert('Name is required');if(!data.slug)data.slug=data.name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
    try{const url=editId?API+'/'+editId:API;const r=await fetch(url,{method:editId?'PUT':'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(r.ok){closeModal();load();}else{const e=await r.json();alert(e.error||'Save failed');}}catch(e){alert('Save failed');}
}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){clearSel();closeModal();}});
loadHospitals().then(()=>loadSpecialties()).then(()=>loadTreatments()).then(()=>loadDestinations()).then(()=>load());
</script>
</body></html>
