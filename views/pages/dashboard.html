<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Ginger Healthcare Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
<script src="/js/sidebar.js" defer></script>
</head>
<body>
    <div class="layout">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- MAIN CONTENT -->
        <main class="main">
            <header class="topbar">
                <button class="topbar__menu" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
                <h1 class="topbar__title" id="pageTitle">Dashboard</h1>
                <div class="topbar__actions">
                    <a href="https://ginger.healthcare" target="_blank" class="topbar__view-site">ğŸŒ View Site</a>
                </div>
            </header>

            <div class="content" id="mainContent">
                <!-- DASHBOARD HOME -->
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card"><div class="stat-card__icon" style="background:rgba(242,101,34,.1);color:var(--ginger)">ğŸ“</div><div class="stat-card__info"><div class="stat-card__value" id="statPosts">-</div><div class="stat-card__label">Blog Posts</div></div></div>
                    <div class="stat-card"><div class="stat-card__icon" style="background:rgba(14,165,160,.1);color:var(--teal)">â­</div><div class="stat-card__info"><div class="stat-card__value" id="statTestimonials">-</div><div class="stat-card__label">Testimonials</div></div></div>
                    <div class="stat-card"><div class="stat-card__icon" style="background:rgba(59,130,246,.1);color:#3B82F6">ğŸ¥</div><div class="stat-card__info"><div class="stat-card__value" id="statHospitals">-</div><div class="stat-card__label">Hospitals</div></div></div>
                    <div class="stat-card"><div class="stat-card__icon" style="background:rgba(236,72,153,.1);color:#EC4899">ğŸ‘¨â€âš•ï¸</div><div class="stat-card__info"><div class="stat-card__value" id="statDoctors">-</div><div class="stat-card__label">Doctors</div></div></div>
                    <div class="stat-card"><div class="stat-card__icon" style="background:rgba(245,158,11,.1);color:#F59E0B">ğŸ“‹</div><div class="stat-card__info"><div class="stat-card__value" id="statSubmissions">-</div><div class="stat-card__label">Total Submissions</div></div></div>
                    <div class="stat-card stat-card--highlight"><div class="stat-card__icon" style="background:rgba(5,150,105,.1);color:#059669">ğŸ””</div><div class="stat-card__info"><div class="stat-card__value" id="statNewSubs">-</div><div class="stat-card__label">New Submissions</div></div></div>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card__header"><h3>Recent Activity</h3></div>
                        <div class="card__body" id="activityList"><div class="loading">Loading...</div></div>
                    </div>
                    <div class="card">
                        <div class="card__header"><h3>Quick Actions</h3></div>
                        <div class="card__body">
                            <div id="maintenanceToggle" style="background:var(--gray-50);border:2px solid var(--gray-200);border-radius:10px;padding:14px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between">
                                <div><strong style="color:var(--navy)">ğŸ”§ Maintenance Mode</strong><br><span style="font-size:.78rem;color:var(--gray-400)" id="maintenanceStatus">Loading...</span></div>
                                <button id="maintenanceBtn" class="btn btn--sm" onclick="toggleMaintenance()" style="min-width:80px">...</button>
                            </div>
                            <a href="/blog/new" class="quick-action"><span>ğŸ“</span> New Blog Post</a>
                            <a href="/testimonials" class="quick-action"><span>â­</span> Add Testimonial</a>
                            <a href="/hospitals" class="quick-action"><span>ğŸ¥</span> Add Hospital</a>
                            <a href="/doctors" class="quick-action"><span>ğŸ‘¨â€âš•ï¸</span> Add Doctor</a>
                            <a href="/ai-assistant" class="quick-action"><span>ğŸ¤–</span> Claude AI Assistant</a>
                            <a href="/submissions" class="quick-action"><span>ğŸ“‹</span> View Submissions</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    // Load dashboard stats
    async function loadStats() {
        try {
            const res = await fetch('/api/dashboard/stats');
            const stats = await res.json();
            document.getElementById('statPosts').textContent = stats.blog_posts;
            document.getElementById('statTestimonials').textContent = stats.testimonials;
            document.getElementById('statHospitals').textContent = stats.hospitals;
            document.getElementById('statDoctors').textContent = stats.doctors;
            document.getElementById('statSubmissions').textContent = stats.total_submissions;
            document.getElementById('statNewSubs').textContent = stats.new_submissions;

            // Update badge
            if (stats.new_submissions > 0) {
                const badge = document.getElementById('newSubsBadge');
                badge.textContent = stats.new_submissions;
                badge.style.display = 'inline-flex';
            }
        } catch(e) { console.error('Stats error:', e); }
    }

    // Load recent activity
    async function loadActivity() {
        try {
            const res = await fetch('/api/dashboard/activity');
            const data = await res.json();
            const activities = data.activities || data;
            const list = document.getElementById('activityList');
            if (!activities || activities.length === 0) {
                list.innerHTML = '<div class="empty-state">No activity yet. Start by creating content!</div>';
                return;
            }
            list.innerHTML = activities.slice(0, 10).map(a => `
                <div class="activity-item">
                    <div class="activity-item__dot"></div>
                    <div class="activity-item__content">
                        <strong>${a.user_name || 'System'}</strong> ${a.action} ${a.entity_type || ''}
                        <div class="activity-item__time">${timeAgo(a.created_at)}</div>
                    </div>
                </div>
            `).join('');
        } catch(e) { console.error('Activity error:', e); }
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds/60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds/3600) + 'h ago';
        return Math.floor(seconds/86400) + 'd ago';
    }

    // Load maintenance status
    async function loadMaintenance() {
        try {
            const res = await fetch('/api/maintenance/status');
            const data = await res.json();
            updateMaintenanceUI(data.maintenance);
        } catch(e) { console.error('Maintenance error:', e); }
    }

    function updateMaintenanceUI(isOn) {
        const btn = document.getElementById('maintenanceBtn');
        const status = document.getElementById('maintenanceStatus');
        const toggle = document.getElementById('maintenanceToggle');
        if (isOn) {
            btn.textContent = 'ğŸŸ¢ Go Live';
            btn.className = 'btn btn--sm btn--primary';
            status.textContent = 'Website is showing "Coming Soon" page';
            toggle.style.borderColor = '#F59E0B';
            toggle.style.background = '#FFFBEB';
        } else {
            btn.textContent = 'ğŸ”§ Enable';
            btn.className = 'btn btn--sm btn--outline';
            status.textContent = 'Website is live and visible to public';
            toggle.style.borderColor = '#D1FAE5';
            toggle.style.background = '#F0FDF4';
        }
    }

    async function toggleMaintenance() {
        const res = await fetch('/api/maintenance/status');
        const data = await res.json();
        const newState = !data.maintenance;
        const msg = newState ? 'Enable maintenance mode? Website will show "Coming Soon" page.' : 'Disable maintenance mode? Website will go LIVE.';
        if (!confirm(msg)) return;
        const r = await fetch('/api/maintenance/toggle', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({enabled: newState}) });
        if (r.ok) { updateMaintenanceUI(newState); }
    }

    // Init - wait for sidebar.js to finish auth, then stagger API calls
    async function init() {
        // Wait for sidebar.js auth (no duplicate /api/auth/me call)
        const user = await window.gingerUser;
        if (!user) return; // Not authenticated
        
        // Stagger API calls to avoid 429 rate limiting
        await loadStats();
        await loadActivity();
        await loadMaintenance();
    }
    init();
    </script>
</body>
</html>
