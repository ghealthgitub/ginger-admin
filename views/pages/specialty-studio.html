<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Specialty Studio | Ginger Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/admin.css">
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
.editor-grid{display:grid;grid-template-columns:1fr 380px;gap:20px;align-items:start}
.editor-main{display:flex;flex-direction:column;gap:16px}
.permalink{background:#F0F5FF;border:1.5px solid var(--teal);border-radius:8px;padding:10px 14px;font-size:.82rem;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.permalink__base{color:var(--gray-400)}.permalink__slug{color:var(--navy);font-weight:600;background:#fff;border:1px solid var(--gray-200);border-radius:4px;padding:2px 8px;font-family:monospace;font-size:.82rem;min-width:150px}
.permalink__slug:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(14,165,160,.1)}
.permalink a{color:var(--teal);font-weight:600;margin-left:auto}
.ql-editor{min-height:300px;font-size:.95rem;line-height:1.8;font-family:'DM Sans',sans-serif}
.ql-toolbar{border-radius:8px 8px 0 0;border-color:var(--gray-200)!important;background:#F0F5FF}
.ql-container{border-radius:0 0 8px 8px;border-color:var(--gray-200)!important}
.word-count{font-size:.78rem;color:var(--gray-400);text-align:right;margin-top:4px}
.panel{background:#fff;border:1px solid var(--gray-200);border-radius:10px;margin-bottom:16px;overflow:hidden}
.panel__head{padding:12px 16px;border-bottom:2px solid var(--teal);font-weight:700;font-size:.88rem;color:var(--navy);display:flex;justify-content:space-between;align-items:center;cursor:pointer;background:#F0F5FF}
.panel__head::after{content:'‚ñæ';font-size:.7rem;color:var(--gray-400)}
.panel__body{padding:14px 16px}
.panel.collapsed .panel__body{display:none}.panel.collapsed .panel__head::after{content:'‚ñ∏'}
.publish-actions{display:flex;gap:8px;margin-top:12px}
.status-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:.85rem;border-bottom:1px solid var(--gray-50)}.status-row:last-child{border:none}
.status-label{color:var(--gray-500)}.status-value{font-weight:600;color:var(--navy)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.field-label{font-size:.78rem;font-weight:700;color:var(--navy);margin-bottom:4px;display:block}
.field-input{width:100%;padding:8px 12px;border:1.5px solid var(--gray-200);border-radius:6px;font-size:.85rem;font-family:inherit}
.field-input:focus{outline:none;border-color:var(--teal)}
.field-select{width:100%;padding:8px 12px;border:1.5px solid var(--gray-200);border-radius:6px;font-size:.85rem;font-family:inherit;background:#fff}
/* Claude AI Panel */
.claude-panel{background:linear-gradient(135deg,#0B2545,#13315C);border-radius:10px;border:1px solid rgba(255,255,255,.1);overflow:hidden}
.claude-panel .panel__head{background:rgba(255,255,255,.05);color:#fff;border-color:rgba(255,255,255,.1)}
.claude-panel .panel__head::after{color:rgba(255,255,255,.4)}
.claude-panel .panel__body{padding:0;background:linear-gradient(135deg,#0B2545,#13315C)}
.claude-chat{display:flex;flex-direction:column;height:380px}
.claude-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.claude-msg{padding:10px 14px;border-radius:10px;font-size:.82rem;line-height:1.5;max-width:90%;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.claude-msg--user{background:rgba(242,101,34,.15);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.claude-msg--ai{background:rgba(255,255,255,.08);color:rgba(255,255,255,.85);align-self:flex-start;border-bottom-left-radius:4px}
.claude-msg--ai code{background:rgba(0,0,0,.2);padding:1px 4px;border-radius:3px;font-size:.78rem}
.claude-input{display:flex;gap:8px;padding:10px 12px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.15)}
.claude-input input{flex:1;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:10px 14px;color:#fff;font-size:.82rem;font-family:inherit}
.claude-input input::placeholder{color:rgba(255,255,255,.3)}
.claude-input input:focus{outline:none;border-color:var(--ginger)}
.claude-input button{background:var(--ginger);color:#fff;border:none;border-radius:8px;padding:10px 16px;font-weight:700;font-size:.82rem;cursor:pointer;white-space:nowrap}
.claude-input button:hover{background:#D9531E}.claude-input button:disabled{opacity:.5;cursor:not-allowed}
.claude-actions{display:flex;gap:6px;padding:8px 12px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.1);flex-wrap:wrap}
.claude-quick{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);border-radius:6px;padding:5px 10px;font-size:.72rem;cursor:pointer;font-family:inherit}
.claude-quick:hover{background:rgba(255,255,255,.12);color:#fff}
.preview-panel{background:#fff;border:1px solid var(--gray-200);border-radius:10px;overflow:hidden}
.preview-panel .panel__head{background:#F0F5FF}
.preview-frame{padding:20px;max-height:300px;overflow-y:auto;font-size:.9rem;line-height:1.7;font-family:'DM Sans',sans-serif}
.preview-frame h1,.preview-frame h2,.preview-frame h3{font-family:'Playfair Display',serif;color:var(--navy);margin:12px 0 8px}
.preview-frame h1{font-size:1.6rem}.preview-frame h2{font-size:1.3rem}.preview-frame h3{font-size:1.1rem}
.preview-frame p{margin-bottom:10px;color:var(--gray-600)}
.preview-frame ul,.preview-frame ol{padding-left:20px;margin-bottom:10px}
.preview-frame img{max-width:100%;border-radius:8px;margin:8px 0}
.preview-frame a{color:var(--teal)}
/* Media picker */
.mp-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;align-items:center;justify-content:center}.mp-bg.open{display:flex}
.mp-modal{background:#fff;border-radius:12px;width:720px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.mp-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--gray-200);font-weight:600;font-size:.95rem;color:var(--navy)}
.mp-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:16px;overflow-y:auto;max-height:50vh;min-height:200px}
.mp-item{border:2px solid var(--gray-200);border-radius:8px;overflow:hidden;cursor:pointer;aspect-ratio:1;transition:all .15s}.mp-item:hover{border-color:var(--teal)}.mp-item.selected{border-color:var(--ginger);box-shadow:0 0 0 2px rgba(242,101,34,.3)}
.mp-item img{width:100%;height:100%;object-fit:cover}
.mp-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 20px;border-top:1px solid var(--gray-200)}
.autosave-indicator{font-size:.72rem;color:var(--gray-400);padding:2px 8px}
.autosave-indicator.saving{color:var(--ginger)}.autosave-indicator.saved{color:#059669}
@media(max-width:1100px){.editor-grid{grid-template-columns:1fr}.claude-chat{height:300px}}
</style></head>
<body><div class="layout"><aside class="sidebar" id="sidebar"></aside>

<main class="main"><header class="topbar"><button class="topbar__menu" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button><h1 class="topbar__title" id="pageTitle">New Specialty</h1><div class="topbar__actions"><span class="autosave-indicator" id="autoSave"></span><a href="/specialties-mgmt" class="btn btn--outline" style="font-size:.82rem">‚Üê Back</a><button class="btn btn--outline" style="font-size:.82rem" onclick="saveSpec('draft')">üíæ Draft</button><button class="btn btn--primary" style="font-size:.82rem" onclick="saveSpec('published')">üöÄ Publish</button></div></header>
<div class="content">

<!-- PERMALINK -->
<div class="permalink">
    <span>üîó</span>
    <span class="permalink__base">ginger.healthcare/specialties/</span>
    <input type="text" class="permalink__slug" id="slug" placeholder="specialty-slug">
    <a href="#" id="viewLink" target="_blank">View ‚Üí</a>
</div>

<div class="editor-grid">
<!-- LEFT: EDITOR -->
<div class="editor-main">
    <div class="form-group"><input type="text" class="form-input" id="name" placeholder="Specialty name..." oninput="autoSlug()" style="font-size:1.3rem;font-weight:700;padding:14px 16px;font-family:'Playfair Display',serif"></div>
    
    <div class="form-row">
        <div><label class="field-label">Icon (Emoji)</label><input class="field-input" id="icon" placeholder="ü´Ä üß† ü¶¥ ..." style="font-size:1.2rem;text-align:center;width:60px"></div>
        <div><label class="field-label">Category</label><select class="field-select" id="category"><option value="">None</option><option value="surgical">Surgical</option><option value="medical">Medical</option><option value="oncology">Oncology</option><option value="super_specialty">Super Specialty</option></select></div>
    </div>

    <div class="form-group">
        <label class="field-label">Short Description</label>
        <textarea class="field-input" id="description" rows="2" placeholder="Brief overview for listings and cards..." style="resize:vertical"></textarea>
    </div>

    <div class="form-group">
        <label class="field-label">Long Description (Rich Content)</label>
        <div id="editor"></div>
        <div class="word-count" id="wordCount">0 words</div>
    </div>
</div>

<!-- RIGHT: SIDEBAR PANELS -->
<div class="editor-sidebar">

    <!-- PUBLISH -->
    <div class="panel">
        <div class="panel__head" onclick="this.parentElement.classList.toggle('collapsed')">üìã Publish</div>
        <div class="panel__body">
            <div class="status-row"><span class="status-label">Status</span><select class="form-select" id="status" style="width:auto;padding:4px 8px;font-size:.82rem"><option value="draft">Draft</option><option value="published">Published</option></select></div>
            <div class="status-row"><span class="status-label">Featured</span><select class="form-select" id="is_featured" style="width:auto;padding:4px 8px;font-size:.82rem"><option value="false">No</option><option value="true">Yes ‚≠ê</option></select></div>
            <div class="status-row"><span class="status-label">Order</span><input type="number" class="form-input" id="display_order" value="0" style="width:60px;padding:4px 8px;font-size:.82rem"></div>
            <div class="publish-actions">
                <button class="btn btn--outline btn--sm" style="flex:1" onclick="saveSpec('draft')">üíæ Save Draft</button>
                <button class="btn btn--primary btn--sm" style="flex:1" onclick="saveSpec('published')">üöÄ Publish</button>
            </div>
        </div>
    </div>

    <!-- AI EDITOR -->
    <div class="claude-panel panel">
        <div class="panel__head" style="background:linear-gradient(135deg,#0B2545,#13315C);color:#fff;border-color:rgba(255,255,255,.1)">ü§ñ AI Writer</div>
        <div class="panel__body">
            <div class="claude-chat">
                <div class="claude-messages" id="aiMessages">
                    <div class="claude-msg claude-msg--ai">Hi! I can help you write content for this specialty. Try the quick actions below or ask me anything.</div>
                </div>
                <div class="claude-actions">
                    <button class="claude-quick" onclick="aiQuick('write')">‚úçÔ∏è Write Full</button>
                    <button class="claude-quick" onclick="aiQuick('intro')">üìù Intro</button>
                    <button class="claude-quick" onclick="aiQuick('conditions')">üè• Conditions</button>
                    <button class="claude-quick" onclick="aiQuick('procedures')">‚öïÔ∏è Procedures</button>
                    <button class="claude-quick" onclick="aiQuick('seo')">üîç Auto SEO</button>
                    <button class="claude-quick" onclick="aiQuick('improve')">‚ú® Improve</button>
                </div>
                <div class="claude-input">
                    <input type="text" id="aiInput" placeholder="Ask AI to help..." onkeydown="if(event.key==='Enter')sendAI()">
                    <button onclick="sendAI()" id="aiSendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LIVE PREVIEW -->
    <div class="preview-panel panel">
        <div class="panel__head" onclick="this.parentElement.classList.toggle('collapsed')">üëÅÔ∏è Live Preview</div>
        <div class="panel__body" style="padding:0">
            <div class="preview-frame" id="previewFrame"><p style="color:var(--gray-400);text-align:center;padding:20px">Start writing to see preview...</p></div>
        </div>
    </div>

    <!-- FEATURED IMAGE -->
    <div class="panel">
        <div class="panel__head" onclick="this.parentElement.classList.toggle('collapsed')">üñºÔ∏è Featured Image</div>
        <div class="panel__body">
            <div id="imagePreview" style="margin-bottom:8px"></div>
            <div style="display:flex;gap:6px">
                <button class="btn btn--outline btn--sm" style="font-size:.78rem" onclick="openMP()">Choose Image</button>
                <button class="btn btn--outline btn--sm" style="font-size:.78rem;display:none" id="imgRemoveBtn" onclick="clearImage()">‚úï Remove</button>
            </div>
            <input type="hidden" id="image">
        </div>
    </div>

    <!-- SEO -->
    <div class="panel collapsed">
        <div class="panel__head" onclick="this.parentElement.classList.toggle('collapsed')">üîç SEO Settings</div>
        <div class="panel__body">
            <div class="form-group"><label class="field-label">Meta Title</label><input class="field-input" id="meta_title" placeholder="Leave blank to use specialty name"></div>
            <div class="form-group" style="margin-top:10px"><label class="field-label">Meta Description</label><textarea class="field-input" id="meta_description" rows="2" placeholder="Leave blank to use description" style="resize:vertical"></textarea></div>
            <div class="form-group" style="margin-top:10px"><label class="field-label">Treatment Count</label><input class="field-input" type="number" id="treatment_count" value="0" placeholder="Auto-counted"></div>
        </div>
    </div>

</div>
</div>
</div>

<!-- Media Picker -->
<div class="mp-bg" id="mediaPicker" onclick="if(event.target===this)closeMP()">
<div class="mp-modal"><div class="mp-header"><span>Select Image</span><div style="display:flex;align-items:center;gap:8px"><label class="btn btn--outline btn--sm" style="cursor:pointer;padding:4px 10px;font-size:.78rem">üì§ Upload<input type="file" accept="image/*" onchange="uploadFile(this)" style="display:none"></label><button style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--gray-400)" onclick="closeMP()">‚úï</button></div></div>
<div id="uploadStatus" style="display:none;padding:8px 20px;font-size:.82rem;color:var(--teal);background:var(--gray-50);border-bottom:1px solid var(--gray-200)"></div>
<div class="mp-grid" id="mediaGrid"></div>
<div class="mp-footer"><button class="btn btn--outline btn--sm" style="padding:4px 12px;font-size:.78rem" onclick="closeMP()">Cancel</button><button class="btn btn--primary btn--sm" style="padding:4px 12px;font-size:.78rem" onclick="confirmMP()">Use Image</button></div></div></div>

</main></div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script src="/js/sidebar.js" defer></script>
<script>
// ===== INIT =====
const editId = window.location.pathname.includes('/edit/') ? window.location.pathname.split('/edit/')[1] : null;
let autoSaveTimer = null, hasChanges = false;

// ===== QUILL =====
const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Write detailed content about this specialty...',
    modules: { toolbar: [
        [{ header: [2, 3, false] }],
        ['bold', 'italic', 'underline'],
        [{ color: [] }, { background: [] }],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['blockquote', 'link', 'image'],
        [{ align: [] }],
        ['clean']
    ]}
});

quill.on('text-change', () => {
    const text = quill.getText().trim();
    document.getElementById('wordCount').textContent = (text ? text.split(/\s+/).length : 0) + ' words';
    document.getElementById('previewFrame').innerHTML = quill.root.innerHTML;
    markChanged();
});

// ===== AUTO-SLUG =====
function autoSlug() {
    if (!editId) {
        const name = document.getElementById('name').value;
        document.getElementById('slug').value = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    }
    updateViewLink();
    markChanged();
}

function updateViewLink() {
    const slug = document.getElementById('slug').value;
    document.getElementById('viewLink').href = 'https://ginger.healthcare/specialties/' + slug + '/';
}

// ===== AUTO-SAVE =====
function markChanged() {
    hasChanges = true;
    document.getElementById('autoSave').textContent = '‚óè Unsaved';
    document.getElementById('autoSave').className = 'autosave-indicator';
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => { if (editId && hasChanges) saveSpec(null, true); }, 30000);
}

// ===== SAVE =====
async function saveSpec(status, isAuto) {
    const data = {
        name: document.getElementById('name').value,
        slug: document.getElementById('slug').value,
        icon: document.getElementById('icon').value,
        category: document.getElementById('category').value,
        description: document.getElementById('description').value,
        long_description: quill.root.innerHTML === '<p><br></p>' ? '' : quill.root.innerHTML,
        image: document.getElementById('image').value,
        is_featured: document.getElementById('is_featured').value === 'true',
        display_order: parseInt(document.getElementById('display_order').value) || 0,
        treatment_count: parseInt(document.getElementById('treatment_count').value) || 0,
        meta_title: document.getElementById('meta_title').value,
        meta_description: document.getElementById('meta_description').value,
        status: status || document.getElementById('status').value
    };
    if (!data.name) return isAuto ? null : alert('Name is required');
    if (!data.slug) data.slug = data.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

    const indicator = document.getElementById('autoSave');
    indicator.textContent = '‚è≥ Saving...';
    indicator.className = 'autosave-indicator saving';

    try {
        const url = editId ? '/api/specialties/' + editId : '/api/specialties';
        const r = await fetch(url, { method: editId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (r.ok) {
            const result = await r.json();
            hasChanges = false;
            indicator.textContent = '‚úÖ Saved';
            indicator.className = 'autosave-indicator saved';
            if (!editId && result.id) {
                window.location.href = '/specialties/edit/' + result.id;
            } else if (!isAuto) {
                window.location.href = '/specialties-mgmt';
            }
        } else {
            const e = await r.json();
            indicator.textContent = '‚ùå Error';
            indicator.className = 'autosave-indicator';
            if (!isAuto) alert('Error: ' + (e.error || 'Save failed'));
        }
    } catch(e) {
        indicator.textContent = '‚ùå Error';
        if (!isAuto) alert('Save failed');
    }
}

// ===== LOAD =====
async function loadSpec() {
    if (!editId) return;
    try {
        const r = await fetch('/api/specialties/' + editId);
        if (!r.ok) return alert('Failed to load specialty');
        const s = await r.json();
        document.getElementById('name').value = s.name || '';
        document.getElementById('slug').value = s.slug || '';
        document.getElementById('icon').value = s.icon || '';
        document.getElementById('category').value = s.category || '';
        document.getElementById('description').value = s.description || '';
        quill.root.innerHTML = s.long_description || '';
        document.getElementById('status').value = s.status || 'draft';
        document.getElementById('is_featured').value = s.is_featured ? 'true' : 'false';
        document.getElementById('display_order').value = s.display_order || 0;
        document.getElementById('treatment_count').value = s.treatment_count || 0;
        document.getElementById('meta_title').value = s.meta_title || '';
        document.getElementById('meta_description').value = s.meta_description || '';
        document.getElementById('image').value = s.image || '';
        document.getElementById('pageTitle').textContent = 'Edit: ' + s.name;
        if (s.image) showImagePreview(s.image);
        if (s.long_description) document.getElementById('previewFrame').innerHTML = s.long_description;
        updateViewLink();
        hasChanges = false;
    } catch(e) { alert('Load failed: ' + e.message); }
}

// ===== AI CHAT =====
let aiGenerating = false;

async function sendAI() {
    const input = document.getElementById('aiInput');
    const prompt = input.value.trim();
    if (!prompt || aiGenerating) return;
    input.value = '';
    addAIMsg(prompt, 'user');
    await callAI(prompt);
}

async function aiQuick(action) {
    if (aiGenerating) return;
    const name = document.getElementById('name').value || 'this specialty';
    const currentContent = quill.getText().trim();
    const prompts = {
        write: `Write a comprehensive, detailed long description for the medical specialty "${name}". Include: overview, common conditions, procedures, benefits of treatment abroad. Format in HTML with h2, h3, p, ul, li tags. Make it 600-800 words.`,
        intro: `Write a compelling 2-paragraph introduction for the "${name}" specialty page. Format in HTML with p tags.`,
        conditions: `List the most common conditions and diseases treated under "${name}". Format as an HTML section with h3 and ul/li tags. Include 8-12 conditions with brief descriptions.`,
        procedures: `List the most common procedures and treatments available under "${name}". Format as an HTML section with h3 and ul/li tags. Include 8-12 procedures with brief descriptions.`,
        seo: `Based on the specialty "${name}", generate: 1) An SEO-optimized meta title (under 60 chars) 2) An SEO meta description (under 155 chars) 3) A short description for cards/listings (under 200 chars). Format as plain text with labels.`,
        improve: `Here is the current content for "${name}":\n\n${currentContent.substring(0, 2000)}\n\nPlease improve this content: make it more detailed, better structured, more engaging, and more medically accurate. Return improved HTML.`
    };
    addAIMsg(action === 'write' ? '‚úçÔ∏è Write full content' : action === 'seo' ? 'üîç Generate SEO' : '‚ú® ' + action.charAt(0).toUpperCase() + action.slice(1), 'user');
    await callAI(prompts[action] || prompts.write);
}

async function callAI(prompt) {
    aiGenerating = true;
    document.getElementById('aiSendBtn').disabled = true;
    const loadMsg = addAIMsg('‚è≥ Thinking...', 'ai');
    
    try {
        const context = `Specialty: ${document.getElementById('name').value || 'Unknown'}\nCategory: ${document.getElementById('category').value || 'general'}\nCurrent description: ${document.getElementById('description').value || 'none'}`;
        const r = await fetch('/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, type: 'specialty', context })
        });
        
        if (!r.ok) throw new Error('AI request failed');
        const data = await r.json();
        const content = data.content || 'No response';
        
        loadMsg.innerHTML = formatAIResponse(content);
        
        // Add action buttons
        const actions = document.createElement('div');
        actions.style.cssText = 'display:flex;gap:6px;margin-top:8px';
        
        // Check if response contains HTML
        if (content.includes('<h') || content.includes('<p>') || content.includes('<ul>')) {
            const insertBtn = document.createElement('button');
            insertBtn.textContent = 'üìã Insert to Editor';
            insertBtn.className = 'claude-quick';
            insertBtn.style.cssText = 'background:rgba(242,101,34,.2);border-color:rgba(242,101,34,.3);color:#FF8A50';
            insertBtn.onclick = () => {
                // Extract HTML from response
                let html = content;
                // If wrapped in code blocks, extract
                const match = html.match(/```html?\n?([\s\S]*?)```/);
                if (match) html = match[1];
                quill.root.innerHTML = quill.root.innerHTML === '<p><br></p>' ? html : quill.root.innerHTML + html;
                insertBtn.textContent = '‚úÖ Inserted!';
                insertBtn.disabled = true;
            };
            actions.appendChild(insertBtn);
            
            const replaceBtn = document.createElement('button');
            replaceBtn.textContent = 'üîÑ Replace All';
            replaceBtn.className = 'claude-quick';
            replaceBtn.onclick = () => {
                let html = content;
                const match2 = html.match(/```html?\n?([\s\S]*?)```/);
                if (match2) html = match2[1];
                quill.root.innerHTML = html;
                replaceBtn.textContent = '‚úÖ Replaced!';
                replaceBtn.disabled = true;
            };
            actions.appendChild(replaceBtn);
        }
        
        // Check if SEO content
        if (content.toLowerCase().includes('meta title') || content.toLowerCase().includes('meta description')) {
            const seoBtn = document.createElement('button');
            seoBtn.textContent = 'üîç Apply SEO';
            seoBtn.className = 'claude-quick';
            seoBtn.style.cssText = 'background:rgba(14,165,160,.2);border-color:rgba(14,165,160,.3);color:#0EA5A0';
            seoBtn.onclick = () => {
                const lines = content.split('\n');
                lines.forEach(line => {
                    if (line.toLowerCase().includes('meta title')) {
                        const val = line.replace(/.*?[:]\s*/i, '').replace(/^["']|["']$/g, '').trim();
                        if (val) document.getElementById('meta_title').value = val;
                    }
                    if (line.toLowerCase().includes('meta description')) {
                        const val = line.replace(/.*?[:]\s*/i, '').replace(/^["']|["']$/g, '').trim();
                        if (val) document.getElementById('meta_description').value = val;
                    }
                    if (line.toLowerCase().includes('short description') || line.toLowerCase().includes('card')) {
                        const val = line.replace(/.*?[:]\s*/i, '').replace(/^["']|["']$/g, '').trim();
                        if (val && val.length < 250) document.getElementById('description').value = val;
                    }
                });
                seoBtn.textContent = '‚úÖ Applied!';
                seoBtn.disabled = true;
            };
            actions.appendChild(seoBtn);
        }
        
        if (actions.children.length) loadMsg.appendChild(actions);
        
    } catch(e) {
        loadMsg.textContent = '‚ùå Error: ' + e.message;
    }
    
    aiGenerating = false;
    document.getElementById('aiSendBtn').disabled = false;
    document.getElementById('aiMessages').scrollTop = 99999;
}

function addAIMsg(text, type) {
    const div = document.createElement('div');
    div.className = 'claude-msg claude-msg--' + type;
    div.textContent = text;
    document.getElementById('aiMessages').appendChild(div);
    document.getElementById('aiMessages').scrollTop = 99999;
    return div;
}

function formatAIResponse(text) {
    // Convert markdown-like to simple HTML
    return text
        .replace(/```html?\n?([\s\S]*?)```/g, '<div style="background:rgba(0,0,0,.2);padding:10px;border-radius:6px;margin:6px 0;font-size:.78rem;overflow-x:auto;white-space:pre-wrap">$1</div>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
}

// ===== IMAGE =====
let selectedMediaUrl = null;

function showImagePreview(url) {
    if (!url) return;
    const src = url.startsWith('http') ? url : 'https://enter.ginger.healthcare' + url;
    document.getElementById('imagePreview').innerHTML = '<img src="' + src + '" style="width:100%;border-radius:8px;border:1px solid var(--gray-200)" onerror="this.style.display=\'none\'" loading="lazy">';
    document.getElementById('imgRemoveBtn').style.display = '';
}

function clearImage() {
    document.getElementById('image').value = '';
    document.getElementById('imagePreview').innerHTML = '';
    document.getElementById('imgRemoveBtn').style.display = 'none';
    markChanged();
}

async function openMP() {
    selectedMediaUrl = null;
    document.getElementById('mediaPicker').classList.add('open');
    try {
        const r = await fetch('/api/media');
        const m = await r.json();
        document.getElementById('mediaGrid').innerHTML = m.filter(x => x.mime_type && x.mime_type.startsWith('image/')).map(x =>
            '<div class="mp-item" onclick="pickM(this,\'' + x.url + '\')"><img src="' + x.url + '"></div>'
        ).join('') || '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--gray-400)">No images. Upload first.</div>';
    } catch(e) { console.error(e); }
}

function closeMP() { document.getElementById('mediaPicker').classList.remove('open'); }
function pickM(el, url) { document.querySelectorAll('.mp-item').forEach(i => i.classList.remove('selected')); el.classList.add('selected'); selectedMediaUrl = url; }

function confirmMP() {
    if (!selectedMediaUrl) { alert('Select an image'); return; }
    document.getElementById('image').value = selectedMediaUrl;
    showImagePreview(selectedMediaUrl);
    closeMP();
    markChanged();
}

async function uploadFile(input) {
    const file = input.files[0]; if (!file) return;
    const s = document.getElementById('uploadStatus');
    s.style.display = ''; s.textContent = '‚è≥ Uploading...';
    try {
        const fd = new FormData(); fd.append('file', file);
        const r = await fetch('/api/media/upload', { method: 'POST', body: fd });
        if (r.ok) { s.textContent = '‚úÖ Done!'; input.value = ''; setTimeout(() => { s.style.display = 'none'; openMP(); }, 500); }
        else { const e = await r.json(); s.textContent = '‚ùå ' + (e.error || 'Failed'); }
    } catch(e) { s.textContent = '‚ùå ' + e.message; }
}

// ===== WARN UNSAVED =====
window.addEventListener('beforeunload', e => { if (hasChanges) { e.preventDefault(); e.returnValue = ''; } });
document.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveSpec(null, false); } });

// ===== INIT =====
if (editId) loadSpec();
updateViewLink();
</script>
</body></html>
