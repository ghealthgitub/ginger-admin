<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Blog Studio | Ginger Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
:root{--navy:#0B2545;--navy-light:#13315C;--ginger:#F26522;--ginger-dark:#D9531E;--teal:#0EA5A0;--white:#FFFFFF;--gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;--gray-400:#9CA3AF;--gray-500:#6B7280;--gray-600:#4B5563;--gray-700:#374151}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--gray-100);height:100vh;overflow:hidden;font-size:14px;color:var(--gray-700)}

/* TOP BAR */
.topbar{display:flex;align-items:center;gap:12px;padding:0 16px;background:var(--white);border-bottom:1px solid var(--gray-200);z-index:10;height:48px}
.topbar__back{color:var(--white);font-size:.82rem;text-decoration:none;padding:6px 12px;border:none;border-radius:6px;transition:all .2s;font-weight:600;display:flex;align-items:center;gap:4px;background:var(--teal)}
.topbar__back:hover{background:#0c918c}
.topbar__title{flex:1;color:var(--navy);font-family:'Playfair Display',serif;font-size:1rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.topbar__status{font-size:.7rem;font-weight:700;padding:3px 10px;border-radius:50px;text-transform:uppercase}
.topbar__status--draft{background:#FEF3C7;color:#D97706;border:1px solid #FCD34D}
.topbar__status--published{background:#D1FAE5;color:#059669;border:1px solid #6EE7B7}
.topbar__saved{color:var(--teal);font-size:.78rem;font-weight:600;display:none}
/* Unsaved changes indicator */
.topbar__unsaved{color:#D97706;font-size:.72rem;font-weight:600;display:none;align-items:center;gap:4px;flex-shrink:0;animation:fadeUnsaved .3s}
.topbar__unsaved::before{content:'';width:6px;height:6px;border-radius:50%;background:#D97706;display:inline-block}
@keyframes fadeUnsaved{from{opacity:0}to{opacity:1}}
.topbar__actions{display:flex;gap:6px}
.topbar__btn{padding:6px 14px;border-radius:6px;font-weight:600;font-size:.8rem;cursor:pointer;border:none;font-family:inherit;transition:all .2s}
.topbar__btn--save{background:var(--gray-50);color:var(--gray-600);border:1px solid var(--gray-200)}
.topbar__btn--save:hover{background:var(--gray-200);color:var(--navy)}
.topbar__btn--publish{background:var(--ginger);color:#fff;box-shadow:0 2px 8px rgba(242,101,34,.25)}
.topbar__btn--publish:hover{background:var(--ginger-dark);box-shadow:0 4px 14px rgba(242,101,34,.35);transform:translateY(-1px)}
.topbar__btn--view{background:var(--teal);color:#fff;box-shadow:0 2px 8px rgba(14,165,160,.25);text-decoration:none}
.topbar__btn--view:hover{background:#0c918c;box-shadow:0 4px 14px rgba(14,165,160,.35);transform:translateY(-1px)}
.topbar__btn--update{background:var(--ginger);color:#fff}
.topbar__btn--update:hover{background:var(--ginger-dark)}
.topbar__btn--preview{background:var(--gray-50);color:var(--teal);border:1px solid var(--gray-200)}
.topbar__btn--preview:hover{background:rgba(14,165,160,.1);border-color:var(--teal)}
/* Sidebar publish buttons ‚Äî state-aware */
.pub-btn{width:100%;padding:9px;border-radius:6px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;border:none;display:flex;align-items:center;justify-content:center;gap:6px}
.pub-btn:active{transform:scale(.98)}
.pub-btn--publish{background:var(--ginger);color:#fff;box-shadow:0 2px 10px rgba(242,101,34,.25)}
.pub-btn--publish:hover{background:var(--ginger-dark);box-shadow:0 4px 16px rgba(242,101,34,.35)}
.pub-btn--draft{background:var(--white);color:var(--gray-600);border:1px solid var(--gray-200)}
.pub-btn--draft:hover{background:var(--gray-100)}
.pub-btn--view{background:var(--teal);color:#fff;box-shadow:0 2px 10px rgba(14,165,160,.25)}
.pub-btn--view:hover{background:#0c918c;box-shadow:0 4px 16px rgba(14,165,160,.35)}
.pub-btn--update{background:var(--ginger);color:#fff}
.pub-btn--update:hover{background:var(--ginger-dark)}

/* LAYOUT */
.studio{display:flex;height:calc(100vh - 48px)}
/* Focus mode */
body.focus-mode .panel-left,body.focus-mode #dragLeft,body.focus-mode .panel-right,body.focus-mode #dragRight{width:0!important;min-width:0!important;overflow:hidden;opacity:0;pointer-events:none;border:none;padding:0;transition:all .35s ease}
body.focus-mode .panel-middle{flex:1}
body.focus-mode .topbar__actions .topbar__btn:not(.topbar__btn--focus){opacity:.4}
body.focus-mode .topbar__actions .topbar__btn:not(.topbar__btn--focus):hover{opacity:1}
/* Focus button */
.topbar__btn--focus{background:transparent;color:var(--gray-400);border:1px solid var(--gray-200);padding:6px 10px;font-size:.9rem;line-height:1}
.topbar__btn--focus:hover{background:var(--navy);color:#fff;border-color:var(--navy)}
.topbar__btn--focus.active{background:var(--navy);color:#fff;border-color:var(--navy)}
/* Shortcut hint toast */
.shortcut-toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:rgba(11,37,69,.9);color:#fff;padding:6px 16px;border-radius:50px;font-size:.72rem;font-weight:600;display:none;z-index:101;backdrop-filter:blur(8px)}

/* LEFT: AI Assistant (clean white) */
.panel-left{width:300px;min-width:220px;background:var(--white);border-right:1px solid var(--gray-200);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.ai-header{padding:12px 16px;border-bottom:1px solid var(--gray-200);flex-shrink:0}
.ai-header__title{color:var(--navy);font-size:.88rem;font-weight:700;display:flex;align-items:center;gap:6px}
.ai-header__sub{color:var(--gray-400);font-size:.72rem;margin-top:2px}
.tone-row{display:flex;gap:4px;padding:8px 12px;border-bottom:1px solid var(--gray-100);flex-shrink:0;flex-wrap:wrap}
.tone-btn{padding:4px 11px;border-radius:50px;font-size:.72rem;font-weight:600;cursor:pointer;border:1.5px solid var(--gray-200);background:var(--white);color:var(--gray-400);font-family:inherit;transition:all .25s}
.tone-btn:hover{color:var(--navy);border-color:var(--gray-300);background:var(--gray-50)}
.tone-btn.active{background:var(--teal);color:#fff;border-color:var(--teal);box-shadow:0 2px 6px rgba(14,165,160,.3)}
.ai-messages{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:8px;min-height:0;background:var(--gray-50)}
.ai-messages::-webkit-scrollbar{width:3px}.ai-messages::-webkit-scrollbar-thumb{background:var(--gray-300);border-radius:3px}
.ai-msg{padding:10px 12px;border-radius:10px;font-size:.82rem;line-height:1.6;max-width:95%;animation:fadeMsg .3s}
@keyframes fadeMsg{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.ai-msg--user{background:var(--teal);color:#fff;align-self:flex-end;border-bottom-right-radius:3px}
.ai-msg--bot{background:var(--white);color:var(--gray-700);align-self:flex-start;border:1px solid var(--gray-200);border-bottom-left-radius:3px}
.ai-msg--bot strong{color:var(--teal)}
.ai-msg--system{background:rgba(14,165,160,.08);color:var(--teal);align-self:center;font-size:.75rem;font-weight:600;border-radius:20px;padding:4px 14px}
.ai-msg__actions{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.ai-msg__btn{padding:4px 10px;border-radius:5px;font-size:.73rem;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s}
.ai-msg__btn--insert{background:var(--teal);color:#fff}.ai-msg__btn--insert:hover{background:#0c918c}
.ai-msg__btn--append{background:var(--gray-100);color:var(--gray-600);border:1px solid var(--gray-200)}.ai-msg__btn--append:hover{background:var(--gray-200)}
.ai-msg__time{font-size:.6rem;margin-top:4px;opacity:.5}
.ai-msg--user .ai-msg__time{text-align:right}
.ai-msg--bot .ai-msg__time{text-align:left}
.ai-quick{display:flex;flex-direction:column;border-top:1px solid var(--gray-100);flex-shrink:0;background:var(--white)}
.ai-quick__group{padding:6px 12px 4px}
.ai-quick__label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--gray-400);margin-bottom:4px}
.ai-quick__row{display:flex;flex-wrap:wrap;gap:4px}
.ai-qbtn{background:var(--gray-50);border:1px solid var(--gray-200);color:var(--gray-600);border-radius:6px;padding:4px 10px;font-size:.72rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;gap:3px}
.ai-qbtn:hover{background:var(--teal);color:#fff;border-color:var(--teal);transform:translateY(-1px);box-shadow:0 2px 6px rgba(14,165,160,.15)}
.ai-input{padding:10px 12px;border-top:1px solid var(--gray-200);background:var(--white);flex-shrink:0}
.ai-input__row{display:flex;gap:6px;align-items:flex-end}
.ai-input textarea{flex:1;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:8px;padding:8px 10px;color:var(--navy);font-size:.82rem;font-family:inherit;resize:none;min-height:130px;max-height:200px;line-height:1.5}
.ai-input textarea::placeholder{color:var(--gray-400)}
.ai-input textarea:focus{outline:none;border-color:var(--teal)}
.ai-send{width:32px;height:32px;background:var(--teal);color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.ai-send:hover{background:#0c918c}.ai-send:disabled{opacity:.4}
.ai-attach{width:32px;height:28px;background:var(--gray-100);border:1px solid var(--gray-200);border-radius:50%;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.ai-attach:hover{background:var(--gray-200)}
.ai-input__attachments{padding:6px 0 0;display:flex;gap:6px}
.ai-input__file{display:flex;align-items:center;gap:6px;background:rgba(14,165,160,.08);border:1px solid rgba(14,165,160,.2);border-radius:6px;padding:4px 8px;font-size:.72rem;color:var(--teal);font-weight:600}
.ai-input__file button{background:none;border:none;cursor:pointer;color:var(--gray-400);font-size:.85rem;padding:0 2px}
.ai-input__file button:hover{color:#EF4444}
.ai-input__tools{display:flex;gap:6px;padding-top:8px}
.ai-tool-btn{display:flex;align-items:center;gap:3px;padding:4px 10px;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:6px;font-size:.72rem;font-weight:600;color:var(--gray-500);cursor:pointer;font-family:inherit;transition:all .2s}
.ai-tool-btn:hover{background:var(--teal);color:#fff;border-color:var(--teal)}

/* Image Editor Overlay (WordPress-style) */
.img-edit-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9998;display:none;align-items:center;justify-content:center}
.img-edit-overlay.active{display:flex}
.img-edit-modal{background:#fff;border-radius:12px;width:90%;max-width:800px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
.img-edit-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--gray-200)}
.img-edit-header h3{font-family:'Playfair Display',serif;font-size:1rem;color:var(--navy);margin:0}
.img-edit-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--gray-400);padding:4px 8px;border-radius:6px}
.img-edit-close:hover{background:var(--gray-100);color:var(--navy)}
.img-edit-body{display:flex;flex:1;overflow:hidden;min-height:0}
.img-edit-preview{flex:1;display:flex;align-items:center;justify-content:center;background:var(--gray-50);padding:20px;overflow:auto;min-width:0}
.img-edit-preview img{max-width:100%;max-height:60vh;object-fit:contain;border-radius:4px}
.img-edit-sidebar{width:280px;border-left:1px solid var(--gray-200);padding:16px;overflow-y:auto;flex-shrink:0}
.img-edit-sidebar label{font-size:.75rem;font-weight:600;color:var(--gray-500);display:block;margin-bottom:3px}
.img-edit-sidebar input,.img-edit-sidebar textarea{width:100%;padding:6px 8px;border:1px solid var(--gray-200);border-radius:5px;font-size:.8rem;font-family:inherit;margin-bottom:10px}
.img-edit-sidebar textarea{resize:vertical;min-height:50px}
.img-edit-sidebar select{width:100%;padding:6px 8px;border:1px solid var(--gray-200);border-radius:5px;font-size:.8rem;font-family:inherit;margin-bottom:10px;background:#fff}
.img-edit-hint{font-size:.68rem;color:var(--gray-400);margin:-6px 0 10px;line-height:1.4}
.img-edit-dims{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.img-edit-dims input{width:70px;text-align:center}
.img-edit-dims span{color:var(--gray-400);font-size:.8rem}
.img-edit-align{display:flex;gap:4px;margin-bottom:12px}
.img-edit-align button{flex:1;padding:6px;border:1px solid var(--gray-200);border-radius:5px;font-size:.75rem;cursor:pointer;background:var(--white);color:var(--gray-500);font-family:inherit;transition:all .2s}
.img-edit-align button.active{background:var(--teal);color:#fff;border-color:var(--teal)}
.img-edit-align button:hover:not(.active){background:var(--gray-50)}
.img-edit-footer{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-top:1px solid var(--gray-200);background:var(--gray-50)}
.img-edit-footer .btn-del{color:#EF4444;font-size:.8rem;border:none;background:none;cursor:pointer;font-family:inherit;font-weight:600}
.img-edit-footer .btn-del:hover{text-decoration:underline}
.img-edit-footer .btn-save{padding:8px 20px;background:var(--teal);color:#fff;border:none;border-radius:6px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit}
.img-edit-footer .btn-save:hover{background:#0c918c}

/* Make images clickable in editor */
.editor-wrap .ql-editor img{cursor:pointer;border:2px solid transparent;border-radius:4px;transition:border .2s;max-width:100%}
.editor-wrap .ql-editor img:hover{border-color:var(--teal)}
.editor-wrap .ql-editor img.img-selected{border-color:var(--teal);box-shadow:0 0 0 3px rgba(14,165,160,.2)}
.ai-typing{display:flex;gap:5px;padding:6px 10px;align-items:center}.ai-typing span{width:6px;height:6px;border-radius:50%;background:var(--teal);animation:aiBounce 1.4s infinite ease-in-out}.ai-typing span:nth-child(2){animation-delay:.16s}.ai-typing span:nth-child(3){animation-delay:.32s}
@keyframes aiBounce{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}

/* DRAG HANDLE */
.drag-handle{width:5px;background:var(--gray-200);cursor:col-resize;flex-shrink:0;position:relative;transition:background .2s}
.drag-handle:hover,.drag-handle.dragging{background:var(--teal)}
.drag-handle::after{content:'‚ãÆ';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--gray-400);font-size:12px}.drag-handle:hover::after{color:#fff}

/* MIDDLE: Editor */
.panel-middle{flex:1;display:flex;flex-direction:column;min-width:300px;background:var(--white);overflow:hidden}

/* Title area */
.title-area{padding:20px 32px 0;flex-shrink:0}
.title-input{width:100%;border:none;outline:none;font-family:'Playfair Display',serif;font-size:1.65rem;font-weight:600;color:var(--navy);padding:0;margin-bottom:6px;line-height:1.3}
.title-input::placeholder{color:var(--gray-300)}
.permalink-area{display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--gray-400);margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--gray-100)}
.permalink-area span{color:var(--gray-400)}
.permalink-area input{border:none;outline:none;font-family:inherit;font-size:.78rem;color:var(--teal);font-weight:500;padding:2px 4px;border-radius:3px;background:transparent;flex:1;min-width:0}
.permalink-area input:focus{background:var(--gray-50);border:1px solid var(--gray-200)}
.permalink-edit{font-size:.72rem;color:var(--teal);cursor:pointer;font-weight:600;border:none;background:none;font-family:inherit}
.permalink-edit:hover{text-decoration:underline}
.permalink-status{font-size:.7rem;font-weight:600;margin-left:6px;transition:all .2s}
.permalink-status--ok{color:#059669}
.permalink-status--taken{color:#DC2626}
.permalink-status--checking{color:var(--gray-400)}

/* Editor toolbar area */
.editor-toolbar-area{display:flex;align-items:center;justify-content:space-between;padding:4px 12px;border-bottom:1px solid var(--gray-200);background:var(--white);flex-shrink:0}
.editor-tabs{display:flex;gap:0}
.editor-tab{padding:6px 14px;font-size:.8rem;font-weight:600;color:var(--gray-400);cursor:pointer;border-radius:6px;transition:all .2s;display:flex;align-items:center;gap:4px}
.editor-tab.active{color:var(--teal);background:rgba(14,165,160,.08)}
.editor-tab:hover:not(.active){color:var(--gray-600)}
.editor-stats{display:flex;gap:12px;font-size:.75rem;color:var(--gray-400);align-items:center}
.word-goal{display:flex;align-items:center;gap:6px}
.word-goal__bar{width:60px;height:5px;background:var(--gray-200);border-radius:5px;overflow:hidden}
.word-goal__fill{height:100%;border-radius:5px;transition:width .4s ease,background .4s;width:0}
.word-goal__fill--red{background:#DC2626}
.word-goal__fill--amber{background:#D97706}
.word-goal__fill--green{background:#059669}

.editor-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden}
.editor-wrap .ql-toolbar{border:none!important;border-bottom:1px solid var(--gray-200)!important;background:var(--white);padding:6px 12px!important}
.editor-wrap .ql-container{border:none!important;flex:1;overflow-y:auto}
.editor-wrap .ql-editor{min-height:100%;padding:20px 32px;font-size:.95rem;line-height:1.85;font-family:'DM Sans',sans-serif;color:var(--gray-700)}
.editor-wrap .ql-editor h1,.editor-wrap .ql-editor h2,.editor-wrap .ql-editor h3{font-family:'Playfair Display',serif;color:var(--navy);margin:14px 0 8px}
.editor-wrap .ql-editor p{margin-bottom:12px}
.preview-pane{flex:1;overflow-y:auto;display:none;background:var(--white)}
.preview-pane.active{display:block}
.preview-pane iframe{width:100%;height:100%;border:none}

/* RIGHT: Sidebar (WordPress-style) */
.panel-right{width:320px;min-width:260px;background:var(--white);border-left:1px solid var(--gray-200);overflow-y:auto;flex-shrink:0}
.panel-right::-webkit-scrollbar{width:3px}.panel-right::-webkit-scrollbar-thumb{background:var(--gray-300);border-radius:3px}

/* Sidebar boxes (WordPress-style metaboxes) */
.sb-box{border:1px solid var(--gray-200);border-radius:10px;margin:12px 12px 0;overflow:hidden;transition:box-shadow .2s}
.sb-box:hover{box-shadow:0 2px 8px rgba(11,37,69,.04)}
.sb-box:last-child{margin-bottom:12px}
.sb-box__head{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:var(--gray-50);border-bottom:1px solid var(--gray-200);cursor:pointer;user-select:none;transition:background .2s}
.sb-box__head:hover{background:var(--gray-100)}
.sb-box__title{font-size:.82rem;font-weight:700;color:var(--navy);display:flex;align-items:center;gap:6px}
.sb-box__toggle{font-size:.7rem;color:var(--gray-400);transition:transform .3s ease}
.sb-box.collapsed .sb-box__body{max-height:0;padding-top:0;padding-bottom:0;overflow:hidden;opacity:0}
.sb-box.collapsed .sb-box__toggle{transform:rotate(-90deg)}
.sb-box__body{padding:14px;max-height:600px;transition:max-height .35s ease,opacity .25s,padding .25s;opacity:1;overflow:hidden}
.sb-label{font-size:.75rem;font-weight:600;color:var(--gray-500);margin-bottom:4px;display:flex;align-items:center;justify-content:space-between}
.sb-label .char-count{font-weight:400;color:var(--gray-400);text-transform:none;letter-spacing:0}
.sb-input{width:100%;padding:7px 10px;border:1.5px solid var(--gray-200);border-radius:7px;font-family:inherit;font-size:.82rem;transition:all .2s;margin-bottom:10px}
.sb-input:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(14,165,160,.08)}
.sb-textarea{width:100%;padding:7px 10px;border:1.5px solid var(--gray-200);border-radius:7px;font-family:inherit;font-size:.82rem;resize:vertical;min-height:55px;line-height:1.5;margin-bottom:10px;transition:all .2s}
.sb-textarea:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px rgba(14,165,160,.08)}
.sb-select{width:100%;padding:7px 10px;border:1.5px solid var(--gray-200);border-radius:7px;font-family:inherit;font-size:.82rem;background:var(--white);margin-bottom:10px;transition:border .2s}
.sb-select:focus{outline:none;border-color:var(--teal)}
.sb-hint{font-size:.72rem;color:var(--gray-400);margin:-6px 0 10px}

/* Publish Box (special) */
.publish-box{border-color:var(--teal);box-shadow:0 0 0 1px rgba(14,165,160,.06)}
.publish-box .sb-box__head{background:rgba(14,165,160,.03);border-bottom-color:rgba(14,165,160,.12)}
.publish-row{display:flex;align-items:center;gap:8px;font-size:.8rem;color:var(--gray-600);margin-bottom:8px}
.publish-row span:first-child{color:var(--gray-400);width:14px;text-align:center}
.publish-row a{color:var(--teal);font-size:.72rem;font-weight:600;cursor:pointer;text-decoration:none;margin-left:auto}
.publish-row a:hover{text-decoration:underline}
.publish-btns{display:flex;flex-direction:column;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid var(--gray-100)}
.publish-link{font-size:.78rem;color:#EF4444;cursor:pointer;border:none;background:none;font-family:inherit;padding:0;margin-top:8px}
.publish-link:hover{text-decoration:underline}

/* SEO Score ‚Äî Donut Chart */
.seo-donut{position:relative;width:48px;height:48px;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
.seo-donut svg{transform:rotate(-90deg);width:48px;height:48px}
.seo-donut__bg{fill:none;stroke:var(--gray-200);stroke-width:4}
.seo-donut__fill{fill:none;stroke-width:4;stroke-linecap:round;transition:stroke-dashoffset .6s ease,stroke .4s}
.seo-donut__text{position:absolute;font-size:.7rem;font-weight:700;line-height:1}
.seo-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:4px;font-size:.78rem;font-weight:700}
.seo-badge--green{background:#D1FAE5;color:#059669}
.seo-badge--yellow{background:#FEF3C7;color:#D97706}
.seo-badge--red{background:#FEE2E2;color:#DC2626}
.seo-badge--gray{background:var(--gray-100);color:var(--gray-400)}

/* Featured Image ‚Äî Drop Zone */
.feat-img-preview{width:100%;border-radius:8px;object-fit:cover;border:1px solid var(--gray-200);margin-bottom:8px;display:none;max-height:180px;background:var(--gray-50)}
.feat-img-empty{border:2px dashed var(--gray-300);border-radius:10px;padding:26px 16px;text-align:center;color:var(--gray-400);font-size:.8rem;cursor:pointer;transition:all .3s;background:var(--gray-50)}
.feat-img-empty:hover{border-color:var(--teal);background:rgba(14,165,160,.03);color:var(--teal)}
.feat-img-empty.dragover{border-color:var(--teal);background:rgba(14,165,160,.06);transform:scale(1.01)}
.feat-img-btns{display:flex;gap:6px;margin-top:6px}
.feat-img-btn{padding:5px 12px;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;border:1px solid var(--gray-200);background:var(--white);color:var(--gray-600);font-family:inherit;transition:all .2s}
.feat-img-btn:hover{border-color:var(--teal);color:var(--teal)}

/* Tags */
.tags-wrap{display:flex;flex-wrap:wrap;gap:4px;padding:6px;border:1px solid var(--gray-200);border-radius:6px;min-height:34px;cursor:text;margin-bottom:10px}
.tags-wrap:focus-within{border-color:var(--teal);box-shadow:0 0 0 2px rgba(14,165,160,.08)}
.tag-chip{background:rgba(14,165,160,.08);color:var(--teal);padding:3px 9px;border-radius:50px;font-size:.73rem;font-weight:600;display:flex;align-items:center;gap:4px}
.tag-chip button{background:none;border:none;color:var(--gray-400);cursor:pointer;font-size:.8rem;padding:0;line-height:1}.tag-chip button:hover{color:#EF4444}
.tag-input{border:none;outline:none;font-family:inherit;font-size:.82rem;flex:1;min-width:60px;padding:2px}

/* Content Analysis ‚Äî color-coded */
.analysis-item{display:flex;align-items:center;gap:8px;font-size:.78rem;color:var(--gray-600);margin-bottom:6px;padding:4px 0}
.analysis-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.analysis-dot--green{background:#059669}
.analysis-dot--amber{background:#D97706}
.analysis-dot--red{background:#DC2626}
.analysis-dot--info{background:#3B82F6}

/* Revisions */
.rev-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--gray-100);font-size:.78rem;cursor:pointer;transition:background .1s;margin:0 -14px;padding-left:14px;padding-right:14px}
.rev-item:hover{background:var(--gray-50)}
.rev-item:last-child{border:none}
.rev-icon{width:24px;height:24px;border-radius:50%;background:var(--gray-100);display:flex;align-items:center;justify-content:center;font-size:.65rem;flex-shrink:0}
.rev-icon--auto{background:#FEF3C7;color:#D97706}
.rev-icon--manual{background:#D1FAE5;color:#059669}
.rev-info{flex:1;min-width:0}
.rev-user{font-weight:600;color:var(--navy);font-size:.75rem}
.rev-date{color:var(--gray-400);font-size:.7rem}
.rev-type{font-size:.65rem;padding:1px 6px;border-radius:3px;background:var(--gray-100);color:var(--gray-400);margin-left:auto;flex-shrink:0}

/* Undo button */
.topbar__btn--undo{background:var(--gray-50);color:var(--gray-500);border:1px solid var(--gray-200);font-size:.78rem}
.topbar__btn--undo:hover{background:#FEF3C7;color:#D97706;border-color:#FCD34D}

/* Auto-save */
.autosave-toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--navy);color:#fff;padding:8px 20px;border-radius:8px;font-size:.8rem;font-weight:600;display:none;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,.2)}

/* Media Picker Modal */
.mp-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px}
.mp-overlay.active{display:flex}
.mp-modal{background:#fff;border-radius:14px;width:100%;max-width:860px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;position:relative;min-width:500px;min-height:350px;resize:both}
.mp-resize-handle{position:absolute;bottom:0;right:0;width:20px;height:20px;cursor:nwse-resize;z-index:10}
.mp-resize-handle::after{content:'';position:absolute;bottom:4px;right:4px;width:10px;height:10px;border-right:2px solid var(--gray-300);border-bottom:2px solid var(--gray-300)}
.mp-drag-bar{cursor:move;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--gray-200);user-select:none}
.mp-close{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--gray-400);padding:4px 8px;border-radius:6px}
.mp-close:hover{background:var(--gray-100);color:var(--navy)}
.mp-tabs{display:flex;gap:0;border-bottom:1px solid var(--gray-200)}
.mp-tab{padding:10px 20px;font-size:.85rem;font-weight:600;cursor:pointer;border:none;background:none;color:var(--gray-400);border-bottom:2px solid transparent;font-family:inherit}
.mp-tab:hover{color:var(--navy)}
.mp-tab.active{color:var(--teal);border-bottom-color:var(--teal)}
.mp-body{flex:1;overflow-y:auto;padding:16px 20px;min-height:0}
.mp-upload-zone{border:2px dashed var(--gray-300);border-radius:10px;padding:32px;text-align:center;cursor:pointer;transition:all .2s}
.mp-upload-zone:hover{border-color:var(--ginger);background:rgba(242,101,34,.03)}
.mp-search{width:100%;padding:8px 12px;border:1.5px solid var(--gray-200);border-radius:8px;font-size:.85rem;font-family:inherit;margin-bottom:12px}
.mp-search:focus{border-color:var(--teal);outline:none}
.mp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.mp-item{border:2px solid transparent;border-radius:8px;overflow:hidden;cursor:pointer;position:relative;aspect-ratio:1;background:var(--gray-100)}
.mp-item:hover{border-color:var(--teal)}
.mp-item.selected{border-color:var(--teal);box-shadow:0 0 0 2px rgba(14,165,160,.3)}
.mp-item.selected::after{content:'‚úì';position:absolute;top:6px;right:6px;width:22px;height:22px;background:var(--teal);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700}
.mp-item img{width:100%;height:100%;object-fit:cover}
.mp-sidebar{width:260px;border-left:1px solid var(--gray-200);padding:16px;display:none;flex-shrink:0;overflow-y:auto;min-height:0}
.mp-sidebar.active{display:block}
.mp-sidebar__img{width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;margin-bottom:10px;background:var(--gray-100)}
.mp-sidebar__name{font-size:.78rem;font-weight:600;color:var(--navy);margin-bottom:4px;word-break:break-all}
.mp-sidebar__meta{font-size:.7rem;color:var(--gray-400);margin-bottom:10px}
.mp-sidebar label{font-size:.72rem;font-weight:600;color:var(--gray-500);display:block;margin-bottom:3px}
.mp-sidebar input,.mp-sidebar textarea{width:100%;padding:5px 8px;border:1px solid var(--gray-200);border-radius:5px;font-size:.78rem;font-family:inherit;margin-bottom:8px;box-sizing:border-box}
.mp-sidebar textarea{resize:vertical}
.mp-footer{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-top:1px solid var(--gray-200);background:var(--gray-50)}
.mp-footer__info{font-size:.8rem;color:var(--gray-400)}
.mp-set-btn{padding:8px 20px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:.85rem;font-weight:700;cursor:pointer;font-family:inherit}
.mp-set-btn:hover{background:#0c918c}
.mp-set-btn:disabled{background:var(--gray-300);cursor:not-allowed}
</style></head><body>

<!-- TOP BAR -->
<div class="topbar">
    <a href="/blog" class="topbar__back">‚Üê Blog</a>
    <div class="topbar__title" id="topTitle">New Post</div>
    <span class="topbar__status topbar__status--draft" id="statusBadge">Draft</span>
    <span class="topbar__saved" id="savedIndicator">‚úì Saved</span>
    <span class="topbar__unsaved" id="unsavedIndicator">Unsaved changes</span>
    <div class="topbar__actions">
        <button class="topbar__btn topbar__btn--undo" onclick="undoChanges()" title="Undo recent changes">‚Ü© Undo</button>
        <button class="topbar__btn topbar__btn--focus" id="focusBtn" onclick="toggleFocus()" title="Focus mode (Ctrl+\)">‚õ∂</button>
        <button class="topbar__btn topbar__btn--preview" onclick="togglePreview()">üëÅ Preview</button>
        <!-- Draft state buttons -->
        <button class="topbar__btn topbar__btn--save" id="topDraftBtn" onclick="savePost('draft')">Save Draft</button>
        <button class="topbar__btn topbar__btn--publish" id="topPublishBtn" onclick="savePost('published')">Publish</button>
        <!-- Published state buttons (hidden by default) -->
        <a class="topbar__btn topbar__btn--view" id="topViewBtn" style="display:none" target="_blank">View Article ‚Üó</a>
        <button class="topbar__btn topbar__btn--update" id="topUpdateBtn" style="display:none" onclick="savePost('published')">Update</button>
    </div>
</div>

<!-- 3-PANEL LAYOUT -->
<div class="studio">

<!-- LEFT: AI Assistant -->
<div class="panel-left" id="panelLeft">
    <div class="ai-header">
        <div class="ai-header__title">ü§ñ AI Writing Assistant</div>
        <div class="ai-header__sub">Write, edit, optimize ‚Äî powered by Claude</div>
    </div>
    <div class="tone-row">
        <button class="tone-btn active" data-tone="professional" onclick="setTone(this)">Professional</button>
        <button class="tone-btn" data-tone="friendly" onclick="setTone(this)">Friendly</button>
        <button class="tone-btn" data-tone="medical" onclick="setTone(this)">Medical</button>
        <button class="tone-btn" data-tone="patient" onclick="setTone(this)">Patient-friendly</button>
        <button class="tone-btn" data-tone="seo" onclick="setTone(this)">SEO-focused</button>
    </div>
    <div class="ai-messages" id="aiMessages">
        <div class="ai-msg ai-msg--system">‚ú® AI Ready</div>
        <div class="ai-msg ai-msg--bot">Hi! I'll help you write and optimize your post. What would you like to do?</div>
    </div>
    <div class="ai-quick">
        <div class="ai-quick__group">
            <div class="ai-quick__label">‚úç Write</div>
            <div class="ai-quick__row">
                <button class="ai-qbtn" onclick="aiCmd('Write a comprehensive blog post about the title topic with proper H2/H3 headings, introduction, and conclusion')">‚ú® Full post</button>
                <button class="ai-qbtn" onclick="aiCmd('Add a compelling introduction paragraph')">üìù Intro</button>
                <button class="ai-qbtn" onclick="aiCmd('Add a conclusion with a call-to-action')">üé¨ Conclusion</button>
                <button class="ai-qbtn" onclick="aiCmd('Suggest relevant internal links and CTAs based on the content and our medical tourism website')">üîó Add CTAs</button>
            </div>
        </div>
        <div class="ai-quick__group" style="padding-bottom:8px">
            <div class="ai-quick__label">üéØ Optimize</div>
            <div class="ai-quick__row">
                <button class="ai-qbtn" onclick="aiCmd('Generate meta title, meta description, excerpt, and focus keywords based on the content')">üè∑ Auto SEO</button>
                <button class="ai-qbtn" onclick="aiCmd('Improve the current content - make it more engaging with better structure')">üéØ Improve</button>
                <button class="ai-qbtn" onclick="aiCmd('Fix grammar and improve readability')">‚úè Grammar</button>
                <button class="ai-qbtn" onclick="aiCmd('Make the content shorter and more concise')">‚úÇ Shorten</button>
            </div>
        </div>
    </div>
    <div class="ai-input">
        <div class="ai-input__row">
            <textarea id="aiInput" placeholder="Ask AI to write, edit, improve..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();aiCmd()}"></textarea>
            <div style="display:flex;flex-direction:column;gap:4px">
                <button class="ai-send" onclick="aiCmd()" id="aiSendBtn" title="Send">‚ñ∂</button>
                <label class="ai-attach" title="Attach image or document"><input type="file" id="aiFileInput" style="display:none" accept="image/*,.docx,.doc,.txt,.md,.pdf" onchange="handleFileAttach(this)">üìé</label>
            </div>
        </div>
        <div class="ai-input__attachments" id="aiAttachments" style="display:none">
            <div class="ai-input__file" id="aiAttachedFile">
                <span id="aiFileName"></span>
                <button onclick="removeAiAttachment()">√ó</button>
            </div>
        </div>
        <div class="ai-input__tools">
            <label class="ai-tool-btn" title="Import Word document into editor"><input type="file" style="display:none" accept=".docx,.doc,.txt,image/*" onchange="importDocx(this)">üìÑ Import files & images</label>
        </div>
    </div>
</div>

<!-- DRAG HANDLE 1 -->
<div class="drag-handle" id="dragLeft"></div>

<!-- MIDDLE: Editor -->
<div class="panel-middle" id="panelMiddle">
    <!-- Title + Permalink -->
    <div class="title-area">
        <input type="text" class="title-input" id="title" placeholder="Add title" oninput="autoSlug();updateTopTitle();resetAutoSave()">
        <div class="permalink-area">
            <span>Permalink:</span>
            <span style="color:var(--gray-500)">ginger.healthcare/blog/</span>
            <input type="text" id="slug" placeholder="post-slug" oninput="slugEdited=true;checkSlugUnique()">
            <button class="permalink-edit" id="slugEditBtn" onclick="document.getElementById('slug').focus()">Edit</button>
            <span class="permalink-status" id="slugStatus"></span>
        </div>
    </div>
    <!-- Editor Toolbar -->
    <div class="editor-toolbar-area">
        <div class="editor-tabs">
            <div class="editor-tab active" id="tabWrite" onclick="showTab('write')">‚úè Write</div>
            <div class="editor-tab" id="tabPreview" onclick="showTab('preview')">üëÅ Preview</div>
        </div>
        <div class="editor-stats">
            <span id="wordCount">0 words</span>
            <span id="readTime">0 min read</span>
            <div class="word-goal">
                <div class="word-goal__bar"><div class="word-goal__fill" id="wordGoalFill"></div></div>
                <span id="wordGoalLabel" style="font-size:.68rem">0/600</span>
            </div>
        </div>
    </div>
    <div class="editor-wrap" id="editorWrap">
        <div id="editor"></div>
    </div>
    <div class="preview-pane" id="previewPane">
        <iframe id="previewFrame" src="about:blank"></iframe>
    </div>
</div>

<!-- DRAG HANDLE 2 -->
<div class="drag-handle" id="dragRight"></div>

<!-- RIGHT: Post Settings Sidebar (WordPress-style) -->
<div class="panel-right" id="panelRight">

    <!-- Publish Box -->
    <div class="sb-box publish-box">
        <div class="sb-box__head" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="sb-box__title">üìã Publish</div>
            <span class="sb-box__toggle">‚ñæ</span>
        </div>
        <div class="sb-box__body">
            <div class="publish-row"><span>üìå</span> <strong>Status:</strong> <span id="pubStatus">Draft</span> <a onclick="document.getElementById('status').focus()">Edit</a></div>
            <div class="publish-row"><span>üëÅ</span> <strong>Visibility:</strong> Public</div>
            <div class="publish-row" id="pubDateRow" style="display:none"><span>üìÖ</span> <strong>Published:</strong> <span id="pubDate"></span></div>
            <div class="publish-row" id="seoRow">
                <span>üìä</span> <strong>SEO:</strong>
                <div class="seo-donut" id="seoDonut">
                    <svg viewBox="0 0 36 36"><circle class="seo-donut__bg" cx="18" cy="18" r="15.9"/><circle class="seo-donut__fill" id="seoArc" cx="18" cy="18" r="15.9" stroke-dasharray="100" stroke-dashoffset="100"/></svg>
                    <span class="seo-donut__text" id="seoText">0</span>
                </div>
            </div>
            <select class="sb-select" id="status" onchange="updatePublishUI();resetAutoSave()" style="margin-bottom:0">
                <option value="draft">üìù Draft</option>
                <option value="published">‚úÖ Published</option>
            </select>
            <div class="publish-btns" id="pubBtnsDraft">
                <button class="pub-btn pub-btn--publish" id="publishBtnSidebar" onclick="savePost('published')">üöÄ Publish</button>
                <button class="pub-btn pub-btn--draft" onclick="savePost('draft')">Save Draft</button>
            </div>
            <div class="publish-btns" id="pubBtnsPublished" style="display:none">
                <a class="pub-btn pub-btn--view" id="viewBtnSidebar" target="_blank" style="text-decoration:none;color:#fff">üëÅ View Article ‚Üó</a>
                <button class="pub-btn pub-btn--update" onclick="savePost('published')">üíæ Update Article</button>
                <button class="pub-btn pub-btn--draft" onclick="savePost('draft')">Revert to Draft</button>
            </div>
            <button class="publish-link" id="trashBtn" onclick="if(confirm('Move to trash?'))window.location='/blog'">Move to Trash</button>
        </div>
    </div>

    <!-- Category -->
    <div class="sb-box">
        <div class="sb-box__head" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="sb-box__title">üìÅ Category</div>
            <span class="sb-box__toggle">‚ñæ</span>
        </div>
        <div class="sb-box__body">
            <select class="sb-select" id="category" onchange="resetAutoSave()" style="margin-bottom:0">
                <option value="">Select category</option>
                <option>Medical Tourism</option>
                <option>Fertility & IVF</option>
                <option>Cosmetic Surgery</option>
                <option>Cardiac Care</option>
                <option>Orthopedics</option>
                <option>Dental</option>
                <option>Eye Care</option>
                <option>Patient Stories</option>
                <option>Travel & Recovery</option>
                <option>Insurance & Costs</option>
                <option>Health Tips</option>
            </select>
        </div>
    </div>

    <!-- Tags -->
    <div class="sb-box">
        <div class="sb-box__head" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="sb-box__title">üè∑ Tags</div>
            <span class="sb-box__toggle">‚ñæ</span>
        </div>
        <div class="sb-box__body">
            <div class="tags-wrap" id="tagsWrap" onclick="document.getElementById('tagInput').focus()">
                <input class="tag-input" id="tagInput" placeholder="Add tag..." onkeydown="handleTagKey(event)">
            </div>
            <div class="sb-hint">Press Enter or comma to add</div>
        </div>
    </div>

    <!-- Featured Image -->
    <div class="sb-box">
        <div class="sb-box__head" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="sb-box__title">üñº Featured Image</div>
            <span class="sb-box__toggle">‚ñæ</span>
        </div>
        <div class="sb-box__body">
            <div id="featImgBox">
                <img class="feat-img-preview" id="featImgPreview">
                <div class="feat-img-empty" id="featImgEmpty" onclick="openMediaPicker()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFeatDrop(event)">
                    <div style="font-size:1.8rem;margin-bottom:4px">üñº</div>
                    <div style="font-weight:500">Click or drag image here</div>
                    <div style="font-size:.68rem;color:var(--gray-400);margin-top:4px">Recommended: 1200 √ó 630px</div>
                </div>
            </div>
            <div id="featImgActions" style="display:none;margin-top:6px">
                <span id="featImgName" style="font-size:.72rem;color:var(--gray-500);display:block;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
                <div class="feat-img-btns">
                    <button class="feat-img-btn" onclick="openMediaPicker()">Change</button>
                    <button class="feat-img-btn" onclick="removeFeatImage()" style="color:#EF4444">Remove</button>
                </div>
            </div>
            <input type="hidden" id="coverImage">
        </div>
    </div>

    <!-- SEO -->
    <div class="sb-box">
        <div class="sb-box__head" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="sb-box__title">üîç SEO Settings</div>
            <span class="sb-box__toggle">‚ñæ</span>
        </div>
        <div class="sb-box__body">
            <div class="sb-label">Focus Keywords</div>
            <input class="sb-input" id="focusKeywords" placeholder="e.g. IVF treatment, fertility" oninput="analyzeSEO();resetAutoSave()">
            <div class="sb-hint">Comma-separated keywords</div>
            <div class="sb-label">Meta Title <span class="char-count" id="metaTitleCount">0/60</span></div>
            <input class="sb-input" id="metaTitle" placeholder="SEO title (auto-generated)" oninput="updateCharCount('metaTitle','metaTitleCount',60);resetAutoSave()">
            <div class="sb-label">Meta Description <span class="char-count" id="metaDescCount">0/160</span></div>
            <textarea class="sb-textarea" id="metaDesc" placeholder="SEO description (auto-generated)" oninput="updateCharCount('metaDesc','metaDescCount',160);resetAutoSave()"></textarea>
            <div class="sb-label">Excerpt</div>
            <textarea class="sb-textarea" id="excerpt" placeholder="Brief summary (auto-generated)" oninput="resetAutoSave()"></textarea>
        </div>
    </div>

    <!-- Content Analysis -->
    <div class="sb-box">
        <div class="sb-box__head" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="sb-box__title">üìä Content Analysis</div>
            <span class="sb-box__toggle">‚ñæ</span>
        </div>
        <div class="sb-box__body" id="contentAnalysis" style="font-size:.78rem;color:var(--gray-500);line-height:1.8">
            Write content to see analysis...
        </div>
    </div>

    <!-- Revisions -->
    <div class="sb-box" id="revisionsBox" style="display:none">
        <div class="sb-box__head" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="sb-box__title">üïê Revisions</div>
            <span class="sb-box__toggle">‚ñæ</span>
        </div>
        <div class="sb-box__body" id="revisionsBody">
            <div style="font-size:.78rem;color:var(--gray-400)">Loading...</div>
        </div>
    </div>
</div>

</div>

<div class="autosave-toast" id="autosaveToast">üíæ Auto-saved</div>
<div class="shortcut-toast" id="shortcutToast"></div>

<!-- Image Editor Overlay -->
<div class="img-edit-overlay" id="imgEditOverlay" onclick="if(event.target===this)closeImgEdit()">
<div class="img-edit-modal">
    <div class="img-edit-header">
        <h3>Image Details</h3>
        <button class="img-edit-close" onclick="closeImgEdit()">&times;</button>
    </div>
    <div class="img-edit-body">
        <div class="img-edit-preview">
            <img id="imgEditPreview" src="">
        </div>
        <div class="img-edit-sidebar">
            <label>Alt Text</label>
            <textarea id="imgEditAlt" rows="2" placeholder="Describe the image for accessibility"></textarea>
            <div class="img-edit-hint">Describe the purpose of the image. Leave empty if decorative.</div>

            <label>Caption</label>
            <textarea id="imgEditCaption" rows="2" placeholder="Image caption (shown below image)"></textarea>

            <label>Link To</label>
            <input type="text" id="imgEditLink" placeholder="https://...">
            <div class="img-edit-hint">URL to link this image to (optional)</div>

            <label>Size</label>
            <select id="imgEditSize" onchange="applyImgSize()">
                <option value="full">Full Size</option>
                <option value="large">Large (800px)</option>
                <option value="medium">Medium (400px)</option>
                <option value="small">Small (200px)</option>
                <option value="custom">Custom</option>
            </select>

            <div class="img-edit-dims" id="imgEditDims" style="display:none">
                <input type="number" id="imgEditW" placeholder="Width" oninput="imgKeepRatio('w')">
                <span>√ó</span>
                <input type="number" id="imgEditH" placeholder="Height" oninput="imgKeepRatio('h')">
                <span>px</span>
            </div>

            <label>Alignment</label>
            <div class="img-edit-align">
                <button onclick="setImgAlign('none',this)" class="active">None</button>
                <button onclick="setImgAlign('left',this)">Left</button>
                <button onclick="setImgAlign('center',this)">Center</button>
                <button onclick="setImgAlign('right',this)">Right</button>
            </div>

            <label>CSS Class</label>
            <input type="text" id="imgEditClass" placeholder="Optional CSS class">
        </div>
    </div>
    <div class="img-edit-footer">
        <button class="btn-del" onclick="deleteEditImg()">Remove Image</button>
        <button class="btn-save" onclick="saveImgEdit()">Update</button>
    </div>
</div>
</div>

<!-- Media Picker Modal -->
<div class="mp-overlay" id="mediaPicker">
<div class="mp-modal" id="mpModal">
    <div class="mp-drag-bar" id="mpDragBar">
        <h3 style="font-family:'Playfair Display',serif;font-size:1.05rem;margin:0;color:var(--navy)">Featured Image</h3>
        <button class="mp-close" onclick="closeMediaPicker()">&times;</button>
    </div>
    <div class="mp-tabs">
        <button class="mp-tab active" onclick="mpSwitchTab('library',this)">Media Library</button>
        <button class="mp-tab" onclick="mpSwitchTab('upload',this)">Upload Files</button>
    </div>
    <div style="display:flex;flex:1;overflow:hidden;min-height:0">
        <div class="mp-body" id="mpBody">
            <div id="mpLibraryView">
                <input type="text" class="mp-search" id="mpSearch" placeholder="Search media..." oninput="mpFilter()">
                <div class="mp-grid" id="mpGrid"><div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--gray-400)">Loading...</div></div>
            </div>
            <div id="mpUploadView" style="display:none">
                <div class="mp-upload-zone" id="mpUploadZone">
                    <input type="file" id="mpFileInput" style="display:none" accept="image/*" multiple onchange="mpUploadFiles(this)">
                    <div style="font-size:2rem;margin-bottom:8px">üìÅ</div>
                    <p style="color:var(--gray-500)"><strong>Click to upload</strong> or drag and drop</p>
                    <p style="font-size:.8rem;color:var(--gray-400)">JPG, PNG, WebP ‚Äî Max 10MB</p>
                    <div id="mpUploadProgress" style="display:none;margin-top:10px;font-size:.85rem;color:var(--teal);font-weight:600"></div>
                </div>
            </div>
        </div>
        <div class="mp-sidebar" id="mpSidebar">
            <img class="mp-sidebar__img" id="mpSidebarImg">
            <div class="mp-sidebar__name" id="mpSidebarName"></div>
            <div class="mp-sidebar__meta" id="mpSidebarMeta"></div>
            <label>Alt Text</label>
            <input type="text" id="mpAltText" placeholder="Describe the image" oninput="mpSaveMetadata()">
            <p style="font-size:.65rem;color:var(--gray-400);margin:0 0 8px;line-height:1.4"><a href="https://moz.com/learn/seo/alt-text" target="_blank" style="color:var(--teal)">Learn how to describe the purpose of the image.</a> Leave empty if decorative.</p>
            <label>Title</label>
            <input type="text" id="mpTitle" placeholder="Image title" oninput="mpSaveMetadata()">
            <label>Caption</label>
            <textarea id="mpCaption" rows="2" placeholder="Caption" oninput="mpSaveMetadata()"></textarea>
            <label>File URL</label>
            <input type="text" id="mpFileUrl" readonly style="background:var(--gray-50);cursor:pointer" onclick="mpCopyUrl()">
            <button onclick="mpCopyUrl()" style="padding:4px 10px;border:1px solid var(--gray-200);border-radius:5px;font-size:.72rem;font-weight:600;cursor:pointer;background:var(--white);color:var(--gray-500);margin-bottom:8px;font-family:inherit">Copy URL</button>
            <div id="mpCopyMsg" style="display:none;font-size:.72rem;color:var(--teal);font-weight:600">‚úÖ Copied!</div>
        </div>
    </div>
    <div class="mp-footer">
        <div class="mp-footer__info" id="mpFooterInfo"></div>
        <button class="mp-set-btn" id="mpSetBtn" disabled onclick="mpSetFeaturedImage()">Set Featured Image</button>
    </div>
    <div class="mp-resize-handle" id="mpResizeHandle"></div>
</div>
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js" onerror="var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js';s.id='quillFallback';document.head.appendChild(s)"></script>
<script>
function waitForQuill(cb, attempts) {
    if (typeof Quill !== 'undefined') return cb();
    if (attempts > 40) return console.error('Quill failed to load');
    setTimeout(() => waitForQuill(cb, (attempts||0)+1), 150);
}
waitForQuill(function() {

const pathParts = window.location.pathname.split('/');
const editId = (pathParts[2] === 'edit' || pathParts[2] === 'claude') ? pathParts[3] : null;
let postData = {};
let currentTone = 'professional';
let autoSaveTimer = null;
let tags = [];
let slugEdited = false;
let hasUnsavedChanges = false;

function markUnsaved() {
    hasUnsavedChanges = true;
    document.getElementById('unsavedIndicator').style.display = 'flex';
    document.getElementById('savedIndicator').style.display = 'none';
}
function markSaved() {
    hasUnsavedChanges = false;
    document.getElementById('unsavedIndicator').style.display = 'none';
}
// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; }
});

const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Start writing your story...',
    modules: { toolbar: [
        [{'header':[1,2,3,false]}],['bold','italic','underline','strike'],
        [{'color':[]},{'background':[]}],[{'list':'ordered'},{'list':'bullet'}],
        ['blockquote','code-block'],['link','image'],[{'align':[]}],['clean']
    ]}
});

quill.on('text-change', () => {
    updateStats(); analyzeSEO();
    markUnsaved();
    resetAutoSave();
});

function resetAutoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => savePost('auto'), 15000);
}

/* ‚ïê‚ïê‚ïê Focus mode ‚ïê‚ïê‚ïê */
function toggleFocus() {
    document.body.classList.toggle('focus-mode');
    document.getElementById('focusBtn').classList.toggle('active');
    showShortcut(document.body.classList.contains('focus-mode') ? 'Focus mode ON ‚Äî Esc to exit' : 'Focus mode OFF');
}
function showShortcut(text) {
    const el = document.getElementById('shortcutToast');
    el.textContent = text; el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 1800);
}

/* ‚ïê‚ïê‚ïê Keyboard shortcuts ‚ïê‚ïê‚ïê */
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        savePost(document.getElementById('status').value);
        showShortcut('üíæ Saved!');
    }
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'P' || e.key === 'p')) {
        e.preventDefault();
        togglePreview();
        showShortcut('üëÅ Preview toggled');
    }
    if ((e.ctrlKey || e.metaKey) && e.key === '\\') {
        e.preventDefault();
        toggleFocus();
    }
    if (e.key === 'Escape' && document.body.classList.contains('focus-mode')) {
        toggleFocus();
    }
});

function updateStats() {
    const text = quill.getText().trim();
    const words = text ? text.split(/\s+/).length : 0;
    const readMin = Math.max(1, Math.ceil(words / 200));
    document.getElementById('wordCount').textContent = words + ' words';
    document.getElementById('readTime').textContent = readMin + ' min read';
    // Word goal progress bar
    const goal = 600;
    const pct = Math.min(100, Math.round((words / goal) * 100));
    const fill = document.getElementById('wordGoalFill');
    fill.style.width = pct + '%';
    fill.className = 'word-goal__fill ' + (pct >= 100 ? 'word-goal__fill--green' : pct >= 50 ? 'word-goal__fill--amber' : 'word-goal__fill--red');
    document.getElementById('wordGoalLabel').textContent = words + '/' + goal;
    const analysis = [];
    if (words < 300) analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--red"></span>Content is short (' + words + ' words, aim for 600+)</div>');
    else if (words > 600) analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--green"></span>Good length (' + words + ' words)</div>');
    else analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--amber"></span>' + words + ' words (aim for 600+)</div>');
    const h2Count = (quill.root.innerHTML.match(/<h2/g) || []).length;
    if (h2Count === 0) analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--red"></span>No H2 headings</div>');
    else analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--green"></span>' + h2Count + ' heading(s)</div>');
    const links = (quill.root.innerHTML.match(/<a /g) || []).length;
    if (links === 0) analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--amber"></span>No links found</div>');
    else analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--green"></span>' + links + ' link(s)</div>');
    const imgs = (quill.root.innerHTML.match(/<img/g) || []).length;
    if (imgs === 0) analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--info"></span>Consider adding images</div>');
    else analysis.push('<div class="analysis-item"><span class="analysis-dot analysis-dot--green"></span>' + imgs + ' image(s)</div>');
    document.getElementById('contentAnalysis').innerHTML = analysis.join('');
}

function analyzeSEO() {
    let score = 0;
    const title = document.getElementById('title').value;
    const metaTitle = document.getElementById('metaTitle').value;
    const metaDesc = document.getElementById('metaDesc').value;
    const keywords = document.getElementById('focusKeywords').value;
    const content = quill.getText();
    if (title) score += 15;
    if (metaTitle && metaTitle.length >= 30 && metaTitle.length <= 60) score += 15;
    if (metaDesc && metaDesc.length >= 80 && metaDesc.length <= 160) score += 15;
    if (keywords) score += 10;
    if (keywords && content.toLowerCase().indexOf(keywords.split(',')[0].trim().toLowerCase()) !== -1) score += 10;
    if (keywords && title.toLowerCase().indexOf(keywords.split(',')[0].trim().toLowerCase()) !== -1) score += 10;
    if (content.split(/\s+/).length >= 600) score += 15;
    if ((quill.root.innerHTML.match(/<h2/g) || []).length > 0) score += 10;
    // Update donut chart
    const circumference = 100;
    const offset = circumference - (score / 100 * circumference);
    const arc = document.getElementById('seoArc');
    arc.style.strokeDashoffset = offset;
    arc.style.stroke = score >= 70 ? '#059669' : score >= 40 ? '#D97706' : score > 0 ? '#DC2626' : 'var(--gray-300)';
    const text = document.getElementById('seoText');
    text.textContent = score;
    text.style.color = score >= 70 ? '#059669' : score >= 40 ? '#D97706' : score > 0 ? '#DC2626' : 'var(--gray-400)';
}

function updateCharCount(inputId, countId, max) {
    const len = document.getElementById(inputId).value.length;
    const el = document.getElementById(countId);
    el.textContent = len + '/' + max;
    el.style.color = len > max ? '#EF4444' : len > max * 0.8 ? '#F59E0B' : '';
}

const STOP_WORDS = ['a','an','the','and','or','but','in','on','at','to','for','of','with','by','from','as','is','was','are','were','been','be','have','has','had','do','does','did','will','would','shall','should','may','might','must','can','could','about','above','after','again','against','all','am','any','because','before','being','below','between','both','during','each','few','further','get','got','here','how','if','into','it','its','just','me','more','most','much','no','nor','not','now','off','once','only','other','our','out','over','own','re','same','so','some','such','than','that','their','them','then','there','these','they','this','those','through','too','under','until','up','very','what','when','where','which','while','who','whom','why','you','your'];
const FILLER_WORDS = ['complete','comprehensive','ultimate','definitive','everything','wanted','know','need','introduction','understanding','explained','overview','tips','best','top','guide','things','ways','reasons','heres','look'];
function autoSlug(title) {
    if (!title) title = document.getElementById('title').value;
    if (slugEdited) return;
    if (!title) { document.getElementById('slug').value = ''; return; }
    // Step 1: Remove stop words
    let words = title.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w && !STOP_WORDS.includes(w));
    // Step 2: Remove filler words, but keep some if too few words remain
    let coreWords = words.filter(w => !FILLER_WORDS.includes(w));
    if (coreWords.length >= 3) words = coreWords;
    else if (coreWords.length === 2) {
        // Keep one filler in original position for better SEO
        const keepSet = new Set(coreWords);
        let fillerKept = false;
        words = words.filter(w => {
            if (keepSet.has(w)) { keepSet.delete(w); return true; }
            if (!fillerKept && FILLER_WORDS.includes(w)) { fillerKept = true; return true; }
            return false;
        });
    }
    // else keep words with fillers
    // Step 4: Max 4 words
    words = words.slice(0, 4);
    // Fallback: if too few, use basic filtering
    if (words.length < 2) {
        words = title.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w && w.length > 1 && !['a','an','the','and','or','but','in','on','at','to','for','of','with','by','from','as','is'].includes(w)).slice(0, 4);
    }
    let slug = words.join('-');
    if (slug.length > 50) slug = slug.substring(0, slug.lastIndexOf('-', 50)) || slug.substring(0, 50);
    document.getElementById('slug').value = slug;
    checkSlugUnique();
}

// Slug uniqueness check with debounce
let slugCheckTimer = null;
function checkSlugUnique() {
    const slug = document.getElementById('slug').value.trim();
    const status = document.getElementById('slugStatus');
    if (!slug) { status.textContent = ''; return; }
    status.textContent = '‚è≥';
    status.className = 'permalink-status permalink-status--checking';
    clearTimeout(slugCheckTimer);
    slugCheckTimer = setTimeout(async () => {
        try {
            const exclude = editId || 0;
            const r = await fetch('/api/blog-slug-check/' + encodeURIComponent(slug) + '?exclude=' + exclude);
            const data = await r.json();
            if (data.available) {
                status.textContent = '‚úì Available';
                status.className = 'permalink-status permalink-status--ok';
            } else {
                status.textContent = '‚úó Taken';
                status.className = 'permalink-status permalink-status--taken';
                // Auto-fix: append -2, -3 etc
                autoFixSlug(slug);
            }
        } catch(e) { status.textContent = ''; }
    }, 500);
}

async function autoFixSlug(baseSlug) {
    for (let i = 2; i <= 10; i++) {
        const candidate = baseSlug + '-' + i;
        try {
            const exclude = editId || 0;
            const r = await fetch('/api/blog-slug-check/' + encodeURIComponent(candidate) + '?exclude=' + exclude);
            const data = await r.json();
            if (data.available) {
                document.getElementById('slug').value = candidate;
                const status = document.getElementById('slugStatus');
                status.textContent = '‚úì ' + candidate;
                status.className = 'permalink-status permalink-status--ok';
                return;
            }
        } catch(e) { return; }
    }
}

function updateTopTitle() {
    const t = document.getElementById('title').value;
    document.getElementById('topTitle').textContent = t || 'New Post';
}

function updatePublishUI() {
    const status = document.getElementById('status').value;
    const isPublished = status === 'published' || (postData && postData.status === 'published');
    document.getElementById('pubStatus').textContent = isPublished ? 'Published' : 'Draft';
    const slug = postData.slug || document.getElementById('slug').value;
    const viewUrl = 'https://ginger.healthcare/blog/' + slug + '/';
    if (isPublished && slug) {
        // Top bar: show View + Update, hide Draft + Publish
        document.getElementById('topDraftBtn').style.display = 'none';
        document.getElementById('topPublishBtn').style.display = 'none';
        document.getElementById('topViewBtn').style.display = '';
        document.getElementById('topViewBtn').href = viewUrl;
        document.getElementById('topUpdateBtn').style.display = '';
        // Sidebar: show published buttons
        document.getElementById('pubBtnsDraft').style.display = 'none';
        document.getElementById('pubBtnsPublished').style.display = '';
        document.getElementById('viewBtnSidebar').href = viewUrl;
    } else {
        // Top bar: show Draft + Publish, hide View + Update
        document.getElementById('topDraftBtn').style.display = '';
        document.getElementById('topPublishBtn').style.display = '';
        document.getElementById('topViewBtn').style.display = 'none';
        document.getElementById('topUpdateBtn').style.display = 'none';
        // Sidebar: show draft buttons
        document.getElementById('pubBtnsDraft').style.display = '';
        document.getElementById('pubBtnsPublished').style.display = 'none';
    }
}

function setTone(btn) {
    document.querySelectorAll('.tone-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentTone = btn.dataset.tone;
}

function handleTagKey(e) {
    if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const val = e.target.value.trim().replace(/,/g,'');
        if (val && !tags.includes(val)) { tags.push(val); renderTags(); }
        e.target.value = '';
    }
}
function renderTags() {
    const wrap = document.getElementById('tagsWrap');
    wrap.innerHTML = tags.map((t,i) => '<span class="tag-chip">' + t + '<button onclick="tags.splice(' + i + ',1);renderTags()">&times;</button></span>').join('') + '<input class="tag-input" id="tagInput" placeholder="Add tag..." onkeydown="handleTagKey(event)">';
}

function showTab(tab) {
    const writeActive = tab === 'write';
    document.getElementById('tabWrite').classList.toggle('active', writeActive);
    document.getElementById('tabPreview').classList.toggle('active', !writeActive);
    document.getElementById('editorWrap').style.display = writeActive ? '' : 'none';
    document.getElementById('previewPane').classList.toggle('active', !writeActive);
    if (!writeActive) {
        const frame = document.getElementById('previewFrame');
        const content = quill.root.innerHTML;
        const title = document.getElementById('title').value;
        const cat = document.getElementById('category').value;
        frame.srcdoc = '<!DOCTYPE html><html><head><link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet"><style>body{font-family:"DM Sans",sans-serif;max-width:720px;margin:0 auto;padding:40px 20px;color:#374151;line-height:1.8;font-size:16px}h1{font-family:"Playfair Display",serif;color:#0B2545;font-size:2rem;margin-bottom:8px}h2,h3{font-family:"Playfair Display",serif;color:#0B2545;margin:24px 0 12px}.cat{display:inline-block;background:rgba(14,165,160,.1);color:#0EA5A0;padding:2px 12px;border-radius:4px;font-size:.8rem;font-weight:600;margin-bottom:16px}img{max-width:100%;border-radius:8px;margin:16px 0}blockquote{border-left:4px solid #0EA5A0;padding-left:16px;margin:16px 0;color:#6B7280;font-style:italic}a{color:#0EA5A0}</style></head><body>' + (cat?'<span class="cat">'+cat+'</span>':'') + '<h1>'+title+'</h1>' + content + '</body></html>';
    }
}
function togglePreview() { showTab(document.getElementById('previewPane').classList.contains('active') ? 'write' : 'preview'); }

async function loadPost() {
    if (!editId) return;
    try {
        const r = await fetch('/api/blog/' + editId);
        if (!r.ok) return;
        postData = await r.json();
        document.getElementById('title').value = postData.title || '';
        document.getElementById('slug').value = postData.slug || '';
        document.getElementById('metaTitle').value = postData.meta_title || '';
        document.getElementById('metaDesc').value = postData.meta_description || '';
        document.getElementById('excerpt').value = postData.excerpt || '';
        document.getElementById('category').value = postData.category || '';
        document.getElementById('focusKeywords').value = postData.focus_keywords || '';
        document.getElementById('status').value = postData.status || 'draft';
        if (postData.content) quill.root.innerHTML = postData.content;
        if (postData.tags && postData.tags.length) { tags = postData.tags; renderTags(); }
        if (postData.cover_image) {
            document.getElementById('coverImage').value = postData.cover_image;
            document.getElementById('featImgPreview').src = postData.cover_image;
            document.getElementById('featImgPreview').style.display = 'block';
            document.getElementById('featImgEmpty').style.display = 'none';
            document.getElementById('featImgActions').style.display = 'block';
            document.getElementById('featImgName').textContent = postData.cover_image.split('/').pop();
        }
        updateTopTitle();
        const badge = document.getElementById('statusBadge');
        badge.textContent = postData.status;
        badge.className = 'topbar__status topbar__status--' + postData.status;
        updateCharCount('metaTitle','metaTitleCount',60);
        updateCharCount('metaDesc','metaDescCount',160);
        analyzeSEO();
        // Update publish UI
        updatePublishUI();
        if (postData.published_at) {
            document.getElementById('pubDateRow').style.display = '';
            document.getElementById('pubDate').textContent = new Date(postData.published_at).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'});
        }
        slugEdited = true;
        hasUnsavedChanges = false;
        document.getElementById('unsavedIndicator').style.display = 'none';
    } catch(e) { console.error('Load failed', e); }
}

async function savePost(statusOverride) {
    const isAuto = statusOverride === 'auto';
    const data = {
        title: document.getElementById('title').value,
        slug: document.getElementById('slug').value,
        excerpt: document.getElementById('excerpt').value,
        content: quill.root.innerHTML,
        cover_image: document.getElementById('coverImage').value,
        category: document.getElementById('category').value,
        tags: tags,
        status: isAuto ? document.getElementById('status').value : (statusOverride || document.getElementById('status').value),
        read_time: parseInt(document.getElementById('readTime').textContent) || 1,
        meta_title: document.getElementById('metaTitle').value,
        meta_description: document.getElementById('metaDesc').value,
        focus_keywords: document.getElementById('focusKeywords').value,
        _autoSave: isAuto
    };
    if (!data.title) { if (!isAuto) alert('Title is required'); return; }
    if (!isAuto && data.status === 'published' && !data.cover_image) {
        alert('Please upload a Featured Image before publishing.');
        document.querySelector('.sb-box__title').closest('.sb-box') && document.getElementById('featImgEmpty').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    if (!data.slug) data.slug = data.title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
    try {
        const url = editId ? '/api/blog/' + editId : '/api/blog';
        const method = editId ? 'PUT' : 'POST';
        const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
        if (r.ok) {
            const result = await r.json();
            if (!editId && result.id) { window.location.href = '/blog/edit/' + result.id; return; }
            postData = result;
            const badge = document.getElementById('statusBadge');
            badge.textContent = result.status;
            badge.className = 'topbar__status topbar__status--' + result.status;
            updatePublishUI();
            markSaved();
            if (result.published_at) {
                document.getElementById('pubDateRow').style.display = '';
                document.getElementById('pubDate').textContent = new Date(result.published_at).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'});
            }
            if (isAuto) {
                const toast = document.getElementById('autosaveToast');
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 2000);
            } else {
                const saved = document.getElementById('savedIndicator');
                saved.style.display = 'inline';
                saved.innerHTML = '‚úÖ Saved!';
                setTimeout(() => saved.style.display = 'none', 3000);
            }
        } else {
            const e = await r.json();
            if (!isAuto) alert('Error: ' + (e.error || 'Save failed'));
        }
    } catch(e) { if (!isAuto) alert('Save failed'); }
}

// AI Assistant
let aiGenerating = false;
async function aiCmd(customMsg) {
    const input = document.getElementById('aiInput');
    const msg = customMsg || input.value.trim();
    if (!msg || aiGenerating) return;
    input.value = '';
    aiGenerating = true;
    document.getElementById('aiSendBtn').disabled = true;
    const messages = document.getElementById('aiMessages');
    const userDiv = document.createElement('div');
    userDiv.className = 'ai-msg ai-msg--user';
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});
    userDiv.innerHTML = msg + '<div class="ai-msg__time">' + timeStr + '</div>';
    messages.appendChild(userDiv);
    const loadDiv = document.createElement('div');
    loadDiv.className = 'ai-msg ai-msg--bot';
    loadDiv.innerHTML = '<div class="ai-typing"><span></span><span></span><span></span></div>';
    messages.appendChild(loadDiv);
    messages.scrollTop = messages.scrollHeight;
    try {
        const content = quill.root.innerHTML;
        const title = document.getElementById('title').value;
        const keywords = document.getElementById('focusKeywords').value;
        const attachedText = aiAttachedContent ? '\n\nATTACHED DOCUMENT CONTENT:\n' + aiAttachedContent.substring(0, 5000) : '';
        const prompt = `You are an AI writing assistant for a medical tourism blog. Tone: ${currentTone}.

Blog title: "${title}"
Current slug/URL: ${document.getElementById('slug').value || '(none)'}
Focus keywords: ${keywords || '(none set)'}
Current content (first 1000 chars): ${content.substring(0,1000)}${attachedText}

Request: ${msg}

IMPORTANT RULES:
- If the request is about the URL, permalink, or slug, respond ONLY in JSON: {"slug":"suggested-slug","explanation":"why this slug is good"}
- If the request is about SEO/meta fields (title, meta, description, excerpt), respond ONLY in JSON: {"meta_title":"...","meta_description":"...","excerpt":"...","focus_keywords":"...","suggested_tags":["..."]}
- If the request is about content (writing, editing, improving), respond with HTML using h2,h3,p,ul,li,strong,em tags. No markdown, no code fences.
- Add relevant CTAs (links to /get-quote/, /destinations/, /specialties/) where appropriate in the content.
- NEVER respond with plain text suggestions about URLs or slugs - always use JSON format for those.`;
        const r = await fetch('/api/ai/generate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ prompt, type: 'blog', context: title }) });
        const data = await r.json();
        if (r.ok) {
            let result = data.content || '';
            let seoData = null;
            try { const clean = result.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim(); if (clean.startsWith('{')) seoData = JSON.parse(clean); } catch(e) {}
            if (seoData) {
                if (seoData.slug) {
                    // Slug/URL suggestion
                    document.getElementById('slug').value = seoData.slug;
                    slugEdited = true;
                    loadDiv.innerHTML = '‚úÖ URL updated!<br><strong>New slug:</strong> /' + seoData.slug + '/<br>' + (seoData.explanation || '') + '<div class="ai-msg__time">' + timeStr + '</div>';
                } else if (seoData.meta_title || seoData.meta_description) {
                    // SEO fields
                    if (seoData.meta_title) document.getElementById('metaTitle').value = seoData.meta_title;
                    if (seoData.meta_description) document.getElementById('metaDesc').value = seoData.meta_description;
                    if (seoData.excerpt) document.getElementById('excerpt').value = seoData.excerpt;
                    if (seoData.focus_keywords) document.getElementById('focusKeywords').value = seoData.focus_keywords;
                    if (seoData.suggested_tags) { tags = [...new Set([...tags, ...seoData.suggested_tags])]; renderTags(); }
                    updateCharCount('metaTitle','metaTitleCount',60);
                    updateCharCount('metaDesc','metaDescCount',160);
                    analyzeSEO();
                    loadDiv.innerHTML = '‚úÖ SEO fields updated!<br><strong>Meta title:</strong> ' + (seoData.meta_title||'') + '<br><strong>Description:</strong> ' + (seoData.meta_description||'').substring(0,80) + '...<div class="ai-msg__time">' + timeStr + '</div>';
                }
            } else {
                // Content response ‚Äî store in variable for safe retrieval
                const contentId = 'ai_' + Date.now();
                window[contentId] = result;
                const preview = result.replace(/<[^>]*>/g,'').substring(0,180);
                loadDiv.innerHTML = preview + (result.length > 180 ? '...' : '') +
                    `<div class="ai-msg__actions"><button class="ai-msg__btn ai-msg__btn--insert" onclick="insertAI('${contentId}')">üìã Replace</button><button class="ai-msg__btn ai-msg__btn--append" onclick="appendAI('${contentId}')">‚ûï Append</button></div><div class="ai-msg__time">${timeStr}</div>`;
            }
        } else { loadDiv.innerHTML = '‚ùå ' + (data.error || 'Failed'); }
    } catch(e) { loadDiv.innerHTML = '‚ùå Connection failed'; }
    aiGenerating = false;
    document.getElementById('aiSendBtn').disabled = false;
    messages.scrollTop = messages.scrollHeight;
}
function insertAI(contentId) { saveUndoSnapshot(); const html = window[contentId]; if (html) { quill.root.innerHTML = html; updateStats(); analyzeSEO(); } }
function appendAI(contentId) { saveUndoSnapshot(); const html = window[contentId]; if (html) { quill.root.innerHTML += html; updateStats(); analyzeSEO(); } }

// Drag handles
function setupDrag(handleId, panel, dir) {
    const handle = document.getElementById(handleId);
    let isDragging=false, startX, startW;
    handle.addEventListener('mousedown', e => {
        isDragging=true; startX=e.clientX; startW=panel.offsetWidth;
        handle.classList.add('dragging');
        document.body.style.cursor='col-resize'; document.body.style.userSelect='none';
        document.querySelectorAll('iframe').forEach(f=>f.style.pointerEvents='none');
        e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const newW = Math.max(200, Math.min(startW + (dir === 'left' ? dx : -dx), window.innerWidth - 500));
        panel.style.width = newW + 'px';
    });
    document.addEventListener('mouseup', () => {
        if (!isDragging) return; isDragging=false;
        handle.classList.remove('dragging');
        document.body.style.cursor=''; document.body.style.userSelect='';
        document.querySelectorAll('iframe').forEach(f=>f.style.pointerEvents='');
    });
}
setupDrag('dragLeft', document.getElementById('panelLeft'), 'left');
setupDrag('dragRight', document.getElementById('panelRight'), 'right');

// Undo - save snapshot before changes
let undoStack = [];
function saveUndoSnapshot() {
    undoStack.push({
        title: document.getElementById('title').value,
        content: quill.root.innerHTML,
        slug: document.getElementById('slug').value,
        metaTitle: document.getElementById('metaTitle').value,
        metaDesc: document.getElementById('metaDesc').value,
        excerpt: document.getElementById('excerpt').value,
        focusKeywords: document.getElementById('focusKeywords').value,
        category: document.getElementById('category').value,
        coverImage: document.getElementById('coverImage').value,
        tags: [...tags]
    });
    if (undoStack.length > 20) undoStack.shift();
}
function undoChanges() {
    if (!undoStack.length) { alert('Nothing to undo'); return; }
    const snap = undoStack.pop();
    document.getElementById('title').value = snap.title;
    quill.root.innerHTML = snap.content;
    document.getElementById('slug').value = snap.slug;
    document.getElementById('metaTitle').value = snap.metaTitle;
    document.getElementById('metaDesc').value = snap.metaDesc;
    document.getElementById('excerpt').value = snap.excerpt;
    document.getElementById('focusKeywords').value = snap.focusKeywords;
    document.getElementById('category').value = snap.category;
    document.getElementById('coverImage').value = snap.coverImage;
    tags = snap.tags; renderTags();
    updateTopTitle(); updateStats(); analyzeSEO();
    const toast = document.getElementById('autosaveToast');
    toast.textContent = '‚Ü© Undo applied'; toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 2000);
}
// Save snapshot before AI commands
const origAiCmd = aiCmd;

// Revisions
async function loadRevisions() {
    if (!editId) return;
    try {
        const r = await fetch('/api/revisions/blog_post/' + editId);
        if (!r.ok) return;
        const revs = await r.json();
        if (!revs.length) { document.getElementById('revisionsBox').style.display = 'none'; return; }
        document.getElementById('revisionsBox').style.display = '';
        const body = document.getElementById('revisionsBody');
        body.innerHTML = revs.slice(0, 10).map(function(rev) {
            const date = new Date(rev.created_at);
            const ago = timeAgo(date);
            const icon = rev.revision_type === 'autosave' ? 'rev-icon--auto' : 'rev-icon--manual';
            const typeLabel = rev.revision_type === 'autosave' ? 'Auto' : 'Save';
            return '<div class="rev-item" onclick="restoreRevision(' + rev.id + ')">' +
                '<div class="rev-icon ' + icon + '">' + (rev.revision_type === 'autosave' ? '‚è±' : 'üíæ') + '</div>' +
                '<div class="rev-info"><div class="rev-user">' + (rev.user_name || 'Admin') + '</div>' +
                '<div class="rev-date">' + ago + '</div></div>' +
                '<span class="rev-type">' + typeLabel + '</span></div>';
        }).join('');
        if (revs.length > 10) {
            body.innerHTML += '<div style="text-align:center;padding:8px;font-size:.72rem;color:var(--gray-400)">' + (revs.length - 10) + ' more revision(s)</div>';
        }
    } catch(e) {}
}

function timeAgo(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
    if (diff < 86400) return Math.floor(diff / 3600) + ' hour(s) ago';
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

async function restoreRevision(revId) {
    if (!confirm('Restore this revision? Your current changes will be saved as a revision first.')) return;
    // Save current state first
    saveUndoSnapshot();
    try {
        const r = await fetch('/api/revisions/detail/' + revId);
        if (!r.ok) return;
        const rev = await r.json();
        document.getElementById('title').value = rev.title || '';
        quill.root.innerHTML = rev.content || '';
        if (rev.meta) {
            const meta = typeof rev.meta === 'string' ? JSON.parse(rev.meta) : rev.meta;
            if (meta.excerpt) document.getElementById('excerpt').value = meta.excerpt;
            if (meta.meta_title) document.getElementById('metaTitle').value = meta.meta_title;
            if (meta.meta_description) document.getElementById('metaDesc').value = meta.meta_description;
            if (meta.focus_keywords) document.getElementById('focusKeywords').value = meta.focus_keywords;
            if (meta.category) document.getElementById('category').value = meta.category;
        }
        updateTopTitle(); updateStats(); analyzeSEO();
        updateCharCount('metaTitle','metaTitleCount',60);
        updateCharCount('metaDesc','metaDescCount',160);
        const toast = document.getElementById('autosaveToast');
        toast.textContent = 'üïê Revision restored'; toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
    } catch(e) { alert('Failed to restore revision'); }
}

// Init
loadPost().then(() => loadRevisions());
updateStats();

// ===== IMAGE PASTE HANDLER =====
// Intercept pasted/dropped images in Quill ‚Äî upload to server instead of base64
quill.root.addEventListener('paste', function(e) {
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            const file = items[i].getAsFile();
            uploadImageToServer(file).then(url => {
                if (url) {
                    const range = quill.getSelection(true);
                    quill.insertEmbed(range.index, 'image', url);
                    quill.setSelection(range.index + 1);
                }
            });
            return;
        }
    }
    // For non-image paste (e.g. from Word), fix base64 images after paste
    setTimeout(() => fixBase64Images(), 500);
});

quill.root.addEventListener('drop', function(e) {
    const files = e.dataTransfer.files;
    if (files.length) {
        for (let i = 0; i < files.length; i++) {
            if (files[i].type.startsWith('image/')) {
                e.preventDefault();
                uploadImageToServer(files[i]).then(url => {
                    if (url) {
                        const range = quill.getSelection(true);
                        quill.insertEmbed(range ? range.index : quill.getLength(), 'image', url);
                    }
                });
            }
        }
    }
});

async function uploadImageToServer(file) {
    const fd = new FormData();
    fd.append('file', file);
    try {
        const r = await fetch('/api/media/upload', { method: 'POST', body: fd });
        if (r.ok) {
            const data = await r.json();
            return data.url;
        }
    } catch(e) {}
    return null;
}

// After paste from Word, find base64 images and upload them
async function fixBase64Images() {
    const imgs = quill.root.querySelectorAll('img[src^="data:"]');
    if (!imgs.length) return;
    const toast = document.getElementById('autosaveToast');
    toast.textContent = 'üì§ Uploading pasted images...';
    toast.style.display = 'block';
    let count = 0;
    for (const img of imgs) {
        try {
            const blob = dataURLtoBlob(img.src);
            const file = new File([blob], 'pasted-image-' + Date.now() + '.png', { type: blob.type });
            const url = await uploadImageToServer(file);
            if (url) {
                img.src = url;
                count++;
            }
        } catch(e) { console.error('Image upload failed:', e); }
    }
    toast.textContent = count ? '‚úÖ ' + count + ' image(s) uploaded' : '‚ö†Ô∏è Image upload failed';
    setTimeout(() => toast.style.display = 'none', 3000);
}

function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--) u8arr[n] = bstr.charCodeAt(n);
    return new Blob([u8arr], { type: mime });
}

// ===== DOCX IMPORT =====
async function importDocx(input) {
    const file = input.files[0];
    if (!file) return;
    input.value = '';
    const toast = document.getElementById('autosaveToast');

    // Image files ‚Üí upload and insert
    if (file.type.startsWith('image/')) {
        toast.textContent = 'üì§ Uploading image...'; toast.style.display = 'block';
        const url = await uploadImageToServer(file);
        if (url) {
            const range = quill.getSelection(true);
            const idx = range ? range.index : quill.getLength();
            quill.insertEmbed(idx, 'image', url);
            quill.insertText(idx + 1, '\n');
            toast.textContent = '‚úÖ Image inserted';
        } else { toast.textContent = '‚ùå Upload failed'; }
        setTimeout(() => toast.style.display = 'none', 2500);
        return;
    }

    // Docx files ‚Üí full import with images
    if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
        toast.textContent = 'üìÑ Importing document...'; toast.style.display = 'block';
        const fd = new FormData();
        fd.append('file', file);
        try {
            const r = await fetch('/api/import/docx', { method: 'POST', body: fd });
            if (r.ok) {
                const data = await r.json();
                saveUndoSnapshot();
                if (data.html) { quill.root.innerHTML = data.html; updateStats(); analyzeSEO(); }
                toast.textContent = '‚úÖ Imported! ' + (data.imageCount || 0) + ' image(s)';
            } else {
                const err = await r.json();
                toast.textContent = '‚ùå ' + (err.error || 'Import failed');
            }
        } catch(e) { toast.textContent = '‚ùå Import failed'; }
        setTimeout(() => toast.style.display = 'none', 4000);
        return;
    }

    // Text files ‚Üí insert as content
    if (file.name.endsWith('.txt') || file.name.endsWith('.md')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            saveUndoSnapshot();
            const text = e.target.result.replace(/\n/g, '<br>');
            quill.root.innerHTML += text;
            updateStats(); analyzeSEO();
            toast.textContent = '‚úÖ Text imported'; toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2500);
        };
        reader.readAsText(file);
        return;
    }

    alert('Supported: .docx, .txt, images');
}

// ===== INSERT IMAGES FROM COMPUTER =====
async function uploadAndInsertImages(input) {
    const files = input.files;
    if (!files.length) return;
    input.value = '';
    const toast = document.getElementById('autosaveToast');
    for (let i = 0; i < files.length; i++) {
        toast.textContent = 'üì§ Uploading ' + (i+1) + '/' + files.length + '...';
        toast.style.display = 'block';
        const url = await uploadImageToServer(files[i]);
        if (url) {
            const range = quill.getSelection(true);
            const idx = range ? range.index : quill.getLength();
            quill.insertEmbed(idx, 'image', url);
            quill.insertText(idx + 1, '\n');
            quill.setSelection(idx + 2);
        }
    }
    toast.textContent = '‚úÖ ' + files.length + ' image(s) inserted';
    setTimeout(() => toast.style.display = 'none', 3000);
    resetAutoSave();
}

// ===== UNIFIED FILE ATTACH (images + documents) =====
let aiAttachedContent = null;
function handleFileAttach(input) {
    const file = input.files[0];
    if (!file) return;
    input.value = '';

    // Image files ‚Üí upload and insert into editor
    if (file.type.startsWith('image/')) {
        uploadImageToServer(file).then(url => {
            if (url) {
                const range = quill.getSelection(true);
                const idx = range ? range.index : quill.getLength();
                quill.insertEmbed(idx, 'image', url);
                quill.insertText(idx + 1, '\n');
                quill.setSelection(idx + 2);
                resetAutoSave();
                const toast = document.getElementById('autosaveToast');
                toast.textContent = '‚úÖ Image inserted';
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 2000);
            }
        });
        return;
    }

    // Text files ‚Üí attach as AI context
    if (file.name.endsWith('.txt') || file.name.endsWith('.md')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            aiAttachedContent = e.target.result;
            showAiAttachment(file.name);
        };
        reader.readAsText(file);
        return;
    }

    // Docx files ‚Üí extract text for AI context
    if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
        const fd = new FormData();
        fd.append('file', file);
        fetch('/api/import/docx-text', { method: 'POST', body: fd })
            .then(r => r.json())
            .then(data => { aiAttachedContent = data.text || ''; showAiAttachment(file.name); })
            .catch(() => alert('Could not read file'));
        return;
    }

    alert('Supported: images, .docx, .txt, .md');
}

function showAiAttachment(name) {
    document.getElementById('aiFileName').textContent = 'üìé ' + name;
    document.getElementById('aiAttachments').style.display = 'flex';
}
function removeAiAttachment() {
    aiAttachedContent = null;
    document.getElementById('aiAttachments').style.display = 'none';
}

// ===== FEATURED IMAGE DRAG-DROP =====
async function handleFeatDrop(e) {
    const files = e.dataTransfer.files;
    if (!files.length || !files[0].type.startsWith('image/')) return;
    const toast = document.getElementById('autosaveToast');
    toast.textContent = 'üì§ Uploading...'; toast.style.display = 'block';
    const url = await uploadImageToServer(files[0]);
    if (url) {
        document.getElementById('coverImage').value = url;
        document.getElementById('featImgPreview').src = url;
        document.getElementById('featImgPreview').style.display = 'block';
        document.getElementById('featImgEmpty').style.display = 'none';
        document.getElementById('featImgActions').style.display = 'block';
        document.getElementById('featImgName').textContent = files[0].name;
        markUnsaved();
        toast.textContent = '‚úÖ Featured image set';
    } else { toast.textContent = '‚ùå Upload failed'; }
    setTimeout(() => toast.style.display = 'none', 2500);
}

// ===== IMAGE EDITOR (WordPress-style) =====
let editingImg = null;
let imgOrigW = 0, imgOrigH = 0;

// Click handler for images in editor
quill.root.addEventListener('click', function(e) {
    if (e.target.tagName === 'IMG') {
        e.preventDefault();
        openImgEdit(e.target);
    }
});

function openImgEdit(img) {
    editingImg = img;
    document.getElementById('imgEditPreview').src = img.src;
    document.getElementById('imgEditAlt').value = img.alt || '';
    document.getElementById('imgEditCaption').value = img.getAttribute('data-caption') || '';
    document.getElementById('imgEditLink').value = '';
    document.getElementById('imgEditClass').value = img.className || '';

    // Check if wrapped in a link
    if (img.parentElement && img.parentElement.tagName === 'A') {
        document.getElementById('imgEditLink').value = img.parentElement.href || '';
    }

    // Size
    imgOrigW = img.naturalWidth || 800;
    imgOrigH = img.naturalHeight || 600;
    document.getElementById('imgEditW').value = img.width || imgOrigW;
    document.getElementById('imgEditH').value = img.height || imgOrigH;

    const w = img.width || img.naturalWidth;
    if (w >= imgOrigW * 0.9) document.getElementById('imgEditSize').value = 'full';
    else if (w >= 700) document.getElementById('imgEditSize').value = 'large';
    else if (w >= 300) document.getElementById('imgEditSize').value = 'medium';
    else if (w > 0) document.getElementById('imgEditSize').value = 'small';
    else document.getElementById('imgEditSize').value = 'full';

    // Alignment
    const align = img.style.float || (img.style.display === 'block' && img.style.margin === 'auto' ? 'center' : 'none');
    document.querySelectorAll('.img-edit-align button').forEach(b => b.classList.remove('active'));
    const alignBtn = document.querySelector('.img-edit-align button[onclick*="' + (align || 'none') + '"]');
    if (alignBtn) alignBtn.classList.add('active');

    applyImgSize();
    document.getElementById('imgEditOverlay').classList.add('active');
}

function closeImgEdit() {
    document.getElementById('imgEditOverlay').classList.remove('active');
    editingImg = null;
}

function applyImgSize() {
    const size = document.getElementById('imgEditSize').value;
    const dimsEl = document.getElementById('imgEditDims');
    if (size === 'custom') {
        dimsEl.style.display = 'flex';
    } else {
        dimsEl.style.display = 'none';
        let w;
        if (size === 'full') w = imgOrigW;
        else if (size === 'large') w = Math.min(800, imgOrigW);
        else if (size === 'medium') w = Math.min(400, imgOrigW);
        else w = Math.min(200, imgOrigW);
        const ratio = imgOrigH / imgOrigW;
        document.getElementById('imgEditW').value = w;
        document.getElementById('imgEditH').value = Math.round(w * ratio);
    }
}

function imgKeepRatio(changed) {
    if (!imgOrigW || !imgOrigH) return;
    const ratio = imgOrigH / imgOrigW;
    if (changed === 'w') {
        document.getElementById('imgEditH').value = Math.round(document.getElementById('imgEditW').value * ratio);
    } else {
        document.getElementById('imgEditW').value = Math.round(document.getElementById('imgEditH').value / ratio);
    }
}

let currentImgAlign = 'none';
function setImgAlign(align, btn) {
    currentImgAlign = align;
    document.querySelectorAll('.img-edit-align button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function saveImgEdit() {
    if (!editingImg) return;

    // Alt text
    editingImg.alt = document.getElementById('imgEditAlt').value;

    // Caption
    const caption = document.getElementById('imgEditCaption').value;
    if (caption) editingImg.setAttribute('data-caption', caption);

    // Size
    const w = parseInt(document.getElementById('imgEditW').value);
    const h = parseInt(document.getElementById('imgEditH').value);
    if (w) editingImg.width = w;
    if (h) editingImg.height = h;

    // Alignment
    editingImg.style.float = '';
    editingImg.style.display = '';
    editingImg.style.marginLeft = '';
    editingImg.style.marginRight = '';
    if (currentImgAlign === 'left') {
        editingImg.style.float = 'left';
        editingImg.style.marginRight = '16px';
        editingImg.style.marginBottom = '8px';
    } else if (currentImgAlign === 'right') {
        editingImg.style.float = 'right';
        editingImg.style.marginLeft = '16px';
        editingImg.style.marginBottom = '8px';
    } else if (currentImgAlign === 'center') {
        editingImg.style.display = 'block';
        editingImg.style.marginLeft = 'auto';
        editingImg.style.marginRight = 'auto';
    }

    // CSS class
    editingImg.className = document.getElementById('imgEditClass').value || '';

    // Link
    const linkUrl = document.getElementById('imgEditLink').value.trim();
    if (linkUrl) {
        if (editingImg.parentElement.tagName !== 'A') {
            const a = document.createElement('a');
            a.href = linkUrl;
            a.target = '_blank';
            editingImg.parentElement.insertBefore(a, editingImg);
            a.appendChild(editingImg);
        } else {
            editingImg.parentElement.href = linkUrl;
        }
    } else if (editingImg.parentElement.tagName === 'A') {
        const a = editingImg.parentElement;
        a.parentElement.insertBefore(editingImg, a);
        a.remove();
    }

    resetAutoSave();
    closeImgEdit();
}

function deleteEditImg() {
    if (!editingImg) return;
    if (!confirm('Remove this image from the content?')) return;
    if (editingImg.parentElement.tagName === 'A') {
        editingImg.parentElement.remove();
    } else {
        editingImg.remove();
    }
    updateStats();
    resetAutoSave();
    closeImgEdit();
}

// Save initial snapshot after load for undo
setTimeout(() => saveUndoSnapshot(), 2000);

// Expose functions needed by HTML oninput/onclick attributes
window.autoSlug = autoSlug;
window.updateTopTitle = updateTopTitle;
window.checkSlugUnique = checkSlugUnique;
window.analyzeSEO = analyzeSEO;
window.updateCharCount = updateCharCount;
window.handleTagKey = handleTagKey;
window.renderTags = renderTags;
window.setTone = setTone;
window.showTab = showTab;
window.togglePreview = togglePreview;
window.savePost = savePost;
window.aiCmd = aiCmd;
window.insertAI = insertAI;
window.appendAI = appendAI;
window.undoChanges = undoChanges;
window.restoreRevision = restoreRevision;
window.updatePublishUI = updatePublishUI;
window.resetAutoSave = resetAutoSave;
window.toggleFocus = toggleFocus;
window.showShortcut = showShortcut;
window.markUnsaved = markUnsaved;
window.markSaved = markSaved;
window.importDocx = importDocx;
window.uploadAndInsertImages = uploadAndInsertImages;
window.handleFileAttach = handleFileAttach;
window.removeAiAttachment = removeAiAttachment;
window.handleFeatDrop = handleFeatDrop;
window.openImgEdit = openImgEdit;
window.closeImgEdit = closeImgEdit;
window.applyImgSize = applyImgSize;
window.imgKeepRatio = imgKeepRatio;
window.setImgAlign = setImgAlign;
window.saveImgEdit = saveImgEdit;
window.deleteEditImg = deleteEditImg;

}); // end waitForQuill
</script>

<script>
// Media Picker
var mpMedia = [];
(function() {
    var modal, bar, handle, isDragging=false, isResizing=false, startX, startY, startLeft, startTop, startW, startH;
    document.addEventListener('DOMContentLoaded', function() {
        modal = document.getElementById('mpModal');
        bar = document.getElementById('mpDragBar');
        handle = document.getElementById('mpResizeHandle');
        bar.addEventListener('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return;
            isDragging = true;
            var rect = modal.getBoundingClientRect();
            startX = e.clientX; startY = e.clientY; startLeft = rect.left; startTop = rect.top;
            modal.style.position = 'fixed'; modal.style.margin = '0';
            modal.style.left = startLeft + 'px'; modal.style.top = startTop + 'px';
            modal.style.maxWidth = rect.width + 'px'; e.preventDefault();
        });
        handle.addEventListener('mousedown', function(e) {
            isResizing = true;
            var rect = modal.getBoundingClientRect();
            startX = e.clientX; startY = e.clientY; startW = rect.width; startH = rect.height; e.preventDefault();
        });
        document.addEventListener('mousemove', function(e) {
            if (isDragging) { modal.style.left = Math.max(0, startLeft + e.clientX - startX) + 'px'; modal.style.top = Math.max(0, startTop + e.clientY - startY) + 'px'; }
            if (isResizing) { modal.style.width = Math.max(500, startW + e.clientX - startX) + 'px'; modal.style.maxWidth = modal.style.width; modal.style.height = Math.max(350, startH + e.clientY - startY) + 'px'; modal.style.maxHeight = modal.style.height; }
        });
        document.addEventListener('mouseup', function() { isDragging = false; isResizing = false; });
    });
    window.mpResetModal = function() { if (!modal) return; modal.style.position=''; modal.style.left=''; modal.style.top=''; modal.style.width=''; modal.style.height=''; modal.style.maxWidth='860px'; modal.style.maxHeight='85vh'; modal.style.margin=''; };
})();
var mpSelected = null;
function openMediaPicker() { if (window.mpResetModal) window.mpResetModal(); document.getElementById('mediaPicker').classList.add('active'); mpLoadMedia(); }
function closeMediaPicker() { document.getElementById('mediaPicker').classList.remove('active'); }
function mpSwitchTab(tab, btn) { document.querySelectorAll('.mp-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); document.getElementById('mpLibraryView').style.display = tab === 'library' ? '' : 'none'; document.getElementById('mpUploadView').style.display = tab === 'upload' ? '' : 'none'; if (tab === 'library') mpLoadMedia(); }
async function mpLoadMedia() { try { var r = await fetch('/api/media'); if (r.ok) mpMedia = await r.json(); } catch(e) { mpMedia = []; } mpRenderGrid(); }
function mpRenderGrid() {
    var grid = document.getElementById('mpGrid'), search = (document.getElementById('mpSearch').value || '').toLowerCase();
    var filtered = mpMedia.filter(function(m) { if (!m.mime_type || m.mime_type.indexOf('image') !== 0) return false; if (search && (m.original_name || '').toLowerCase().indexOf(search) === -1) return false; return true; });
    document.getElementById('mpFooterInfo').textContent = filtered.length + ' images';
    if (!filtered.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--gray-400)"><div style="font-size:2rem;margin-bottom:8px">üñº</div>No images found</div>'; return; }
    grid.innerHTML = filtered.map(function(m) {
        var sel = mpSelected && mpSelected.id === m.id ? ' selected' : '';
        return '<div class="mp-item' + sel + '" onclick="mpSelectItem(' + m.id + ')" data-id="' + m.id + '"><img src="' + (m.sizes && m.sizes.thumbnail ? m.sizes.thumbnail.url : m.url) + '" alt="' + (m.original_name||'') + '" onerror="this.style.display=\'none\';this.parentElement.innerHTML+=\'<div style=padding:20px;text-align:center;font-size:.7rem;color:var(--gray-400);word-break:break-all>\'+this.alt+\'</div>\'"></div>';
    }).join('');
}
function mpFilter() { mpRenderGrid(); }
function mpSelectItem(id) {
    var item = mpMedia.find(function(m) { return m.id === id; }); if (!item) return; mpSelected = item;
    document.querySelectorAll('.mp-item').forEach(function(el) { el.classList.toggle('selected', parseInt(el.dataset.id) === id); });
    document.getElementById('mpSidebar').classList.add('active');
    document.getElementById('mpSidebarImg').src = item.url;
    document.getElementById('mpSidebarName').textContent = item.original_name || item.filename || '';
    var size = item.size ? (item.size < 1048576 ? (item.size/1024).toFixed(0) + ' KB' : (item.size/1048576).toFixed(1) + ' MB') : '';
    var date = item.created_at ? new Date(item.created_at).toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'}) : '';
    var dims = (item.width && item.height) ? item.width + ' √ó ' + item.height + ' px' : '';
    document.getElementById('mpSidebarMeta').textContent = date + (size ? ' ¬∑ ' + size : '') + (dims ? ' ¬∑ ' + dims : '');
    document.getElementById('mpAltText').value = item.alt_text || '';
    document.getElementById('mpTitle').value = item.title || (item.original_name||'').replace(/\.[^.]+$/, '').replace(/[-_]/g, ' ');
    document.getElementById('mpCaption').value = item.caption || '';
    document.getElementById('mpFileUrl').value = window.location.origin + item.url;
    document.getElementById('mpSetBtn').disabled = false;
}
var mpSaveTimer = null;
function mpSaveMetadata() { clearTimeout(mpSaveTimer); mpSaveTimer = setTimeout(function() { if (!mpSelected) return; fetch('/api/media/' + mpSelected.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ alt_text: document.getElementById('mpAltText').value, title: document.getElementById('mpTitle').value, caption: document.getElementById('mpCaption').value }) }).then(function(r) { return r.json(); }).then(function(data) { if (mpSelected) { mpSelected.alt_text = data.alt_text; mpSelected.title = data.title; mpSelected.caption = data.caption; } }).catch(function() {}); }, 1000); }
function mpCopyUrl() { navigator.clipboard.writeText(document.getElementById('mpFileUrl').value).then(function() { var msg = document.getElementById('mpCopyMsg'); msg.style.display = 'block'; setTimeout(function(){ msg.style.display = 'none'; }, 2000); }).catch(function() { document.getElementById('mpFileUrl').select(); }); }
function mpSetFeaturedImage() { if (!mpSelected) return; document.getElementById('coverImage').value = mpSelected.url; document.getElementById('featImgPreview').src = mpSelected.url; document.getElementById('featImgPreview').style.display = 'block'; document.getElementById('featImgPreview').alt = document.getElementById('mpAltText').value || ''; document.getElementById('featImgEmpty').style.display = 'none'; document.getElementById('featImgActions').style.display = 'block'; document.getElementById('featImgName').textContent = mpSelected.original_name || 'Image'; closeMediaPicker(); }
function removeFeatImage() { document.getElementById('coverImage').value = ''; document.getElementById('featImgPreview').style.display = 'none'; document.getElementById('featImgPreview').src = ''; document.getElementById('featImgEmpty').style.display = ''; document.getElementById('featImgActions').style.display = 'none'; }
async function mpUploadFiles(input) { var files = input.files; if (!files.length) return; var prog = document.getElementById('mpUploadProgress'); prog.style.display = 'block'; for (var i = 0; i < files.length; i++) { prog.textContent = 'Uploading ' + (i+1) + ' of ' + files.length + '...'; var fd = new FormData(); fd.append('file', files[i]); try { await fetch('/api/media/upload', { method: 'POST', body: fd }); } catch(e) {} } prog.textContent = '‚úÖ Done!'; input.value = ''; setTimeout(function() { prog.style.display = 'none'; document.querySelectorAll('.mp-tab').forEach(function(t,i){ t.classList.toggle('active', i===0); }); document.getElementById('mpLibraryView').style.display = ''; document.getElementById('mpUploadView').style.display = 'none'; mpLoadMedia(); }, 800); }
(function(){ var zone = document.getElementById('mpUploadZone'); if (!zone) return; zone.addEventListener('click', function(e){ if(e.target.tagName!=='INPUT') document.getElementById('mpFileInput').click(); }); zone.addEventListener('dragover', function(e){ e.preventDefault(); zone.style.borderColor='var(--ginger)'; }); zone.addEventListener('dragleave', function(){ zone.style.borderColor=''; }); zone.addEventListener('drop', function(e){ e.preventDefault(); zone.style.borderColor=''; if(e.dataTransfer.files.length){document.getElementById('mpFileInput').files=e.dataTransfer.files; mpUploadFiles(document.getElementById('mpFileInput'));} }); })();
</script>
</body></html>
