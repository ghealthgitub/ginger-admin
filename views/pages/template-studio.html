<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Template Studio | Ginger Admin</title>
<link rel="stylesheet" href="/css/admin.css">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif}
.studio{display:flex;height:100vh;flex-direction:column}
.studio-topbar{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:48px;background:#0B2545;color:#fff;flex-shrink:0}
.studio-topbar__left{display:flex;align-items:center;gap:12px}
.studio-topbar__back{color:rgba(255,255,255,.7);text-decoration:none;font-size:.82rem;display:flex;align-items:center;gap:4px;padding:5px 12px;border-radius:6px;transition:all .2s}
.studio-topbar__back:hover{background:rgba(255,255,255,.1);color:#fff}
.studio-topbar__title{font-weight:600;font-size:.95rem}
.studio-topbar__right{display:flex;align-items:center;gap:8px}
.s-btn{padding:7px 16px;border-radius:7px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:flex;align-items:center;gap:5px}
.s-btn--save{background:#0EA5A0;color:#fff}.s-btn--save:hover{background:#0c918c}
.s-btn--view{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.15)}.s-btn--view:hover{background:rgba(255,255,255,.2)}
.s-saved{color:#34D399;font-weight:600;font-size:.8rem;display:none;align-items:center;gap:3px}
.studio-body{display:flex;flex:1;overflow:hidden}

/* LEFT PANEL */
.panel-left{width:42%;display:flex;flex-direction:column;overflow:hidden;background:#1e1e2e;min-width:320px}
.left-tabs{display:flex;background:#181825;border-bottom:1px solid #313244;flex-shrink:0}
.left-tab{flex:1;padding:8px;font-size:.78rem;font-weight:600;color:#6c7086;cursor:pointer;text-align:center;border:none;background:none;transition:all .2s}
.left-tab.active{color:#cdd6f4;background:#1e1e2e;border-bottom:2px solid #0EA5A0}
.left-tab:hover:not(.active){color:#a6adc8}

/* Mini toolbar */
.mini-toolbar{display:flex;align-items:center;gap:2px;padding:4px 12px;background:#11111b;border-bottom:1px solid #313244;flex-shrink:0;flex-wrap:wrap}
.mt-btn{padding:3px 7px;font-size:.72rem;background:none;border:1px solid transparent;border-radius:4px;color:#6c7086;cursor:pointer;transition:all .12s;font-family:inherit}
.mt-btn:hover{background:#313244;color:#cdd6f4;border-color:#45475a}
.mt-btn b{font-weight:800}
.mt-sep{width:1px;height:16px;background:#313244;margin:0 2px}
.mt-btn--img{color:#0EA5A0}

/* Code section */
.code-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}
.vars-bar{padding:5px 12px;background:#11111b;border-bottom:1px solid #313244;display:flex;align-items:center;gap:4px;flex-wrap:wrap;flex-shrink:0;overflow-x:auto}
.vars-bar::-webkit-scrollbar{height:2px}.vars-bar::-webkit-scrollbar-thumb{background:#313244}
.vars-bar__label{font-size:.68rem;color:#585b70;font-weight:600;margin-right:2px;white-space:nowrap}
.vt{display:inline-block;padding:2px 6px;font-size:.68rem;font-family:'Fira Code',monospace;background:#313244;color:#a6adc8;border-radius:3px;cursor:pointer;transition:all .12s;white-space:nowrap}
.vt:hover{background:#0EA5A0;color:#fff}
.code-wrap{flex:1;overflow:hidden;min-height:0}
.code-wrap textarea{width:100%;height:100%;background:#1e1e2e;color:#cdd6f4;font-family:'Fira Code','Consolas',monospace;font-size:.8rem;line-height:1.65;padding:12px 16px;border:none;outline:none;resize:none;tab-size:4}
.code-wrap textarea::selection{background:rgba(14,165,160,.3)}

/* Prompt section */
.prompt-area{display:flex;flex-direction:column;border-top:1px solid #313244;flex-shrink:0;background:#181825;min-height:220px;max-height:300px}
.prompt-header{padding:6px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #313244}
.prompt-header span{font-size:.78rem;font-weight:600;color:#a6adc8}
.prompt-header select{background:#313244;color:#cdd6f4;border:none;padding:3px 8px;border-radius:4px;font-size:.72rem;font-family:inherit}
.prompt-body{flex:1;display:flex;flex-direction:column;padding:8px 12px;gap:6px;overflow:hidden}
.prompt-input{flex:1;background:rgba(255,255,255,.04);border:1px solid #313244;border-radius:8px;padding:10px 12px;color:#cdd6f4;font-size:.82rem;font-family:inherit;resize:none;outline:none;line-height:1.5;min-height:80px}
.prompt-input:focus{border-color:#0EA5A0}
.prompt-input::placeholder{color:#45475a}
.prompt-bottom{display:flex;align-items:center;gap:6px;flex-shrink:0;flex-wrap:wrap}
.prompt-btn{padding:6px 14px;border-radius:6px;font-size:.78rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.prompt-btn--send{background:#0EA5A0;color:#fff}.prompt-btn--send:hover{background:#0c918c}
.prompt-btn--quick{background:#313244;color:#a6adc8;font-size:.72rem}.prompt-btn--quick:hover{background:#45475a;color:#cdd6f4}
.prompt-loading{color:#0EA5A0;font-size:.78rem;display:none;align-items:center;gap:6px}
.prompt-loading .spinner{width:14px;height:14px;border:2px solid #313244;border-top-color:#0EA5A0;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* File upload row */
.upload-row{display:flex;align-items:center;gap:6px;padding:0 0 4px;flex-shrink:0}
.upload-btn{display:flex;align-items:center;gap:4px;padding:5px 10px;background:#313244;border:1px dashed #45475a;border-radius:6px;color:#a6adc8;font-size:.72rem;cursor:pointer;transition:all .15s}
.upload-btn:hover{background:#45475a;border-color:#6c7086;color:#cdd6f4}
.upload-btn input{display:none}
.upload-status{font-size:.72rem;color:#585b70;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.upload-url{font-size:.68rem;color:#0EA5A0;background:#11111b;padding:3px 8px;border-radius:4px;cursor:pointer;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:none}
.upload-url:hover{background:#0EA5A0;color:#fff}

/* DRAG HANDLE */
.drag-handle{width:5px;background:#1e1e2e;cursor:col-resize;flex-shrink:0;transition:background .2s;position:relative}
.drag-handle:hover,.drag-handle.dragging{background:#0EA5A0}
.drag-handle::after{content:'\u22EE';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#585b70;font-size:10px}

/* RIGHT PANEL */
.panel-right{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#e5e7eb;min-width:300px}
.preview-bar{display:flex;align-items:center;justify-content:space-between;padding:6px 14px;background:#fff;border-bottom:1px solid #e5e7eb;flex-shrink:0}
.preview-bar__title{font-size:.8rem;font-weight:600;color:#0B2545;display:flex;align-items:center;gap:5px}
.preview-bar__devices{display:flex;gap:4px}
.pv-dev{padding:3px 8px;border:1px solid #e5e7eb;border-radius:5px;font-size:.72rem;cursor:pointer;background:#fff;color:#6b7280;transition:all .12s}
.pv-dev.active{background:#0B2545;color:#fff;border-color:#0B2545}
.preview-wrap{flex:1;overflow:auto;display:flex;justify-content:center;padding:0;background:#e5e7eb}
.preview-wrap iframe{background:#fff;border:none;width:100%;height:100%}
</style>
</head><body>
<div class="studio">
    <div class="studio-topbar">
        <div class="studio-topbar__left">
            <a href="/theme-templates" class="studio-topbar__back">&larr; Back</a>
            <span id="tplIcon"></span>
            <span class="studio-topbar__title" id="tplTitle">Template Studio</span>
        </div>
        <div class="studio-topbar__right">
            <span class="s-saved" id="savedMsg">&#x2705; Saved!</span>
            <button class="s-btn s-btn--view" onclick="toggleView()">&#x1F441; <span id="viewLabel">Split</span></button>
            <button class="s-btn s-btn--save" onclick="saveTemplate()">&#x1F4BE; Save</button>
        </div>
    </div>
    <div class="studio-body">
        <div class="panel-left" id="panelLeft">
            <div class="left-tabs">
                <button class="left-tab active" onclick="switchLeft('html',this)">HTML / EJS</button>
                <button class="left-tab" onclick="switchLeft('css',this)">Custom CSS</button>
            </div>

            <!-- MINI TOOLBAR for quick HTML inserts -->
            <div class="mini-toolbar" id="miniToolbar">
                <button class="mt-btn" onclick="wrapTag('strong')" title="Bold"><b>B</b></button>
                <button class="mt-btn" onclick="wrapTag('em')" title="Italic"><i>I</i></button>
                <button class="mt-btn" onclick="wrapTag('u')" title="Underline"><u>U</u></button>
                <span class="mt-sep"></span>
                <button class="mt-btn" onclick="insertTag('h2','Section Heading')" title="H2">H2</button>
                <button class="mt-btn" onclick="insertTag('h3','Sub Heading')" title="H3">H3</button>
                <button class="mt-btn" onclick="insertTag('p','Paragraph text here')" title="Paragraph">P</button>
                <span class="mt-sep"></span>
                <button class="mt-btn" onclick="insertLink()" title="Insert Link">&#x1F517;</button>
                <button class="mt-btn mt-btn--img" onclick="insertImage()" title="Insert Image">&#x1F5BC; Img</button>
                <button class="mt-btn" onclick="insertDiv('grid-3')" title="3-Column Grid">&#x25A6; Grid</button>
                <button class="mt-btn" onclick="insertDiv('info-card')" title="Info Card">&#x1F4CB; Card</button>
                <span class="mt-sep"></span>
                <button class="mt-btn" onclick="insertSnippet('hero')" title="Hero Section">&#x1F3A8; Hero</button>
                <button class="mt-btn" onclick="insertSnippet('cta')" title="CTA Section">&#x1F4E3; CTA</button>
            </div>

            <div class="code-area">
                <div class="vars-bar" id="varsBar"><span class="vars-bar__label">VARS:</span></div>
                <div class="code-wrap" id="codeWrap1"><textarea id="htmlEditor" spellcheck="false"></textarea></div>
                <div class="code-wrap" id="codeWrap2" style="display:none"><textarea id="cssEditor" placeholder="/* Custom CSS */" spellcheck="false"></textarea></div>
            </div>

            <!-- AI PROMPT + UPLOAD -->
            <div class="prompt-area">
                <div class="prompt-header">
                    <span>&#x1F916; AI Design Assistant</span>
                    <select id="aiTone">
                        <option value="designer">Designer</option>
                        <option value="medical">Medical Pro</option>
                        <option value="modern">Modern</option>
                    </select>
                </div>
                <div class="prompt-body">
                    <div class="upload-row">
                        <label class="upload-btn" id="uploadLabel">
                            &#x1F4CE; Upload Image
                            <input type="file" id="fileInput" accept="image/*" onchange="uploadFile(this)">
                        </label>
                        <span class="upload-status" id="uploadStatus">Upload an image to get its URL for the template</span>
                        <span class="upload-url" id="uploadUrl" onclick="copyUploadUrl()" title="Click to copy URL"></span>
                    </div>
                    <textarea class="prompt-input" id="promptInput" placeholder="Describe design changes... e.g.&#10;&#10;'Add a featured image banner below the hero with rounded corners'&#10;'Make headings bigger and add orange accent borders'&#10;'Create a 2-column layout with content on left and sidebar on right'"></textarea>
                    <div class="prompt-bottom">
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('beautify')">&#x2728; Beautify</button>
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('spacing')">&#x1F4D0; Spacing</button>
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('modern')">&#x1F3A8; Modern</button>
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('cta')">&#x1F4E3; CTA</button>
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('image')">&#x1F5BC; Add Image</button>
                        <div style="flex:1"></div>
                        <button class="prompt-btn prompt-btn--send" onclick="sendPrompt()" id="btnSend">&#x1F680; Apply</button>
                        <div class="prompt-loading" id="promptLoading"><div class="spinner"></div> Designing...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="drag-handle" id="dragHandle"></div>

        <div class="panel-right" id="panelRight">
            <div class="preview-bar">
                <div class="preview-bar__title">&#x1F441; Live Preview</div>
                <div class="preview-bar__devices">
                    <button class="pv-dev active" data-w="100%" onclick="setDev(this)">&#x1F5A5; Desktop</button>
                    <button class="pv-dev" data-w="768px" onclick="setDev(this)">&#x1F4F1; Tablet</button>
                    <button class="pv-dev" data-w="375px" onclick="setDev(this)">&#x1F4F1; Mobile</button>
                    <button class="pv-dev" onclick="renderPreview()">&#x1F504;</button>
                </div>
            </div>
            <div class="preview-wrap"><iframe id="previewFrame"></iframe></div>
        </div>
    </div>
</div>
<script>
var tplKey = window.location.pathname.split('/').pop();
var tplData = null, pvData = null, siteCSS = '', pvTimer = null, viewMode = 0, curTab = 'html';
var lastUploadUrl = '';

var TMETA = {
'blog-detail':{label:'Blog Post',icon:'\uD83D\uDCDD',cat:'detail',vars:'post.title,post.content,post.excerpt,post.author_name,post.read_time,post.category,post.cover_image,post.published_at'},
'destination-detail':{label:'Destination',icon:'\uD83C\uDF0D',cat:'detail',vars:'destination.name,destination.flag,destination.tagline,destination.description,destination.hospital_count,destination.doctor_count,destination.avg_savings,hospitals[],doctors[]'},
'specialty-detail':{label:'Specialty',icon:'\uD83C\uDFF7\uFE0F',cat:'detail',vars:'specialty.name,specialty.icon,specialty.description,specialty.long_description,treatments[]'},
'treatment-detail':{label:'Treatment',icon:'\uD83D\uDC8A',cat:'detail',vars:'treatment.name,treatment.description,treatment.long_description,treatment.cost_range_usd,treatment.duration,treatment.recovery_time,treatment.specialty_icon,costs[]'},
'hospital-detail':{label:'Hospital',icon:'\uD83C\uDFE5',cat:'detail',vars:'hospital.name,hospital.description,hospital.city,hospital.country,hospital.beds,hospital.established,hospital.rating,hospital.accreditations,doctors[]'},
'doctor-detail':{label:'Doctor',icon:'\uD83D\uDC68\u200D\u2695\uFE0F',cat:'detail',vars:'doctor.name,doctor.title,doctor.specialty,doctor.experience_years,doctor.description,doctor.qualifications,doctor.hospital_name,doctor.hospital_slug'},
'blog-list':{label:'Blog Listing',icon:'\uD83D\uDCDD',cat:'listing',vars:'posts[].title,posts[].slug,posts[].excerpt,posts[].category,posts[].read_time'},
'destinations-list':{label:'Destinations Listing',icon:'\uD83C\uDF0D',cat:'listing',vars:'destinations[].name,destinations[].slug,destinations[].flag'},
'specialties-list':{label:'Specialties Listing',icon:'\uD83C\uDFF7\uFE0F',cat:'listing',vars:'specialties[].name,specialties[].slug,specialties[].icon'},
'results':{label:'Testimonials',icon:'\u2B50',cat:'listing',vars:'testimonials[].patient_name,testimonials[].quote,testimonials[].rating,testimonials[].specialty,testimonials[].destination'},
'get-quote':{label:'Get Quote',icon:'\uD83D\uDCCB',cat:'page',vars:''},
'cost-calculator':{label:'Cost Calculator',icon:'\uD83E\uDDEE',cat:'page',vars:''},
'contact':{label:'Contact',icon:'\uD83D\uDCDE',cat:'page',vars:''}
};

var SITE_HEADER = '<div class="topbar"><div class="topbar__inner"><div class="topbar__contact"><a>\u2709 info@ginger.healthcare</a><a>\uD83D\uDCAC WhatsApp Us</a></div><div>\uD83C\uDF10 English</div></div></div><nav id="mainNav"><div class="nav__inner"><a href="/" class="logo"><div class="logo__icon">G</div><div class="logo__text"><span>Ginger</span> <span>Healthcare</span></div></a><div class="nav__links"><a class="nav__link">Destinations</a><a class="nav__link">Specialties</a><a class="nav__link">How It Works</a><a class="nav__link">Cost Calculator</a><a class="nav__link">Results</a><a class="nav__link nav__link--active">Blog</a></div><div class="nav__cta"><a class="btn btn--ghost" style="padding:10px 20px;font-size:.88rem">\uD83D\uDCDE Free Consult</a><a class="btn btn--primary">Get Free Quote</a></div></div></nav>';

var SITE_FOOTER = '<div class="section" style="padding-bottom:48px"><div class="final-cta"><div class="final-cta__bg"></div><div class="final-cta__orb1"></div><div class="final-cta__orb2"></div><div class="final-cta__inner"><h2>Your Health Deserves the <em>Best \u2014 Not the Most Expensive</em></h2><p>Join 5,000+ patients from 60+ countries who chose world-class care at a fraction of the cost.</p><div class="final-cta__btns"><a class="btn btn--primary btn--large">\uD83D\uDCCB Request an Estimate</a><a class="btn btn--white btn--large">\uD83D\uDCDE Speak to a Counselor</a></div><div class="final-cta__trust"><span>\uD83D\uDD12 100% Free</span><span>\uD83C\uDFE5 JCI Accredited</span><span>\uD83D\uDCDE 24/7 Support</span><span>\uD83E\uDD1D No Obligation</span></div></div></div></div><footer class="footer"><div class="footer__inner"><div class="footer__grid"><div class="footer__brand"><a class="logo"><div class="logo__icon">G</div><div class="logo__text"><span>Ginger</span> <span>Healthcare</span></div></a><p>Making world-class healthcare accessible to everyone.</p><div class="footer__social"><a>\uD83D\uDCD8</a><a>\uD83D\uDCF8</a><a>\uD83D\uDC26</a><a>\uD83D\uDCBC</a></div></div><div><div class="footer__col-title">Destinations</div><ul class="footer__links"><li><a>\uD83C\uDDEE\uD83C\uDDF3 India</a></li><li><a>\uD83C\uDDF9\uD83C\uDDF7 Turkey</a></li><li><a>\uD83C\uDDF9\uD83C\uDDED Thailand</a></li><li><a>\uD83C\uDDE6\uD83C\uDDEA UAE</a></li><li><a>\uD83C\uDDF8\uD83C\uDDEC Singapore</a></li></ul></div><div><div class="footer__col-title">Resources</div><ul class="footer__links"><li><a>How It Works</a></li><li><a>Cost Calculator</a></li><li><a>Blog</a></li><li><a>FAQ</a></li></ul></div><div><div class="footer__col-title">Company</div><ul class="footer__links"><li><a>About Us</a></li><li><a>Contact Us</a></li><li><a>Privacy Policy</a></li></ul></div></div><div class="footer__bottom"><span>\u00A9 2026 Ginger Healthcare. All rights reserved.</span></div></div></footer>';

// ===== INIT =====
async function init() {
    var meta = TMETA[tplKey];
    if (!meta) { document.body.innerHTML = '<h2 style="padding:40px">Unknown template: '+tplKey+'</h2>'; return; }
    document.getElementById('tplTitle').textContent = meta.label + ' Template';
    document.getElementById('tplIcon').textContent = meta.icon;
    document.title = meta.label + ' | Template Studio';

    if (meta.vars) {
        var vb = document.getElementById('varsBar');
        meta.vars.split(',').forEach(function(v) {
            var sp = document.createElement('span'); sp.className = 'vt';
            sp.textContent = '<%= ' + v.trim() + ' %>';
            sp.onclick = function() {
                var ta = document.getElementById('htmlEditor');
                var s = ta.selectionStart, tag = '<%= ' + v.trim() + ' %>';
                ta.value = ta.value.substring(0,s) + tag + ta.value.substring(ta.selectionEnd);
                ta.focus(); ta.selectionStart = ta.selectionEnd = s + tag.length;
                debouncePreview();
                sp.style.background = '#0EA5A0'; sp.style.color = '#fff';
                setTimeout(function(){sp.style.background='';sp.style.color=''},500);
            };
            vb.appendChild(sp);
        });
    }

    try { var r = await fetch('/api/theme-templates/'+tplKey); if (r.ok) { tplData = await r.json(); document.getElementById('htmlEditor').value = tplData.html_template||''; document.getElementById('cssEditor').value = tplData.css||''; }} catch(e){}

    if (!document.getElementById('htmlEditor').value) {
        try { var r2 = await fetch('/theme-templates'); if (r2.ok) { var h = await r2.text(); var m = h.match(/id="tpl-defaults"[^>]*>([\s\S]*?)<\/script>/); if (m) { var d = JSON.parse(m[1]); if(d[tplKey]) document.getElementById('htmlEditor').value = d[tplKey]; }}} catch(e){}
    }

    try { var r3 = await fetch('/api/theme-templates/preview-data/'+tplKey); if (r3.ok) pvData = await r3.json(); } catch(e){}

    try { var r4 = await fetch('/css/site-preview.css'); if (r4.ok) siteCSS = await r4.text(); } catch(e){}
    if (!siteCSS) { try { var r5 = await fetch('https://ginger.healthcare/css/style.css'); if (r5.ok) siteCSS = await r5.text(); } catch(e) { siteCSS = ':root{--navy:#0B2545;--ginger:#F26522;--teal:#0EA5A0;--font-display:"Playfair Display",serif;--font-body:"DM Sans",sans-serif}'; }}

    renderPreview();
    document.getElementById('htmlEditor').addEventListener('input', debouncePreview);
    document.getElementById('cssEditor').addEventListener('input', debouncePreview);
}

function debouncePreview() { clearTimeout(pvTimer); pvTimer = setTimeout(renderPreview, 500); }

// ===== MINI TOOLBAR =====
function getEditor() { return document.getElementById('htmlEditor'); }

function wrapTag(tag) {
    var ta = getEditor(), s = ta.selectionStart, e = ta.selectionEnd;
    var sel = ta.value.substring(s, e) || 'text';
    var wrapped = '<' + tag + '>' + sel + '</' + tag + '>';
    ta.value = ta.value.substring(0,s) + wrapped + ta.value.substring(e);
    ta.focus(); ta.selectionStart = s; ta.selectionEnd = s + wrapped.length;
    debouncePreview();
}

function insertTag(tag, placeholder) {
    var ta = getEditor(), s = ta.selectionStart;
    var sel = ta.value.substring(ta.selectionStart, ta.selectionEnd) || placeholder;
    var html = '\n<' + tag + '>' + sel + '</' + tag + '>\n';
    ta.value = ta.value.substring(0,s) + html + ta.value.substring(ta.selectionEnd);
    ta.focus(); ta.selectionStart = s + 1 + tag.length + 2; ta.selectionEnd = ta.selectionStart + sel.length;
    debouncePreview();
}

function insertLink() {
    var url = prompt('Enter URL:', 'https://');
    if (!url) return;
    var text = prompt('Link text:', 'Click here');
    var ta = getEditor(), s = ta.selectionStart;
    var html = '<a href="' + url + '" class="btn btn--primary">' + (text || 'Click here') + '</a>';
    ta.value = ta.value.substring(0,s) + html + ta.value.substring(ta.selectionEnd);
    ta.focus(); debouncePreview();
}

function insertImage() {
    var url = lastUploadUrl || prompt('Image URL:', 'https://');
    if (!url) return;
    var alt = prompt('Alt text:', 'Image');
    var ta = getEditor(), s = ta.selectionStart;
    var html = '\n<img src="' + url + '" alt="' + (alt||'Image') + '" style="width:100%;border-radius:12px;margin:16px 0;box-shadow:0 4px 16px rgba(0,0,0,.1)">\n';
    ta.value = ta.value.substring(0,s) + html + ta.value.substring(ta.selectionEnd);
    ta.focus(); debouncePreview();
}

function insertDiv(cls) {
    var ta = getEditor(), s = ta.selectionStart;
    var html = '';
    if (cls === 'grid-3') {
        html = '\n<div class="grid-3">\n    <div class="info-card"><div class="info-card__icon">\uD83C\uDFE5</div><div class="info-card__title">Title</div><div class="info-card__text">Description</div></div>\n    <div class="info-card"><div class="info-card__icon">\uD83D\uDC68\u200D\u2695\uFE0F</div><div class="info-card__title">Title</div><div class="info-card__text">Description</div></div>\n    <div class="info-card"><div class="info-card__icon">\u2B50</div><div class="info-card__title">Title</div><div class="info-card__text">Description</div></div>\n</div>\n';
    } else if (cls === 'info-card') {
        html = '\n<div class="info-card" style="text-align:center">\n    <div class="info-card__icon">\uD83C\uDFE5</div>\n    <div class="info-card__title">Card Title</div>\n    <div class="info-card__text">Card description text here</div>\n</div>\n';
    }
    ta.value = ta.value.substring(0,s) + html + ta.value.substring(ta.selectionEnd);
    ta.focus(); debouncePreview();
}

function insertSnippet(type) {
    var ta = getEditor(), s = ta.selectionStart, html = '';
    if (type === 'hero') {
        html = '\n<div class="page-hero">\n    <div class="page-hero__inner">\n        <div class="page-hero__breadcrumb"><a href="/">Home</a> \u2192 Page Title</div>\n        <h1><em>Page Title</em></h1>\n        <p>Page description goes here</p>\n    </div>\n</div>\n';
    } else if (type === 'cta') {
        html = '\n<div style="text-align:center;padding:40px 32px">\n    <h2 style="font-family:var(--font-display);color:var(--navy);margin-bottom:12px">Ready to Get Started?</h2>\n    <p style="color:var(--gray-500);margin-bottom:20px;max-width:500px;margin-left:auto;margin-right:auto">Take the first step towards affordable, world-class healthcare.</p>\n    <a href="/get-quote/" class="btn btn--primary btn--large">\uD83D\uDCCB Get Free Quote</a>\n</div>\n';
    }
    ta.value = ta.value.substring(0,s) + html + ta.value.substring(ta.selectionEnd);
    ta.focus(); debouncePreview();
}

// ===== FILE UPLOAD =====
async function uploadFile(input) {
    var file = input.files[0];
    if (!file) return;
    var status = document.getElementById('uploadStatus');
    var urlSpan = document.getElementById('uploadUrl');
    status.textContent = 'Uploading ' + file.name + '...';
    urlSpan.style.display = 'none';

    var fd = new FormData();
    fd.append('file', file);
    try {
        var r = await fetch('/api/media/upload', { method: 'POST', body: fd });
        if (r.ok) {
            var data = await r.json();
            lastUploadUrl = data.url;
            status.textContent = '\u2705 Uploaded! ';
            urlSpan.textContent = data.url;
            urlSpan.style.display = 'inline-block';
            // Also insert into prompt context
            document.getElementById('promptInput').value += (document.getElementById('promptInput').value ? '\n' : '') + 'Use this uploaded image: ' + data.url;
        } else {
            status.textContent = '\u274C Upload failed';
        }
    } catch(e) {
        status.textContent = '\u274C Error: ' + e.message;
    }
    input.value = '';
}

function copyUploadUrl() {
    navigator.clipboard.writeText(lastUploadUrl);
    var el = document.getElementById('uploadUrl');
    el.textContent = '\u2705 Copied!';
    setTimeout(function(){ el.textContent = lastUploadUrl; }, 1000);
}

// ===== PREVIEW =====
function renderPreview() {
    var ejs = document.getElementById('htmlEditor').value;
    var css = document.getElementById('cssEditor').value;
    var frame = document.getElementById('previewFrame');
    var body = processEJS(ejs);
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@500;600;700;800&display=swap" rel="stylesheet">';
    html += '<style>'+siteCSS+'</style>';
    if (css) html += '<style>'+css+'</style>';
    html += '</head><body>';
    html += SITE_HEADER + body + SITE_FOOTER;
    html += '</body></html>';
    frame.srcdoc = html;
}

function processEJS(ejs) {
    if (!pvData) return ejs.replace(/<%[\s\S]*?%>/g, '');
    var html = ejs;
    html = html.replace(/<%\s*(\w+)\.forEach\(\s*(?:\(?\s*(\w+)(?:\s*,\s*\w+)?\s*\)?\s*=>|function\s*\(\s*(\w+)\s*\))\s*\{?\s*%>([\s\S]*?)<%\s*\}?\);?\s*%>/g, function(m,arr,v1,v2,body){
        var v = v1||v2; var a = rv(pvData,arr);
        if (!Array.isArray(a)||!a.length) return '';
        return a.map(function(item){
            return body.replace(/<%[-=]\s*(\w+)\.([\w.]+)(?:\s*\|\|\s*([^%]*?))?\s*%>/g, function(mm,vn,prop,fb){
                if(vn===v) { var val=item[prop]; return val!==undefined&&val!==null?String(val):(fb?fb.trim().replace(/^['"]|['"]$/g,''):''); }
                return mm;
            });
        }).join('');
    });
    html = html.replace(/<%\s*if\s*\(([^)]+)\)\s*\{\s*%>([\s\S]*?)<%\s*\}\s*%>/g, function(m,cond,body){
        try {
            var c = cond.replace(/([\w]+(?:\.[\w]+)+)/g, function(p) {
                var v = rv(pvData,p); if(v===undefined) return 'undefined';
                if(typeof v==='string') return '"'+v.replace(/"/g,'\\"')+'"';
                if(Array.isArray(v)) return v.length; return String(v);
            });
            if (eval(c)) return body; return '';
        } catch(e) { return body; }
    });
    html = html.replace(/<%-\s*([\w.\[\]]+(?:\s*\|\|\s*[^%]*?)?)\s*%>/g, function(m,expr){
        var parts = expr.split('||'); var val = rv(pvData,parts[0].trim());
        if(val===undefined||val===null||val==='') val = parts[1]?parts[1].trim().replace(/^['"]|['"]$/g,''):'';
        return String(val);
    });
    html = html.replace(/<%=\s*([\w.\[\]]+(?:\s*\|\|\s*[^%]*?)?)\s*%>/g, function(m,expr){
        var parts = expr.split('||'); var val = rv(pvData,parts[0].trim());
        if(val===undefined||val===null||val==='') val = parts[1]?parts[1].trim().replace(/^['"]|['"]$/g,''):'';
        if(Array.isArray(val)) val = val.join(', ');
        return escH(String(val));
    });
    html = html.replace(/<%[\s\S]*?%>/g, '');
    return html;
}

function rv(obj,path) { var p=path.replace(/\[(\w+)\]/g,'.$1').split('.'),v=obj; for(var i=0;i<p.length;i++){if(v==null)return undefined;v=v[p[i]];} return v; }
function escH(s) { var d=document.createElement('div');d.textContent=s;return d.innerHTML; }

// ===== LEFT TABS =====
function switchLeft(tab, el) {
    curTab = tab;
    document.querySelectorAll('.left-tab').forEach(function(t){t.classList.remove('active')}); el.classList.add('active');
    document.getElementById('codeWrap1').style.display = tab==='html'?'':'none';
    document.getElementById('codeWrap2').style.display = tab==='css'?'':'none';
    document.getElementById('varsBar').style.display = tab==='html'?'':'none';
    document.getElementById('miniToolbar').style.display = tab==='html'?'':'none';
}

// ===== VIEW TOGGLE =====
function toggleView() {
    viewMode = (viewMode+1)%3;
    var pl=document.getElementById('panelLeft'),pr=document.getElementById('panelRight'),dh=document.getElementById('dragHandle'),lb=document.getElementById('viewLabel');
    pl.style.display=''; pr.style.display=''; dh.style.display=''; pl.style.width='42%';
    if(viewMode===1){pr.style.display='none';dh.style.display='none';pl.style.width='100%';lb.textContent='Preview'}
    else if(viewMode===2){pl.style.display='none';dh.style.display='none';lb.textContent='Code'}
    else{lb.textContent='Split'}
    if(viewMode!==1) renderPreview();
}

function setDev(el) {
    document.querySelectorAll('.pv-dev').forEach(function(d){d.classList.remove('active')}); el.classList.add('active');
    var w = el.getAttribute('data-w'); if(!w)return;
    var f = document.getElementById('previewFrame');
    f.style.width = w; f.style.maxWidth = '100%';
    if(w==='100%'){f.style.boxShadow='none';f.style.borderRadius='0';}
    else{f.style.boxShadow='0 4px 20px rgba(0,0,0,.15)';f.style.borderRadius='12px';f.style.margin='16px auto';f.style.height='calc(100% - 32px)';}
}

// ===== SAVE =====
async function saveTemplate() {
    var meta = TMETA[tplKey];
    try {
        var r = await fetch('/api/theme-templates/'+tplKey, { method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ label:meta.label, category:meta.cat||'detail', description:'', html_template:document.getElementById('htmlEditor').value, css:document.getElementById('cssEditor').value, is_active:true })
        });
        if(r.ok){ tplData=await r.json(); var m=document.getElementById('savedMsg');m.style.display='flex';setTimeout(function(){m.style.display='none'},3000); }
        else alert('Save failed');
    } catch(e){alert('Error: '+e.message);}
}

// ===== AI PROMPT =====
function quickPrompt(type) {
    var prompts = {
        beautify: 'Make this template more visually attractive with better typography, colors, spacing, and modern design elements. Keep the same structure but make it look professional and polished.',
        spacing: 'Fix the spacing in this template. Reduce excessive gaps between elements, tighten paragraph spacing, and ensure consistent padding throughout.',
        modern: 'Modernize this template with contemporary design patterns - subtle gradients, rounded corners, card-based layouts, and clean typography.',
        cta: 'Add a compelling call-to-action section at the bottom with a button to get a free quote.',
        image: 'Add a featured image section to this template. If there is a cover_image variable, show it as a full-width banner with rounded corners and shadow. If no image, show a gradient placeholder.'
    };
    document.getElementById('promptInput').value = prompts[type] || '';
    sendPrompt();
}

async function sendPrompt() {
    var prompt = document.getElementById('promptInput').value.trim();
    if (!prompt) return;
    var currentHTML = document.getElementById('htmlEditor').value;
    var meta = TMETA[tplKey];
    var btn = document.getElementById('btnSend');
    var loading = document.getElementById('promptLoading');
    btn.style.display = 'none'; loading.style.display = 'flex';

    try {
        var r = await fetch('/api/ai/generate', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                prompt: 'You are a web designer editing an EJS template for Ginger Healthcare (medical tourism). Template: ' + meta.label + ' pages.\n\nCurrent template:\n```\n' + currentHTML + '\n```\n\nAvailable EJS variables: ' + meta.vars + '\n\nUser request: ' + prompt + '\n\nRULES:\n1. Return ONLY the modified HTML/EJS code. No explanation, no markdown fences.\n2. Keep all EJS tags intact: <%= %>, <%- %>, <% if() {} %>, <% forEach() %>\n3. CSS classes: page-hero, page-hero__inner, page-hero__breadcrumb, section, grid-2/3/4, info-card, info-card__icon/title/text, content-section, blog-article, blog-cover, blog-meta, blog-author-card, btn, btn--primary, btn--large, btn--ghost\n4. CSS vars: var(--navy), var(--ginger), var(--teal), var(--gray-500), var(--font-display), var(--font-body), var(--cream)\n5. Make it visually impressive and professional',
                type: 'general'
            })
        });
        if (r.ok) {
            var data = await r.json();
            var result = (data.response || data.content || '').trim();
            result = result.replace(/^```(?:html|ejs)?\n?/,'').replace(/\n?```$/,'');
            if (result) { document.getElementById('htmlEditor').value = result; renderPreview(); }
        }
    } catch(e) { alert('AI error: ' + e.message); }
    btn.style.display = ''; loading.style.display = 'none';
    document.getElementById('promptInput').value = '';
}

// ===== DRAG HANDLE =====
(function(){
    var h=document.getElementById('dragHandle'),pl=document.getElementById('panelLeft'),d=false;
    h.addEventListener('mousedown',function(e){d=true;h.classList.add('dragging');e.preventDefault()});
    document.addEventListener('mousemove',function(e){if(!d)return;var p=(e.clientX/window.innerWidth)*100;p=Math.max(25,Math.min(70,p));pl.style.width=p+'%'});
    document.addEventListener('mouseup',function(){d=false;h.classList.remove('dragging')});
})();

// ===== TAB KEY =====
['htmlEditor','cssEditor'].forEach(function(id){
    document.getElementById(id).addEventListener('keydown',function(e){
        if(e.key==='Tab'){e.preventDefault();var s=this.selectionStart;this.value=this.value.substring(0,s)+'    '+this.value.substring(this.selectionEnd);this.selectionStart=this.selectionEnd=s+4;}
    });
});

document.addEventListener('keydown',function(e){if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveTemplate();}});

init();
</script>
</body></html>
