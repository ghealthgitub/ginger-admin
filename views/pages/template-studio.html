<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Template Studio | Ginger Admin</title>
<link rel="stylesheet" href="/css/admin.css">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif}
.studio{display:flex;height:100vh;flex-direction:column}
.studio-topbar{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:48px;background:#0B2545;color:#fff;flex-shrink:0}
.studio-topbar__left{display:flex;align-items:center;gap:12px}
.studio-topbar__back{color:rgba(255,255,255,.7);text-decoration:none;font-size:.82rem;display:flex;align-items:center;gap:4px;padding:5px 12px;border-radius:6px;transition:all .2s}
.studio-topbar__back:hover{background:rgba(255,255,255,.1);color:#fff}
.studio-topbar__title{font-weight:600;font-size:.95rem}
.studio-topbar__right{display:flex;align-items:center;gap:8px}
.s-btn{padding:7px 16px;border-radius:7px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:flex;align-items:center;gap:5px}
.s-btn--save{background:#0EA5A0;color:#fff}.s-btn--save:hover{background:#0c918c}
.s-btn--view{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.15)}.s-btn--view:hover{background:rgba(255,255,255,.2)}
.s-saved{color:#34D399;font-weight:600;font-size:.8rem;display:none;align-items:center;gap:3px}
.studio-body{display:flex;flex:1;overflow:hidden}

/* LEFT PANEL: Code + Prompt */
.panel-left{width:42%;display:flex;flex-direction:column;overflow:hidden;background:#1e1e2e;min-width:320px}
.left-tabs{display:flex;background:#181825;border-bottom:1px solid #313244;flex-shrink:0}
.left-tab{flex:1;padding:8px;font-size:.78rem;font-weight:600;color:#6c7086;cursor:pointer;text-align:center;border:none;background:none;transition:all .2s}
.left-tab.active{color:#cdd6f4;background:#1e1e2e;border-bottom:2px solid #0EA5A0}
.left-tab:hover:not(.active){color:#a6adc8}

/* Code section */
.code-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.vars-bar{padding:6px 12px;background:#11111b;border-bottom:1px solid #313244;display:flex;align-items:center;gap:4px;flex-wrap:wrap;flex-shrink:0;overflow-x:auto}
.vars-bar::-webkit-scrollbar{height:2px}.vars-bar::-webkit-scrollbar-thumb{background:#313244}
.vars-bar__label{font-size:.68rem;color:#585b70;font-weight:600;margin-right:2px;white-space:nowrap}
.vt{display:inline-block;padding:2px 6px;font-size:.68rem;font-family:'Fira Code',monospace;background:#313244;color:#a6adc8;border-radius:3px;cursor:pointer;transition:all .12s;white-space:nowrap}
.vt:hover{background:#0EA5A0;color:#fff}
.code-wrap{flex:1;overflow:hidden}
.code-wrap textarea{width:100%;height:100%;background:#1e1e2e;color:#cdd6f4;font-family:'Fira Code','Consolas',monospace;font-size:.8rem;line-height:1.65;padding:12px 16px;border:none;outline:none;resize:none;tab-size:4}
.code-wrap textarea::selection{background:rgba(14,165,160,.3)}

/* Prompt section */
.prompt-area{height:200px;display:flex;flex-direction:column;border-top:1px solid #313244;flex-shrink:0;background:#181825}
.prompt-header{padding:6px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #313244}
.prompt-header span{font-size:.78rem;font-weight:600;color:#a6adc8}
.prompt-header select{background:#313244;color:#cdd6f4;border:none;padding:3px 8px;border-radius:4px;font-size:.72rem;font-family:inherit}
.prompt-body{flex:1;display:flex;flex-direction:column;padding:8px 12px;gap:6px;overflow:hidden}
.prompt-input{flex:1;background:rgba(255,255,255,.04);border:1px solid #313244;border-radius:8px;padding:8px 12px;color:#cdd6f4;font-size:.82rem;font-family:inherit;resize:none;outline:none;line-height:1.5}
.prompt-input:focus{border-color:#0EA5A0}
.prompt-input::placeholder{color:#45475a}
.prompt-actions{display:flex;gap:6px;flex-shrink:0}
.prompt-btn{padding:6px 14px;border-radius:6px;font-size:.78rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.prompt-btn--send{background:#0EA5A0;color:#fff}.prompt-btn--send:hover{background:#0c918c}
.prompt-btn--quick{background:#313244;color:#a6adc8;font-size:.72rem}.prompt-btn--quick:hover{background:#45475a;color:#cdd6f4}
.prompt-loading{color:#0EA5A0;font-size:.78rem;display:none;align-items:center;gap:6px}
.prompt-loading .spinner{width:14px;height:14px;border:2px solid #313244;border-top-color:#0EA5A0;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* DRAG HANDLE */
.drag-handle{width:5px;background:#1e1e2e;cursor:col-resize;flex-shrink:0;transition:background .2s;position:relative}
.drag-handle:hover,.drag-handle.dragging{background:#0EA5A0}
.drag-handle::after{content:'\u22EE';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#585b70;font-size:10px}

/* RIGHT PANEL: Preview */
.panel-right{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#e5e7eb;min-width:300px}
.preview-bar{display:flex;align-items:center;justify-content:space-between;padding:6px 14px;background:#fff;border-bottom:1px solid #e5e7eb;flex-shrink:0}
.preview-bar__title{font-size:.8rem;font-weight:600;color:#0B2545;display:flex;align-items:center;gap:5px}
.preview-bar__devices{display:flex;gap:4px}
.pv-dev{padding:3px 8px;border:1px solid #e5e7eb;border-radius:5px;font-size:.72rem;cursor:pointer;background:#fff;color:#6b7280;transition:all .12s}
.pv-dev.active{background:#0B2545;color:#fff;border-color:#0B2545}
.preview-wrap{flex:1;overflow:auto;display:flex;justify-content:center;padding:0;background:#e5e7eb}
.preview-wrap iframe{background:#fff;border:none;width:100%;height:100%}
</style>
</head><body>
<div class="studio">
    <div class="studio-topbar">
        <div class="studio-topbar__left">
            <a href="/theme-templates" class="studio-topbar__back">‚Üê Back</a>
            <span id="tplIcon">üìÑ</span>
            <span class="studio-topbar__title" id="tplTitle">Template Studio</span>
        </div>
        <div class="studio-topbar__right">
            <span class="s-saved" id="savedMsg">‚úÖ Saved!</span>
            <button class="s-btn s-btn--view" onclick="toggleView()">üëÅÔ∏è <span id="viewLabel">Split</span></button>
            <button class="s-btn s-btn--save" onclick="saveTemplate()">üíæ Save</button>
        </div>
    </div>
    <div class="studio-body">
        <!-- LEFT: Code + Prompt -->
        <div class="panel-left" id="panelLeft">
            <div class="left-tabs">
                <button class="left-tab active" onclick="switchLeft('html',this)">HTML / EJS</button>
                <button class="left-tab" onclick="switchLeft('css',this)">Custom CSS</button>
            </div>
            <div class="code-area">
                <div class="vars-bar" id="varsBar"><span class="vars-bar__label">VARS:</span></div>
                <div class="code-wrap"><textarea id="htmlEditor" spellcheck="false"></textarea></div>
                <div class="code-wrap" style="display:none"><textarea id="cssEditor" placeholder="/* Custom CSS */" spellcheck="false"></textarea></div>
            </div>
            <!-- AI PROMPT -->
            <div class="prompt-area" id="promptArea">
                <div class="prompt-header">
                    <span>ü§ñ AI Design Assistant</span>
                    <select id="aiTone">
                        <option value="designer">Designer</option>
                        <option value="medical">Medical Professional</option>
                        <option value="modern">Modern/Minimal</option>
                    </select>
                </div>
                <div class="prompt-body">
                    <textarea class="prompt-input" id="promptInput" placeholder="Describe what you want to change... e.g. 'Make the hero section more modern with a gradient background' or 'Add a sidebar with doctor info'"></textarea>
                    <div class="prompt-actions">
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('beautify')">‚ú® Beautify</button>
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('spacing')">üìê Fix Spacing</button>
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('modern')">üé® Modernize</button>
                        <button class="prompt-btn prompt-btn--quick" onclick="quickPrompt('cta')">üîò Add CTA</button>
                        <button class="prompt-btn prompt-btn--send" onclick="sendPrompt()" id="btnSend">üöÄ Apply</button>
                        <div class="prompt-loading" id="promptLoading"><div class="spinner"></div> Designing...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="drag-handle" id="dragHandle"></div>
        <!-- RIGHT: Preview -->
        <div class="panel-right" id="panelRight">
            <div class="preview-bar">
                <div class="preview-bar__title">üëÅÔ∏è Live Preview</div>
                <div class="preview-bar__devices">
                    <button class="pv-dev active" data-w="100%" onclick="setDev(this)">üñ• Desktop</button>
                    <button class="pv-dev" data-w="768px" onclick="setDev(this)">üì± Tablet</button>
                    <button class="pv-dev" data-w="375px" onclick="setDev(this)">üì± Mobile</button>
                    <button class="pv-dev" onclick="renderPreview()">üîÑ</button>
                </div>
            </div>
            <div class="preview-wrap" id="previewWrap">
                <iframe id="previewFrame"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
var tplKey = window.location.pathname.split('/').pop();
var tplData = null;
var pvData = null;
var siteCSS = '';
var pvTimer = null;
var viewMode = 0; // 0=split, 1=code, 2=preview
var curTab = 'html';

var TMETA = {
'blog-detail':{label:'Blog Post',icon:'\uD83D\uDCDD',cat:'detail',vars:'post.title,post.content,post.excerpt,post.author_name,post.read_time,post.category,post.cover_image'},
'destination-detail':{label:'Destination',icon:'\uD83C\uDF0D',cat:'detail',vars:'destination.name,destination.flag,destination.tagline,destination.description,destination.hospital_count,destination.doctor_count,destination.avg_savings,hospitals[],doctors[]'},
'specialty-detail':{label:'Specialty',icon:'\uD83C\uDFF7\uFE0F',cat:'detail',vars:'specialty.name,specialty.icon,specialty.description,specialty.long_description,treatments[]'},
'treatment-detail':{label:'Treatment',icon:'\uD83D\uDC8A',cat:'detail',vars:'treatment.name,treatment.description,treatment.long_description,treatment.cost_range_usd,treatment.duration,treatment.recovery_time,treatment.specialty_icon,costs[]'},
'hospital-detail':{label:'Hospital',icon:'\uD83C\uDFE5',cat:'detail',vars:'hospital.name,hospital.description,hospital.city,hospital.country,hospital.beds,hospital.established,hospital.rating,hospital.accreditations,doctors[]'},
'doctor-detail':{label:'Doctor',icon:'\uD83D\uDC68\u200D\u2695\uFE0F',cat:'detail',vars:'doctor.name,doctor.title,doctor.specialty,doctor.experience_years,doctor.description,doctor.qualifications,doctor.hospital_name,doctor.hospital_slug'},
'blog-list':{label:'Blog Listing',icon:'\uD83D\uDCDD',cat:'listing',vars:'posts[].title,posts[].slug,posts[].excerpt,posts[].category,posts[].read_time'},
'destinations-list':{label:'Destinations Listing',icon:'\uD83C\uDF0D',cat:'listing',vars:'destinations[].name,destinations[].slug,destinations[].flag'},
'specialties-list':{label:'Specialties Listing',icon:'\uD83C\uDFF7\uFE0F',cat:'listing',vars:'specialties[].name,specialties[].slug,specialties[].icon'},
'results':{label:'Testimonials',icon:'\u2B50',cat:'listing',vars:'testimonials[].patient_name,testimonials[].quote,testimonials[].rating,testimonials[].specialty,testimonials[].destination'},
'get-quote':{label:'Get Quote',icon:'\uD83D\uDCCB',cat:'page',vars:''},
'cost-calculator':{label:'Cost Calculator',icon:'\uD83E\uDDEE',cat:'page',vars:''},
'contact':{label:'Contact',icon:'\uD83D\uDCDE',cat:'page',vars:''}
};

// Static header/footer HTML for preview
var SITE_HEADER = '<div class="topbar"><div class="topbar__inner"><div class="topbar__contact"><a>‚úâ info@ginger.healthcare</a><a>üí¨ WhatsApp Us</a></div><div>üåê English</div></div></div><nav id="mainNav"><div class="nav__inner"><a href="/" class="logo"><div class="logo__icon">G</div><div class="logo__text"><span>Ginger</span> <span>Healthcare</span></div></a><div class="nav__links"><a class="nav__link">Destinations</a><a class="nav__link">Specialties</a><a class="nav__link">How It Works</a><a class="nav__link">Cost Calculator</a><a class="nav__link">Results</a><a class="nav__link nav__link--active">Blog</a></div><div class="nav__cta"><a class="btn btn--ghost" style="padding:10px 20px;font-size:.88rem">üìû Free Consult</a><a class="btn btn--primary">Get Free Quote</a></div></div></nav>';

var SITE_FOOTER = '<div class="section" style="padding-bottom:48px"><div class="final-cta"><div class="final-cta__bg"></div><div class="final-cta__orb1"></div><div class="final-cta__orb2"></div><div class="final-cta__inner"><h2>Your Health Deserves the <em>Best ‚Äî Not the Most Expensive</em></h2><p>Join 5,000+ patients from 60+ countries who chose world-class care at a fraction of the cost.</p><div class="final-cta__btns"><a class="btn btn--primary btn--large">üìã Request an Estimate</a><a class="btn btn--white btn--large">üìû Speak to a Counselor</a></div><div class="final-cta__trust"><span>üîí 100% Free</span><span>üè• JCI Accredited</span><span>üìû 24/7 Support</span><span>ü§ù No Obligation</span></div></div></div></div><footer class="footer"><div class="footer__inner"><div class="footer__grid"><div class="footer__brand"><a class="logo"><div class="logo__icon">G</div><div class="logo__text"><span>Ginger</span> <span>Healthcare</span></div></a><p>Making world-class healthcare accessible to everyone.</p><div class="footer__social"><a>üìò</a><a>üì∏</a><a>üê¶</a><a>üíº</a></div></div><div><div class="footer__col-title">Destinations</div><ul class="footer__links"><li><a>üáÆüá≥ India</a></li><li><a>üáπüá∑ Turkey</a></li><li><a>üáπüá≠ Thailand</a></li><li><a>üá¶üá™ UAE</a></li><li><a>üá∏üá¨ Singapore</a></li></ul></div><div><div class="footer__col-title">Resources</div><ul class="footer__links"><li><a>How It Works</a></li><li><a>Cost Calculator</a></li><li><a>Blog</a></li><li><a>FAQ</a></li></ul></div><div><div class="footer__col-title">Company</div><ul class="footer__links"><li><a>About Us</a></li><li><a>Contact Us</a></li><li><a>Privacy Policy</a></li></ul></div></div><div class="footer__bottom"><span>&copy; 2026 Ginger Healthcare. All rights reserved.</span></div></div></footer>';

async function init() {
    var meta = TMETA[tplKey];
    if (!meta) { document.body.innerHTML = '<h2 style="padding:40px">Unknown template: '+tplKey+'</h2>'; return; }
    document.getElementById('tplTitle').textContent = meta.label + ' Template';
    document.getElementById('tplIcon').textContent = meta.icon;
    document.title = meta.label + ' | Template Studio';

    // Build vars bar
    if (meta.vars) {
        var vb = document.getElementById('varsBar');
        meta.vars.split(',').forEach(function(v) {
            var sp = document.createElement('span'); sp.className = 'vt';
            sp.textContent = '<%= ' + v.trim() + ' %>';
            sp.onclick = function() {
                var ta = document.getElementById('htmlEditor');
                var s = ta.selectionStart;
                var tag = '<%= ' + v.trim() + ' %>';
                ta.value = ta.value.substring(0,s) + tag + ta.value.substring(ta.selectionEnd);
                ta.focus(); ta.selectionStart = ta.selectionEnd = s + tag.length;
                sp.style.background = '#0EA5A0'; sp.style.color = '#fff';
                setTimeout(function(){sp.style.background='';sp.style.color=''},500);
            };
            vb.appendChild(sp);
        });
    }

    // Load saved template
    try { var r = await fetch('/api/theme-templates/'+tplKey); if (r.ok) { tplData = await r.json(); document.getElementById('htmlEditor').value = tplData.html_template||''; document.getElementById('cssEditor').value = tplData.css||''; }} catch(e){}

    // If no saved, load default
    if (!document.getElementById('htmlEditor').value) {
        try { var r2 = await fetch('/theme-templates'); if (r2.ok) { var h = await r2.text(); var m = h.match(/id="tpl-defaults"[^>]*>([\s\S]*?)<\/script>/); if (m) { var d = JSON.parse(m[1]); if(d[tplKey]) document.getElementById('htmlEditor').value = d[tplKey]; }}} catch(e){}
    }

    // Load preview data
    try { var r3 = await fetch('/api/theme-templates/preview-data/'+tplKey); if (r3.ok) pvData = await r3.json(); } catch(e){}

    // Load site CSS
    try { var r4 = await fetch('/css/site-preview.css'); if (r4.ok) siteCSS = await r4.text(); } catch(e){}
    if (!siteCSS) {
        // Fallback: fetch from live site
        try { var r5 = await fetch('https://ginger.healthcare/css/style.css'); if (r5.ok) siteCSS = await r5.text(); } catch(e) {
            siteCSS = ':root{--navy:#0B2545;--ginger:#F26522;--teal:#0EA5A0;--font-display:"Playfair Display",serif;--font-body:"DM Sans",sans-serif}';
        }
    }

    renderPreview();
    document.getElementById('htmlEditor').addEventListener('input', debouncePreview);
    document.getElementById('cssEditor').addEventListener('input', debouncePreview);
}

function debouncePreview() { clearTimeout(pvTimer); pvTimer = setTimeout(renderPreview, 500); }

function renderPreview() {
    var ejs = document.getElementById('htmlEditor').value;
    var css = document.getElementById('cssEditor').value;
    var frame = document.getElementById('previewFrame');
    var body = processEJS(ejs);
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@500;600;700;800&display=swap" rel="stylesheet">';
    html += '<style>'+siteCSS+'</style>';
    if (css) html += '<style>'+css+'</style>';
    html += '</head><body>';
    html += SITE_HEADER;
    html += body;
    html += SITE_FOOTER;
    html += '</body></html>';
    frame.srcdoc = html;
}

function processEJS(ejs) {
    if (!pvData) return ejs.replace(/<%[\s\S]*?%>/g, '');
    var html = ejs;
    // forEach loops
    html = html.replace(/<%\s*(\w+)\.forEach\(\s*(?:\(?\s*(\w+)(?:\s*,\s*\w+)?\s*\)?\s*=>|function\s*\(\s*(\w+)\s*\))\s*\{?\s*%>([\s\S]*?)<%\s*\}?\);?\s*%>/g, function(m,arr,v1,v2,body){
        var v = v1||v2; var a = rv(pvData,arr);
        if (!Array.isArray(a)||!a.length) return '';
        return a.map(function(item){
            return body.replace(/<%[-=]\s*(\w+)\.([\w.]+)(?:\s*\|\|\s*([^%]*?))?\s*%>/g, function(mm,vn,prop,fb){
                if(vn===v) { var val=item[prop]; return val!==undefined&&val!==null?String(val):(fb?fb.trim().replace(/^['"]|['"]$/g,''):''); }
                return mm;
            });
        }).join('');
    });
    // if blocks
    html = html.replace(/<%\s*if\s*\(([^)]+)\)\s*\{\s*%>([\s\S]*?)<%\s*\}\s*%>/g, function(m,cond,body){
        try {
            var c = cond.replace(/([\w]+(?:\.[\w]+)+)/g, function(p) {
                var v = rv(pvData,p); if(v===undefined) return 'undefined';
                if(typeof v==='string') return '"'+v.replace(/"/g,'\\"')+'"';
                if(Array.isArray(v)) return v.length; return String(v);
            });
            if (eval(c)) return body; return '';
        } catch(e) { return body; }
    });
    // <%- unescaped %>
    html = html.replace(/<%-\s*([\w.[\]]+(?:\s*\|\|\s*[^%]*?)?)\s*%>/g, function(m,expr){
        var parts = expr.split('||'); var val = rv(pvData,parts[0].trim());
        if(val===undefined||val===null) val = parts[1]?parts[1].trim().replace(/^['"]|['"]$/g,''):'';
        return String(val);
    });
    // <%= escaped %>
    html = html.replace(/<%=\s*([\w.[\]]+(?:\s*\|\|\s*[^%]*?)?)\s*%>/g, function(m,expr){
        var parts = expr.split('||'); var val = rv(pvData,parts[0].trim());
        if(val===undefined||val===null) val = parts[1]?parts[1].trim().replace(/^['"]|['"]$/g,''):'';
        if(Array.isArray(val)) val = val.join(', ');
        return escH(String(val));
    });
    // Clean remaining EJS
    html = html.replace(/<%[\s\S]*?%>/g, '');
    return html;
}

function rv(obj,path) { var p=path.replace(/\[(\w+)\]/g,'.$1').split('.'),v=obj; for(var i=0;i<p.length;i++){if(v==null)return undefined;v=v[p[i]];} return v; }
function escH(s) { var d=document.createElement('div');d.textContent=s;return d.innerHTML; }

// ===== LEFT PANEL TABS =====
function switchLeft(tab, el) {
    curTab = tab;
    document.querySelectorAll('.left-tab').forEach(function(t){t.classList.remove('active')}); el.classList.add('active');
    var wraps = document.querySelectorAll('.code-wrap');
    wraps[0].style.display = tab==='html'?'':'none';
    wraps[1].style.display = tab==='css'?'':'none';
    document.getElementById('varsBar').style.display = tab==='html'?'':'none';
}

// ===== VIEW TOGGLE =====
function toggleView() {
    viewMode = (viewMode+1)%3;
    var pl=document.getElementById('panelLeft'),pr=document.getElementById('panelRight'),dh=document.getElementById('dragHandle'),lb=document.getElementById('viewLabel');
    pl.style.display=''; pr.style.display=''; dh.style.display=''; pl.style.width='42%';
    if(viewMode===1){pr.style.display='none';dh.style.display='none';pl.style.width='100%';lb.textContent='Preview'}
    else if(viewMode===2){pl.style.display='none';dh.style.display='none';lb.textContent='Code'}
    else{lb.textContent='Split'}
    if(viewMode!==1) renderPreview();
}

// ===== DEVICE PREVIEW =====
function setDev(el) {
    document.querySelectorAll('.pv-dev').forEach(function(d){d.classList.remove('active')}); el.classList.add('active');
    var w = el.getAttribute('data-w'); if(!w)return;
    var f = document.getElementById('previewFrame');
    f.style.width = w; f.style.maxWidth = '100%';
    if(w==='100%'){f.style.boxShadow='none';f.style.borderRadius='0';}
    else{f.style.boxShadow='0 4px 20px rgba(0,0,0,.15)';f.style.borderRadius='12px';f.style.margin='16px auto';f.style.height='calc(100% - 32px)';}
}

// ===== SAVE =====
async function saveTemplate() {
    var meta = TMETA[tplKey];
    try {
        var r = await fetch('/api/theme-templates/'+tplKey, { method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ label:meta.label, category:meta.cat||'detail', description:'', html_template:document.getElementById('htmlEditor').value, css:document.getElementById('cssEditor').value, is_active:true })
        });
        if(r.ok){ tplData=await r.json(); var m=document.getElementById('savedMsg');m.style.display='flex';setTimeout(function(){m.style.display='none'},3000); }
        else alert('Save failed');
    } catch(e){alert('Error: '+e.message);}
}

// ===== AI PROMPT =====
function quickPrompt(type) {
    var prompts = {
        beautify: 'Make this template more visually attractive with better typography, colors, spacing, and modern design elements. Keep the same structure but make it look professional and polished.',
        spacing: 'Fix the spacing in this template. Reduce excessive gaps between elements, tighten paragraph spacing, and ensure consistent padding throughout.',
        modern: 'Modernize this template with contemporary design patterns - subtle gradients, rounded corners, card-based layouts, and clean typography.',
        cta: 'Add a compelling call-to-action section at the bottom of this template with a button to get a free quote.'
    };
    document.getElementById('promptInput').value = prompts[type] || '';
    sendPrompt();
}

async function sendPrompt() {
    var prompt = document.getElementById('promptInput').value.trim();
    if (!prompt) return;
    var currentHTML = document.getElementById('htmlEditor').value;
    var meta = TMETA[tplKey];
    var btn = document.getElementById('btnSend');
    var loading = document.getElementById('promptLoading');
    btn.style.display = 'none'; loading.style.display = 'flex';

    try {
        var r = await fetch('/api/ai/generate', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                prompt: 'You are a web designer editing an EJS template for a medical tourism website called Ginger Healthcare. The template is for: ' + meta.label + ' pages.\n\nCurrent template:\n```\n' + currentHTML + '\n```\n\nAvailable variables (EJS syntax): ' + meta.vars + '\n\nUser request: ' + prompt + '\n\nIMPORTANT RULES:\n1. Return ONLY the updated HTML/EJS template code, no explanations\n2. Keep all EJS tags like <%= variable %>, <%- variable %>, <% if() {} %>, <% array.forEach() %> intact\n3. Use CSS classes from the site: page-hero, section, grid-3, grid-4, info-card, info-card__icon, info-card__title, info-card__text, content-section, btn, btn--primary, btn--large, etc.\n4. Use CSS variables: var(--navy), var(--ginger), var(--teal), var(--gray-500), var(--font-display), var(--font-body), var(--radius-lg), var(--shadow-md)\n5. Make it visually impressive and professional\n6. Ensure proper responsive design\n\nReturn ONLY the template code:'
            })
        });
        if (r.ok) {
            var data = await r.json();
            var result = (data.response || data.content || '').trim();
            // Clean markdown code fences if present
            result = result.replace(/^```(?:html|ejs)?\n?/,'').replace(/\n?```$/,'');
            if (result) {
                document.getElementById('htmlEditor').value = result;
                renderPreview();
            }
        }
    } catch(e) { alert('AI error: ' + e.message); }
    btn.style.display = ''; loading.style.display = 'none';
}

// ===== DRAG HANDLE =====
(function(){
    var h=document.getElementById('dragHandle'),pl=document.getElementById('panelLeft'),dragging=false;
    h.addEventListener('mousedown',function(e){dragging=true;h.classList.add('dragging');e.preventDefault()});
    document.addEventListener('mousemove',function(e){if(!dragging)return;var p=(e.clientX/window.innerWidth)*100;p=Math.max(25,Math.min(70,p));pl.style.width=p+'%'});
    document.addEventListener('mouseup',function(){dragging=false;h.classList.remove('dragging')});
})();

// ===== TAB KEY =====
['htmlEditor','cssEditor'].forEach(function(id){
    document.getElementById(id).addEventListener('keydown',function(e){
        if(e.key==='Tab'){e.preventDefault();var s=this.selectionStart;this.value=this.value.substring(0,s)+'    '+this.value.substring(this.selectionEnd);this.selectionStart=this.selectionEnd=s+4;}
    });
});

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown',function(e){if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveTemplate();}});

init();
</script>
</body></html>
