<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Videos | Ginger Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/admin.css">
<style>
:root{--navy:#0B2545;--teal:#0EA5A0;--ginger:#F26522;--gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;--gray-400:#9CA3AF;--gray-500:#6B7280;--gray-600:#4B5563}
.status-tabs{display:flex;gap:4px;margin-bottom:16px;font-size:.85rem}
.status-tab{padding:4px 0;color:var(--gray-500);cursor:pointer;border:none;background:none;font-family:inherit;font-size:.85rem;transition:color .2s}
.status-tab:hover{color:var(--navy)}.status-tab.active{color:var(--navy);font-weight:700}
.status-tab .count{color:var(--gray-400);font-weight:400}.status-tab.active .count{color:var(--teal)}.tab-sep{color:var(--gray-300);padding:0 6px;user-select:none}
.toolbar{display:flex;gap:10px;margin-bottom:14px;align-items:center;flex-wrap:wrap}
.bulk-bar{display:flex;gap:8px;align-items:center}
.bulk-bar select{padding:5px 10px;border:1px solid var(--gray-300);border-radius:5px;font-size:.82rem;font-family:inherit;background:#fff}
.bulk-bar .btn-apply{padding:5px 14px;border:1px solid var(--gray-300);border-radius:5px;font-size:.82rem;cursor:pointer;background:var(--gray-50);font-family:inherit;font-weight:600;color:var(--gray-600);transition:all .2s}
.bulk-bar .btn-apply:hover{background:var(--teal);color:#fff;border-color:var(--teal)}
.filter-group select{padding:5px 10px;border:1px solid var(--gray-300);border-radius:5px;font-size:.82rem;font-family:inherit;background:#fff}
.search-wrap{flex:1;max-width:260px;position:relative}
.search-wrap input{width:100%;padding:6px 10px 6px 30px;border:1px solid var(--gray-300);border-radius:5px;font-size:.82rem;font-family:inherit}
.search-wrap input:focus{outline:none;border-color:var(--teal)}
.search-wrap::before{content:'üîç';position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:.75rem}
.pagination-info{margin-left:auto;font-size:.82rem;color:var(--gray-500);display:flex;align-items:center;gap:8px}
.pagination-info select{padding:3px 6px;border:1px solid var(--gray-200);border-radius:4px;font-size:.78rem;font-family:inherit}
.pag-btn{padding:3px 8px;border:1px solid var(--gray-200);border-radius:4px;cursor:pointer;background:#fff;font-size:.78rem;font-family:inherit;color:var(--gray-500)}
.pag-btn:hover:not(:disabled){background:var(--teal);color:#fff;border-color:var(--teal)}
.pag-btn:disabled{opacity:.4;cursor:not-allowed}
.selected-bar{background:rgba(14,165,160,.06);border:1px solid rgba(14,165,160,.2);border-radius:6px;padding:8px 14px;margin-bottom:10px;display:none;align-items:center;gap:12px;font-size:.82rem;color:var(--teal);font-weight:600}
.selected-bar .btn-clear{background:none;border:none;color:var(--gray-400);cursor:pointer;font-size:.78rem;font-family:inherit;text-decoration:underline}
.data-table{width:100%;border-collapse:collapse}
.data-table th{font-size:.72rem;text-transform:uppercase;letter-spacing:.5px;color:var(--gray-500);font-weight:700;padding:8px 10px;border-bottom:2px solid var(--gray-200);text-align:left;white-space:nowrap;cursor:pointer;user-select:none}
.data-table th:hover{color:var(--navy)}.data-table th .sort-icon{font-size:.6rem;margin-left:3px;opacity:.4}
.data-table th.sorted .sort-icon{opacity:1;color:var(--teal)}
.data-table td{padding:8px 10px;border-bottom:1px solid var(--gray-100);font-size:.85rem;vertical-align:middle}
.data-table tr:hover td{background:var(--gray-50)}.data-table tr.selected td{background:rgba(14,165,160,.04)}
.cb-cell{width:36px;text-align:center}.cb-cell input{width:15px;height:15px;cursor:pointer;accent-color:var(--teal)}
.vid-thumb{width:80px;height:48px;border-radius:5px;object-fit:cover;background:var(--gray-100);display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--gray-300);overflow:hidden;flex-shrink:0;position:relative}
.vid-thumb img{width:100%;height:100%;object-fit:cover}
.vid-thumb__play{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);opacity:0;transition:opacity .2s}.vid-thumb:hover .vid-thumb__play{opacity:1}
.vid-thumb__play svg{width:18px;height:18px;fill:#fff}
.post-title-cell{min-width:180px}
.post-title-cell strong{display:block;color:var(--navy);font-size:.88rem;line-height:1.3}
.post-title-cell strong a{color:inherit;text-decoration:none}.post-title-cell strong a:hover{color:var(--teal)}
.post-title-cell .post-slug{font-size:.7rem;color:var(--gray-400);font-family:'DM Sans',monospace;margin-top:1px}
.row-actions{display:flex;gap:4px;margin-top:4px;opacity:0;transition:opacity .15s}
tr:hover .row-actions{opacity:1}
.row-actions a,.row-actions button{font-size:.72rem;padding:2px 7px;border-radius:3px;cursor:pointer;font-family:inherit;text-decoration:none;border:none;background:none;color:var(--gray-500)}
.row-actions a:hover,.row-actions button:hover{color:var(--teal)}
.row-actions .act-del{color:#EF4444}.row-actions .act-del:hover{color:#DC2626;text-decoration:underline}
.row-actions .sep{color:var(--gray-300)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.72rem;font-weight:600}
.badge--published{background:#D1FAE5;color:#059669}.badge--draft{background:#FEF3C7;color:#D97706}
.tag-pill{display:inline-block;padding:1px 7px;border-radius:8px;font-size:.7rem;font-weight:500;margin:1px}
.tag-pill--spec{background:rgba(242,101,34,.06);color:var(--ginger)}.tag-pill--doc{background:rgba(14,165,160,.06);color:var(--teal)}
.tag-pill--hosp{background:rgba(11,37,69,.05);color:var(--navy)}.tag-pill--treat{background:var(--gray-100);color:var(--gray-600)}
.featured-star{color:#F59E0B;font-size:.9rem}
.date-cell{font-size:.78rem;color:var(--gray-500);white-space:nowrap}.date-cell .date-sub{font-size:.7rem;color:var(--gray-400)}
.quick-edit-row td{background:#F0F5FF!important;border-top:2px solid var(--teal)!important;border-bottom:2px solid var(--teal)!important}
.quick-edit{padding:16px 20px}
.quick-edit__title{font-size:.78rem;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--teal)}
.quick-edit__grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.quick-edit .form-group{margin-bottom:0}
.quick-edit .form-label{font-size:.75rem;font-weight:700;margin-bottom:3px;color:var(--navy);display:block}
.quick-edit .form-input,.quick-edit .form-select,.quick-edit .form-textarea{font-size:.82rem;padding:6px 10px;background:#fff;border:1.5px solid var(--gray-300);border-radius:5px;width:100%;font-family:inherit;box-sizing:border-box}
.quick-edit .form-input:focus,.quick-edit .form-select:focus{border-color:var(--teal);outline:none}
.quick-edit__actions{display:flex;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid rgba(14,165,160,.2)}
.empty-state{text-align:center;padding:40px;color:var(--gray-400);font-size:.92rem}
.btn-new{display:inline-flex;align-items:center;gap:5px;padding:7px 16px;background:var(--ginger);color:#fff;border:none;border-radius:6px;font-size:.85rem;font-weight:700;cursor:pointer;font-family:inherit;text-decoration:none;transition:background .2s}
.btn-new:hover{background:#D9531E}
/* Modal for Add/Edit */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:#fff;border-radius:12px;width:640px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal__header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid var(--gray-200)}
.modal__header h3{font-size:1rem;font-weight:700;color:var(--navy)}.modal__close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--gray-400)}
.modal__body{padding:20px 24px}.modal__body .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.modal__body .form-group{margin-bottom:14px}.modal__body .form-label{font-size:.78rem;font-weight:700;color:var(--navy);display:block;margin-bottom:4px}
.modal__body .form-input,.modal__body .form-select,.modal__body .form-textarea{width:100%;padding:8px 12px;border:1.5px solid var(--gray-300);border-radius:6px;font-size:.85rem;font-family:inherit}
.modal__body .form-input:focus,.modal__body .form-select:focus{border-color:var(--teal);outline:none}
.modal__footer{display:flex;justify-content:flex-end;gap:10px;padding:16px 24px;border-top:1px solid var(--gray-200)}
.modal__footer .btn{padding:8px 20px;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;font-family:inherit;border:none}
.modal__footer .btn--outline{background:var(--gray-50);color:var(--gray-600);border:1px solid var(--gray-300)}.modal__footer .btn--outline:hover{background:var(--gray-100)}
.modal__footer .btn--primary{background:var(--ginger);color:#fff}.modal__footer .btn--primary:hover{background:#D9531E}
</style>
<script src="/js/sidebar.js" defer></script>
</head>
<body><div class="layout"><aside class="sidebar" id="sidebar"></aside>

<main class="main"><header class="topbar"><button class="topbar__menu" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button><h1 class="topbar__title" id="pageTitle">Videos</h1><div class="topbar__actions"><button class="btn-new" onclick="openAddModal()">+ Add Video</button></div></header>
<div class="content">
    <!-- Status Tabs -->
    <div class="status-tabs" id="statusTabs">
        <button class="status-tab active" onclick="setStatusTab('')" data-status="">All <span class="count" id="countAll"></span></button>
        <span class="tab-sep">|</span>
        <button class="status-tab" onclick="setStatusTab('published')" data-status="published">Published <span class="count" id="countPublished"></span></button>
        <span class="tab-sep">|</span>
        <button class="status-tab" onclick="setStatusTab('draft')" data-status="draft">Drafts <span class="count" id="countDraft"></span></button>
    </div>

    <!-- Selected Bar -->
    <div class="selected-bar" id="selectedBar"><span id="selectedCount">0 selected</span><button class="btn-clear" onclick="clearSelection()">Clear</button></div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="bulk-bar">
            <select id="bulkAction"><option value="">Bulk Actions</option><option value="publish">Set Published</option><option value="draft">Set Draft</option><option value="delete">Move to Trash</option></select>
            <button class="btn-apply" onclick="applyBulk()">Apply</button>
        </div>
        <div class="filter-group">
            <select id="specFilter" onchange="doFilter()"><option value="">All Specialties</option></select>
        </div>
        <div class="search-wrap"><input type="text" placeholder="Search videos..." id="searchInput" oninput="doFilter()"></div>
        <div class="pagination-info">
            <span id="pageInfo"></span>
            <button class="pag-btn" id="prevBtn" onclick="changePage(-1)" disabled>‚Äπ</button>
            <button class="pag-btn" id="nextBtn" onclick="changePage(1)" disabled>‚Ä∫</button>
            <select id="perPage" onchange="perPage=parseInt(this.value);curPage=1;doFilter()"><option value="20">20</option><option value="50">50</option><option value="100">100</option></select>
        </div>
    </div>

    <!-- Table -->
    <div class="card"><div class="card__body" style="padding:0;overflow-x:auto">
        <table class="data-table">
        <thead><tr>
            <th class="cb-cell"><input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes(this.checked)"></th>
            <th style="width:90px">Thumb</th>
            <th onclick="sortBy('title')">Title <span class="sort-icon">‚Üï</span></th>
            <th>Linked To</th>
            <th onclick="sortBy('featured')">Featured <span class="sort-icon">‚Üï</span></th>
            <th onclick="sortBy('status')">Status <span class="sort-icon">‚Üï</span></th>
            <th onclick="sortBy('date')">Date <span class="sort-icon">‚Üï</span></th>
        </tr></thead>
        <tbody id="list"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody>
        </table>
    </div></div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="modal">
<div class="modal"><div class="modal__header"><h3 id="modalTitle">Add Video</h3><button class="modal__close" onclick="closeModal()">‚úï</button></div>
<div class="modal__body">
    <div class="form-group"><label class="form-label">Title *</label><input class="form-input" id="f_title" placeholder="Video title" oninput="autoSlug()"></div>
    <div class="form-row">
        <div class="form-group"><label class="form-label">YouTube URL *</label><input class="form-input" id="f_youtube_url" placeholder="https://youtube.com/watch?v=..." oninput="autoThumb()"></div>
        <div class="form-group"><label class="form-label">Slug</label><input class="form-input" id="f_slug" placeholder="auto-generated"></div>
    </div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="f_description" rows="2" placeholder="Brief description"></textarea></div>
    <div class="form-row">
        <div class="form-group"><label class="form-label">Doctor</label><select class="form-select" id="f_doctor_id"></select></div>
        <div class="form-group"><label class="form-label">Hospital</label><select class="form-select" id="f_hospital_id"></select></div>
    </div>
    <div class="form-row">
        <div class="form-group"><label class="form-label">Specialty</label><select class="form-select" id="f_specialty_id"></select></div>
        <div class="form-group"><label class="form-label">Treatment</label><select class="form-select" id="f_treatment_id"></select></div>
    </div>
    <div class="form-row">
        <div class="form-group"><label class="form-label">Sort Order</label><input class="form-input" type="number" id="f_sort_order" value="0"></div>
        <div class="form-group"><label class="form-label">Featured</label><select class="form-select" id="f_featured"><option value="false">No</option><option value="true">Yes ‚≠ê</option></select></div>
    </div>
    <div class="form-row">
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="f_status"><option value="draft">Draft</option><option value="published">Published</option></select></div>
        <div class="form-group"><label class="form-label">Thumbnail</label><input class="form-input" id="f_thumbnail" placeholder="Auto-extracted from YouTube"></div>
    </div>
</div>
<div class="modal__footer"><button class="btn btn--outline" onclick="closeModal()">Cancel</button><button class="btn btn--primary" onclick="saveItem()">üíæ Save</button></div>
</div></div>

</main></div>

<script>
const API = '/api/videos';
let items = [], allDoctors = [], allHospitals = [], allSpecialties = [], allTreatments = [];
let selectedIds = new Set(), curPage = 1, perPage = 20;
let sortField = 'date', sortDir = 'desc', activeStatusTab = '', editId = null;

async function safeFetch(u, o) {
    for (let i = 0; i < 3; i++) {
        try { const r = await fetch(u, o); if (r.status === 429) { await new Promise(ok => setTimeout(ok, 1000 * (i + 1))); continue; } return r; }
        catch(e) { if (i === 2) throw e; await new Promise(ok => setTimeout(ok, 1000)); }
    }
}

async function loadDropdowns() {
    try {
        const [dr, hr, sr, tr] = await Promise.all([safeFetch('/api/doctors'), safeFetch('/api/hospitals'), safeFetch('/api/specialties'), safeFetch('/api/treatments')]);
        allDoctors = await dr.json(); allHospitals = await hr.json(); allSpecialties = await sr.json(); allTreatments = await tr.json();
        document.getElementById('f_doctor_id').innerHTML = '<option value="">‚Äî None ‚Äî</option>' + allDoctors.map(d => '<option value="' + d.id + '">' + d.name + '</option>').join('');
        document.getElementById('f_hospital_id').innerHTML = '<option value="">‚Äî None ‚Äî</option>' + allHospitals.map(h => '<option value="' + h.id + '">' + h.name + '</option>').join('');
        document.getElementById('f_specialty_id').innerHTML = '<option value="">‚Äî None ‚Äî</option>' + allSpecialties.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
        document.getElementById('f_treatment_id').innerHTML = '<option value="">‚Äî None ‚Äî</option>' + allTreatments.map(t => '<option value="' + t.id + '">' + t.name + '</option>').join('');
        // Specialty filter in toolbar
        document.getElementById('specFilter').innerHTML = '<option value="">All Specialties</option>' + allSpecialties.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
    } catch(e) { console.error('Dropdown load failed', e); }
}

async function load() {
    try {
        const r = await safeFetch(API);
        if (!r || !r.ok) return;
        items = await r.json();
        updateCounts();
        doFilter();
    } catch(e) { document.getElementById('list').innerHTML = '<tr><td colspan="7" class="empty-state">Error loading. Please refresh.</td></tr>'; }
}

function updateCounts() {
    const pub = items.filter(v => v.status === 'published').length;
    const dra = items.filter(v => v.status === 'draft').length;
    document.getElementById('countAll').textContent = '(' + items.length + ')';
    document.getElementById('countPublished').textContent = '(' + pub + ')';
    document.getElementById('countDraft').textContent = '(' + dra + ')';
    document.getElementById('pageTitle').textContent = 'Videos (' + items.length + ')';
}

function setStatusTab(status) {
    activeStatusTab = status; curPage = 1;
    document.querySelectorAll('.status-tab').forEach(t => t.classList.toggle('active', t.dataset.status === status));
    doFilter();
}

function doFilter() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const specId = document.getElementById('specFilter').value;
    let filtered = items.filter(v =>
        (!activeStatusTab || v.status === activeStatusTab) &&
        (!q || v.title.toLowerCase().includes(q) || (v.description || '').toLowerCase().includes(q) || (v.doctor_name || '').toLowerCase().includes(q) || (v.hospital_name || '').toLowerCase().includes(q)) &&
        (!specId || v.specialty_id == specId)
    );
    filtered.sort((a, b) => {
        let va, vb;
        if (sortField === 'title') { va = a.title.toLowerCase(); vb = b.title.toLowerCase(); }
        else if (sortField === 'status') { va = a.status; vb = b.status; }
        else if (sortField === 'featured') { va = a.is_featured ? 1 : 0; vb = b.is_featured ? 1 : 0; }
        else { va = a.created_at || ''; vb = b.created_at || ''; }
        if (va < vb) return sortDir === 'asc' ? -1 : 1;
        if (va > vb) return sortDir === 'asc' ? 1 : -1;
        return 0;
    });
    const total = filtered.length, totalPages = Math.max(1, Math.ceil(total / perPage));
    if (curPage > totalPages) curPage = totalPages;
    const start = (curPage - 1) * perPage, page = filtered.slice(start, start + perPage);
    document.getElementById('pageInfo').textContent = total + ' items ¬∑ page ' + curPage + ' of ' + totalPages;
    document.getElementById('prevBtn').disabled = curPage <= 1;
    document.getElementById('nextBtn').disabled = curPage >= totalPages;
    renderTable(page);
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function renderTable(filtered) {
    const tb = document.getElementById('list');
    if (!filtered.length) { tb.innerHTML = '<tr><td colspan="7" class="empty-state">No videos found. Click "+ Add Video" to create one.</td></tr>'; return; }
    tb.innerHTML = filtered.map(v => {
        const checked = selectedIds.has(v.id) ? 'checked' : '';
        const selClass = selectedIds.has(v.id) ? ' selected' : '';
        const dateStr = new Date(v.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = new Date(v.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        const thumb = v.thumbnail || getYTThumb(v.youtube_url);
        const tags = [];
        if (v.doctor_name) tags.push('<span class="tag-pill tag-pill--doc">üë®‚Äç‚öïÔ∏è ' + esc(v.doctor_name) + '</span>');
        if (v.hospital_name) tags.push('<span class="tag-pill tag-pill--hosp">üè• ' + esc(v.hospital_name) + '</span>');
        if (v.specialty_name) tags.push('<span class="tag-pill tag-pill--spec">' + esc(v.specialty_name) + '</span>');
        if (v.treatment_name) tags.push('<span class="tag-pill tag-pill--treat">' + esc(v.treatment_name) + '</span>');
        return `
        <tr id="row-${v.id}" class="${selClass}">
            <td class="cb-cell"><input type="checkbox" ${checked} onchange="toggleSelect(${v.id}, this.checked)"></td>
            <td><div class="vid-thumb">${thumb ? '<img src="' + esc(thumb) + '" loading="lazy">' : 'üé¨'}<a href="${esc(v.youtube_url)}" target="_blank"><div class="vid-thumb__play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div></a></div></td>
            <td class="post-title-cell">
                <strong><a href="#" onclick="openEditModal(${v.id});return false">${esc(v.title)}</a></strong>
                <div class="row-actions">
                    <a href="#" onclick="openEditModal(${v.id});return false">Edit</a>
                    <span class="sep">|</span>
                    <button onclick="toggleQuickEdit(${v.id})">Quick Edit</button>
                    <span class="sep">|</span>
                    <a href="${esc(v.youtube_url)}" target="_blank">Watch</a>
                    ${v.status === 'published' ? '<span class="sep">|</span><a href="https://ginger.healthcare/videos/" target="_blank">View Page</a>' : ''}
                    <span class="sep">|</span>
                    <button class="act-del" onclick="deleteItem(${v.id})">Trash</button>
                </div>
            </td>
            <td>${tags.join(' ') || '<span style="color:var(--gray-400)">‚Äî</span>'}</td>
            <td style="text-align:center">${v.is_featured ? '<span class="featured-star">‚òÖ</span>' : ''}</td>
            <td><span class="badge badge--${v.status}">${v.status}</span></td>
            <td class="date-cell">${dateStr}<br><span class="date-sub">${timeStr}</span></td>
        </tr>
        <tr class="quick-edit-row" id="qe-row-${v.id}" style="display:none">
            <td colspan="7" style="padding:0;border:none">
                <div class="quick-edit">
                    <div class="quick-edit__title">QUICK EDIT ‚Äî ${esc(v.title)}</div>
                    <div class="quick-edit__grid">
                        <div>
                            <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="qe-title-${v.id}" value="${esc(v.title)}"></div>
                            <div class="form-group" style="margin-top:10px"><label class="form-label">Slug</label><input class="form-input" id="qe-slug-${v.id}" value="${esc(v.slug)}"></div>
                        </div>
                        <div>
                            <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="qe-status-${v.id}"><option value="draft" ${v.status==='draft'?'selected':''}>Draft</option><option value="published" ${v.status==='published'?'selected':''}>Published</option></select></div>
                            <div class="form-group" style="margin-top:10px"><label class="form-label">Featured</label><select class="form-select" id="qe-featured-${v.id}"><option value="false" ${!v.is_featured?'selected':''}>No</option><option value="true" ${v.is_featured?'selected':''}>Yes ‚≠ê</option></select></div>
                        </div>
                        <div>
                            <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="qe-desc-${v.id}" rows="3" style="font-size:.82rem">${esc(v.description||'')}</textarea></div>
                            <div class="form-group" style="margin-top:10px"><label class="form-label">Sort Order</label><input class="form-input" type="number" id="qe-sort-${v.id}" value="${v.sort_order||0}"></div>
                        </div>
                    </div>
                    <div class="quick-edit__actions">
                        <button class="btn btn--primary btn--sm" onclick="quickSave(${v.id})" style="padding:6px 16px;font-size:.82rem">üíæ Update</button>
                        <button class="btn btn--outline btn--sm" onclick="toggleQuickEdit(${v.id})" style="padding:6px 16px;font-size:.82rem">Cancel</button>
                    </div>
                </div>
            </td>
        </tr>`;
    }).join('');
    document.getElementById('selectAll').checked = false;
}

// Selection
function toggleSelect(id, checked) {
    if (checked) selectedIds.add(id); else selectedIds.delete(id);
    updateSelectionUI();
    const row = document.getElementById('row-' + id);
    if (row) row.classList.toggle('selected', checked);
}
function toggleAllCheckboxes(checked) {
    document.querySelectorAll('#list input[type="checkbox"]').forEach(cb => {
        cb.checked = checked;
        const tr = cb.closest('tr'); if (!tr || !tr.id.startsWith('row-')) return;
        const id = parseInt(tr.id.replace('row-', ''));
        if (id) { if (checked) selectedIds.add(id); else selectedIds.delete(id); tr.classList.toggle('selected', checked); }
    });
    updateSelectionUI();
}
function updateSelectionUI() {
    const bar = document.getElementById('selectedBar');
    if (selectedIds.size) { bar.style.display = 'flex'; document.getElementById('selectedCount').textContent = selectedIds.size + ' video' + (selectedIds.size > 1 ? 's' : '') + ' selected'; }
    else { bar.style.display = 'none'; }
}
function clearSelection() {
    selectedIds.clear();
    document.querySelectorAll('#list input[type="checkbox"]').forEach(cb => { cb.checked = false; const tr = cb.closest('tr'); if (tr) tr.classList.remove('selected'); });
    document.getElementById('selectAll').checked = false; updateSelectionUI();
}

// Bulk Actions
async function applyBulk() {
    const action = document.getElementById('bulkAction').value;
    if (!action) return alert('Select a bulk action');
    if (!selectedIds.size) return alert('Select at least one video');
    const labels = { publish: 'publish', draft: 'set to draft', delete: 'permanently delete' };
    if (!confirm('Are you sure you want to ' + labels[action] + ' ' + selectedIds.size + ' video(s)?')) return;
    let success = 0;
    for (const id of selectedIds) {
        try {
            if (action === 'delete') { await fetch(API + '/' + id, { method: 'DELETE' }); success++; }
            else { const r = await fetch(API + '/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...items.find(v => v.id === id), status: action === 'publish' ? 'published' : 'draft' }) }); if (r.ok) success++; }
        } catch(e) {}
    }
    alert('‚úÖ ' + success + ' video(s) updated');
    selectedIds.clear(); document.getElementById('bulkAction').value = '';
    load();
}

// Sorting
function sortBy(field) {
    if (sortField === field) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
    else { sortField = field; sortDir = field === 'date' ? 'desc' : 'asc'; }
    doFilter();
}
function changePage(dir) { curPage += dir; doFilter(); window.scrollTo({ top: 0, behavior: 'smooth' }); }

// Quick Edit
function toggleQuickEdit(id) { const row = document.getElementById('qe-row-' + id); row.style.display = row.style.display === 'none' ? '' : 'none'; }
async function quickSave(id) {
    const v = items.find(x => x.id === id); if (!v) return;
    const data = {
        ...v,
        title: document.getElementById('qe-title-' + id).value,
        slug: document.getElementById('qe-slug-' + id).value,
        status: document.getElementById('qe-status-' + id).value,
        is_featured: document.getElementById('qe-featured-' + id).value === 'true',
        description: document.getElementById('qe-desc-' + id).value,
        sort_order: parseInt(document.getElementById('qe-sort-' + id).value) || 0
    };
    try { const r = await fetch(API + '/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (r.ok) load(); else alert('Save failed'); }
    catch(e) { alert('Save failed'); }
}

// Delete
async function deleteItem(id) {
    if (!confirm('Delete this video permanently?')) return;
    try { await fetch(API + '/' + id, { method: 'DELETE' }); selectedIds.delete(id); load(); } catch(e) { alert('Delete failed'); }
}

// Modal
function openAddModal() {
    editId = null; document.getElementById('modalTitle').textContent = 'Add Video';
    ['f_title', 'f_slug', 'f_youtube_url', 'f_thumbnail', 'f_description'].forEach(id => document.getElementById(id).value = '');
    ['f_doctor_id', 'f_hospital_id', 'f_specialty_id', 'f_treatment_id'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('f_sort_order').value = '0'; document.getElementById('f_featured').value = 'false'; document.getElementById('f_status').value = 'draft';
    document.getElementById('modal').classList.add('open');
}
function openEditModal(id) {
    const v = items.find(x => x.id === id); if (!v) return;
    editId = id; document.getElementById('modalTitle').textContent = 'Edit: ' + v.title;
    document.getElementById('f_title').value = v.title || '';
    document.getElementById('f_slug').value = v.slug || '';
    document.getElementById('f_youtube_url').value = v.youtube_url || '';
    document.getElementById('f_thumbnail').value = v.thumbnail || '';
    document.getElementById('f_description').value = v.description || '';
    document.getElementById('f_doctor_id').value = v.doctor_id || '';
    document.getElementById('f_hospital_id').value = v.hospital_id || '';
    document.getElementById('f_specialty_id').value = v.specialty_id || '';
    document.getElementById('f_treatment_id').value = v.treatment_id || '';
    document.getElementById('f_sort_order').value = v.sort_order || 0;
    document.getElementById('f_featured').value = v.is_featured ? 'true' : 'false';
    document.getElementById('f_status').value = v.status || 'draft';
    document.getElementById('modal').classList.add('open');
}
function closeModal() { document.getElementById('modal').classList.remove('open'); }

async function saveItem() {
    const data = {
        title: document.getElementById('f_title').value,
        slug: document.getElementById('f_slug').value,
        youtube_url: document.getElementById('f_youtube_url').value,
        thumbnail: document.getElementById('f_thumbnail').value,
        description: document.getElementById('f_description').value,
        doctor_id: document.getElementById('f_doctor_id').value || null,
        hospital_id: document.getElementById('f_hospital_id').value || null,
        specialty_id: document.getElementById('f_specialty_id').value || null,
        treatment_id: document.getElementById('f_treatment_id').value || null,
        sort_order: parseInt(document.getElementById('f_sort_order').value) || 0,
        is_featured: document.getElementById('f_featured').value === 'true',
        status: document.getElementById('f_status').value
    };
    if (!data.title || !data.youtube_url) return alert('Title and YouTube URL are required');
    if (!data.slug) data.slug = data.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    if (!data.thumbnail) data.thumbnail = getYTThumb(data.youtube_url);
    try {
        const url = editId ? API + '/' + editId : API;
        const r = await fetch(url, { method: editId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (r.ok) { closeModal(); load(); } else { const e = await r.json(); alert(e.error || 'Save failed'); }
    } catch(e) { alert('Save failed'); }
}

// Helpers
function getYTThumb(url) {
    if (!url) return '';
    let id = '';
    if (url.includes('youtu.be/')) id = url.split('youtu.be/')[1].split(/[?&#]/)[0];
    else if (url.includes('v=')) id = url.split('v=')[1].split(/[&#]/)[0];
    else if (url.includes('/embed/')) id = url.split('/embed/')[1].split(/[?&#]/)[0];
    return id ? 'https://img.youtube.com/vi/' + id + '/mqdefault.jpg' : '';
}
function autoSlug() {
    if (!editId) document.getElementById('f_slug').value = document.getElementById('f_title').value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}
function autoThumb() {
    const thumb = getYTThumb(document.getElementById('f_youtube_url').value);
    if (thumb) document.getElementById('f_thumbnail').value = thumb;
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); clearSelection(); } });
loadDropdowns();
load();
</script>
</body></html>
