<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Library | Ginger Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/admin.css">
<style>
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:16px}
.media-item{border:1.5px solid var(--gray-200);border-radius:12px;overflow:hidden;background:var(--white);transition:all .2s;position:relative}
.media-item:hover{border-color:var(--teal);box-shadow:0 4px 16px rgba(0,0,0,.08)}
.media-item__img{height:150px;background:var(--gray-100);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
.media-item__img img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
.media-item:hover .media-item__img img{transform:scale(1.05)}
.media-item__img .file-icon{font-size:3rem;color:var(--gray-300)}
.media-item__info{padding:10px 12px}
.media-item__name{font-size:.78rem;font-weight:600;color:var(--navy);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px}
.media-item__meta{display:flex;justify-content:space-between;align-items:center;font-size:.7rem;color:var(--gray-400);margin-bottom:8px}
.media-item__actions{display:flex;gap:6px}
.media-item__actions button{flex:1;padding:6px;border:1px solid var(--gray-200);border-radius:6px;font-size:.72rem;font-weight:600;cursor:pointer;transition:all .15s;background:var(--white);color:var(--gray-500)}
.btn-copy:hover{background:var(--teal)!important;color:#fff!important;border-color:var(--teal)!important}
.btn-del:hover{background:#EF4444!important;color:#fff!important;border-color:#EF4444!important}
.upload-zone{border:2px dashed var(--gray-300);border-radius:12px;padding:40px;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.upload-zone:hover{border-color:var(--ginger);background:rgba(242,101,34,.03)}
.upload-zone.dragover{border-color:var(--ginger);background:rgba(242,101,34,.06)}
.upload-progress{display:none;margin-top:12px;font-size:.85rem;color:var(--teal);font-weight:600}
.stats-bar{display:flex;gap:12px;flex-wrap:wrap}
.stat-pill{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:8px;padding:6px 14px;font-size:.8rem;color:var(--gray-500);font-weight:500}
.stat-pill b{color:var(--navy)}
.copied-toast{position:fixed;bottom:24px;right:24px;background:var(--navy);color:#fff;padding:12px 20px;border-radius:8px;font-size:.85rem;font-weight:600;z-index:999;display:none;box-shadow:0 4px 16px rgba(0,0,0,.2)}
.url-box{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:6px;padding:5px 8px;font-size:.68rem;font-family:monospace;color:var(--gray-500);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:8px;cursor:pointer}
.url-box:hover{background:var(--teal);color:#fff;border-color:var(--teal)}
</style>
<script src="/js/sidebar.js" defer></script>
</head><body>
<div class="layout"><aside class="sidebar" id="sidebar"></aside>
<main class="main">
<header class="topbar">
    <button class="topbar__menu" onclick="document.getElementById('sidebar').classList.toggle('open')">&#9776;</button>
    <h1 class="topbar__title">Media Library</h1>
</header>
<div class="content">
    <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" style="display:none" accept="image/*,.pdf,.webp,.svg" multiple onchange="uploadFiles(this)">
        <div style="font-size:2rem;margin-bottom:8px">&#x1F4C1;</div>
        <p style="color:var(--gray-500)"><strong>Click to upload</strong> or drag and drop</p>
        <p style="font-size:.8rem;color:var(--gray-400)">JPG, PNG, WebP, SVG, PDF &mdash; Max 10MB</p>
        <div class="upload-progress" id="uploadProgress"></div>
    </div>
    <div class="stats-bar" id="statsBar"></div>
    <div class="media-grid" id="mediaGrid"><div class="loading">Loading...</div></div>
</div>
</main></div>

<div class="copied-toast" id="copiedToast"></div>

<script>
var allMedia = [];

async function load() {
    try {
        var r = await fetch('/api/media');
        if (!r.ok) throw new Error('Failed');
        allMedia = await r.json();
    } catch(e) {
        allMedia = [];
    }
    renderGrid();
}

function renderGrid() {
    var grid = document.getElementById('mediaGrid');
    var stats = document.getElementById('statsBar');

    if (!allMedia.length) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--gray-400)"><div style="font-size:3rem;margin-bottom:12px">&#x1F5BC;</div><p style="font-weight:600;color:var(--navy)">No media uploaded yet</p><p style="font-size:.85rem">Upload images to use in your blog posts and content</p></div>';
        stats.innerHTML = '';
        return;
    }

    var totalSize = 0;
    var imgCount = 0;
    for (var i = 0; i < allMedia.length; i++) {
        totalSize += (allMedia[i].size || 0);
        if (allMedia[i].mime_type && allMedia[i].mime_type.indexOf('image') === 0) imgCount++;
    }
    stats.innerHTML = '<span class="stat-pill"><b>' + allMedia.length + '</b> files</span><span class="stat-pill"><b>' + imgCount + '</b> images</span><span class="stat-pill"><b>' + fmtSize(totalSize) + '</b> total</span>';

    var html = '';
    for (var i = 0; i < allMedia.length; i++) {
        var m = allMedia[i];
        var isImg = m.mime_type && m.mime_type.indexOf('image') === 0;
        var preview = isImg
            ? '<img src="' + m.url + '" alt="' + he(m.original_name || '') + '">'
            : '<span class="file-icon">&#x1F4C4;</span>';
        html += '<div class="media-item">';
        html += '<div class="media-item__img" onclick="copyUrl(\'' + he(m.url) + '\')" title="Click image to copy URL">' + preview + '</div>';
        html += '<div class="media-item__info">';
        html += '<div class="media-item__name" title="' + he(m.original_name || '') + '">' + he(m.original_name || 'Untitled') + '</div>';
        html += '<div class="url-box" onclick="copyUrl(\'' + he(m.url) + '\')" title="Click to copy URL">' + he(m.url) + '</div>';
        html += '<div class="media-item__meta"><span>' + fmtSize(m.size) + '</span><span>' + timeAgo(m.created_at) + '</span></div>';
        html += '<div class="media-item__actions">';
        html += '<button class="btn-copy" onclick="copyUrl(\'' + he(m.url) + '\')">&#x1F4CB; Copy URL</button>';
        html += '<button class="btn-del" onclick="delMedia(' + m.id + ',\'' + he(m.original_name || '') + '\')">&#x1F5D1;</button>';
        html += '</div></div></div>';
    }
    grid.innerHTML = html;
}

function copyUrl(url) {
    navigator.clipboard.writeText(url).then(function() {
        var toast = document.getElementById('copiedToast');
        toast.innerHTML = '&#x2705; Copied: ' + url;
        toast.style.display = 'block';
        setTimeout(function(){ toast.style.display = 'none'; }, 2500);
    }).catch(function() {
        prompt('Copy this URL:', url);
    });
}

async function delMedia(id, name) {
    if (!confirm('Delete "' + name + '"?')) return;
    try {
        var r = await fetch('/api/media/' + id, { method: 'DELETE' });
        if (r.ok) load();
        else alert('Delete failed');
    } catch(e) { alert('Error: ' + e.message); }
}

async function uploadFiles(input) {
    var files = input.files;
    if (!files.length) return;
    var prog = document.getElementById('uploadProgress');
    prog.style.display = 'block';
    var ok = 0;
    for (var i = 0; i < files.length; i++) {
        prog.textContent = 'Uploading ' + (i+1) + ' of ' + files.length + '...';
        var fd = new FormData();
        fd.append('file', files[i]);
        try {
            var r = await fetch('/api/media/upload', { method: 'POST', body: fd });
            if (r.ok) ok++;
        } catch(e) {}
    }
    prog.innerHTML = '&#x2705; Uploaded ' + ok + ' file(s)!';
    setTimeout(function(){ prog.style.display = 'none'; }, 2500);
    input.value = '';
    load();
}

function fmtSize(b) {
    if (!b) return '0 B';
    if (b < 1024) return b + ' B';
    if (b < 1048576) return (b/1024).toFixed(0) + ' KB';
    return (b/1048576).toFixed(1) + ' MB';
}

function timeAgo(d) {
    if (!d) return '';
    var s = (Date.now() - new Date(d).getTime()) / 1000;
    if (s < 60) return 'just now';
    if (s < 3600) return Math.floor(s/60) + 'm ago';
    if (s < 86400) return Math.floor(s/3600) + 'h ago';
    if (s < 604800) return Math.floor(s/86400) + 'd ago';
    return new Date(d).toLocaleDateString();
}

function he(s) { return String(s||'').replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

// Drag and drop
var zone = document.getElementById('uploadZone');
zone.addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT') document.getElementById('fileInput').click();
});
zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('dragover'); });
zone.addEventListener('dragleave', function() { zone.classList.remove('dragover'); });
zone.addEventListener('drop', function(e) {
    e.preventDefault(); zone.classList.remove('dragover');
    var dt = e.dataTransfer;
    if (dt.files.length) {
        document.getElementById('fileInput').files = dt.files;
        uploadFiles(document.getElementById('fileInput'));
    }
});

load();
</script>
</body></html>
