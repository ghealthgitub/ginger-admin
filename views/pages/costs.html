<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Manager | Ginger Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        :root {
            --navy: #0B2545; --navy-light: #13315C; --ginger: #F26522; --ginger-light: #FF8A50;
            --teal: #0EA5A0; --teal-light: #14B8B3; --green: #059669; --green-light: #10B981;
            --red: #DC2626; --yellow: #F59E0B; --cream: #FFF8F0;
            --gray-50: #F9FAFB; --gray-100: #F3F4F6; --gray-200: #E5E7EB; --gray-300: #D1D5DB;
            --gray-400: #9CA3AF; --gray-500: #6B7280; --gray-600: #4B5563; --gray-700: #374151;
            --font-display: 'Playfair Display', Georgia, serif; --font-body: 'DM Sans', system-ui, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-body); background: var(--gray-50); color: var(--gray-700); font-size: 14px; }

        /* â”€â”€â”€ LAYOUT â”€â”€â”€ */
        .cost-app { max-width: 1400px; margin: 0 auto; padding: 24px; }

        /* â”€â”€â”€ HEADER â”€â”€â”€ */
        .cost-header { background: linear-gradient(135deg, var(--navy), var(--navy-light)); border-radius: 16px; padding: 28px 32px; margin-bottom: 24px; color: #fff; display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
        .cost-header__left h1 { font-family: var(--font-display); font-size: 1.6rem; font-weight: 600; margin-bottom: 4px; }
        .cost-header__left p { font-size: .9rem; color: rgba(255,255,255,.55); }
        .cost-header__stats { display: flex; gap: 16px; }
        .cost-stat { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.1); border-radius: 12px; padding: 12px 18px; text-align: center; min-width: 100px; }
        .cost-stat__val { font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; color: var(--teal-light); }
        .cost-stat__label { font-size: .75rem; color: rgba(255,255,255,.5); margin-top: 2px; }

        /* â”€â”€â”€ TOOLBAR â”€â”€â”€ */
        .cost-toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .cost-search { flex: 1; min-width: 250px; position: relative; }
        .cost-search input { width: 100%; padding: 10px 14px 10px 38px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: .9rem; background: #fff; transition: border-color .2s; }
        .cost-search input:focus { outline: none; border-color: var(--teal); }
        .cost-search__icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1rem; color: var(--gray-400); }
        .cost-filter { padding: 10px 16px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: .9rem; background: #fff; color: var(--gray-700); cursor: pointer; transition: border-color .2s; }
        .cost-filter:focus { outline: none; border-color: var(--teal); }
        .btn-sm { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: .85rem; border: none; cursor: pointer; transition: all .2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-sm--teal { background: var(--teal); color: #fff; }
        .btn-sm--teal:hover { background: #0c918c; }
        .btn-sm--ginger { background: var(--ginger); color: #fff; }
        .btn-sm--ginger:hover { background: #d9531e; }
        .btn-sm--outline { background: #fff; color: var(--gray-600); border: 2px solid var(--gray-200); }
        .btn-sm--outline:hover { border-color: var(--gray-400); }

        /* â”€â”€â”€ SPECIALTY GROUP â”€â”€â”€ */
        .spec-group { background: #fff; border-radius: 14px; border: 1.5px solid var(--gray-200); margin-bottom: 16px; overflow: hidden; transition: box-shadow .2s; }
        .spec-group:hover { box-shadow: 0 4px 16px rgba(0,0,0,.04); }
        .spec-group__header { display: flex; align-items: center; gap: 12px; padding: 16px 20px; cursor: pointer; user-select: none; border-bottom: 1px solid transparent; transition: all .2s; background: var(--gray-50); }
        .spec-group__header:hover { background: var(--gray-100); }
        .spec-group.open .spec-group__header { border-bottom-color: var(--gray-200); background: #fff; }
        .spec-group__icon { font-size: 1.4rem; }
        .spec-group__name { font-weight: 700; font-size: 1rem; color: var(--navy); flex: 1; }
        .spec-group__count { font-size: .8rem; color: var(--gray-400); background: var(--gray-100); padding: 3px 10px; border-radius: 50px; }
        .spec-group__filled { font-size: .8rem; color: var(--green); background: #F0FDF4; padding: 3px 10px; border-radius: 50px; }
        .spec-group__chevron { font-size: .85rem; color: var(--gray-400); transition: transform .25s; }
        .spec-group.open .spec-group__chevron { transform: rotate(180deg); }
        .spec-group__body { display: none; }
        .spec-group.open .spec-group__body { display: block; }

        /* â”€â”€â”€ COST TABLE â”€â”€â”€ */
        .cost-table { width: 100%; border-collapse: collapse; }
        .cost-table thead th { padding: 10px 12px; font-size: .75rem; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: var(--gray-500); background: var(--gray-50); border-bottom: 2px solid var(--gray-200); text-align: left; position: sticky; top: 0; white-space: nowrap; }
        .cost-table thead th.dest-col { text-align: center; min-width: 180px; }
        .cost-table thead th.dest-col .flag { font-size: 1rem; display: block; margin-bottom: 2px; }
        .cost-table thead th.usa-col { text-align: center; min-width: 130px; background: #FEF2F2; color: var(--red); }
        .cost-table tbody tr { border-bottom: 1px solid var(--gray-100); transition: background .15s; }
        .cost-table tbody tr:hover { background: #F0FDFA; }
        .cost-table tbody td { padding: 10px 12px; vertical-align: middle; }
        .cost-table .treat-name { font-weight: 600; color: var(--navy); font-size: .9rem; max-width: 200px; }
        .cost-table .treat-name small { display: block; font-weight: 400; color: var(--gray-400); font-size: .75rem; }
        .cost-table .treat-duration { font-size: .8rem; color: var(--gray-500); white-space: nowrap; }

        /* â”€â”€â”€ COST CELL â”€â”€â”€ */
        .cost-cell { display: flex; gap: 4px; justify-content: center; align-items: center; }
        .cost-cell input { width: 72px; padding: 6px 8px; border: 1.5px solid var(--gray-200); border-radius: 6px; font-size: .85rem; text-align: right; font-family: var(--font-body); color: var(--gray-700); transition: all .2s; background: #fff; }
        .cost-cell input:focus { outline: none; border-color: var(--teal); box-shadow: 0 0 0 3px rgba(14,165,160,.1); }
        .cost-cell input.changed { border-color: var(--yellow); background: #FFFBEB; }
        .cost-cell input.saved { border-color: var(--green); background: #F0FDF4; animation: savedPulse .5s ease; }
        .cost-cell__sep { color: var(--gray-300); font-size: .75rem; font-weight: 500; }
        .cost-cell--empty input { border-style: dashed; color: var(--gray-400); }
        .cost-cell--usa input { border-color: #FECACA; background: #FFF5F5; }
        .cost-cell--usa input:focus { border-color: var(--red); box-shadow: 0 0 0 3px rgba(220,38,38,.1); }

        @keyframes savedPulse { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }

        /* â”€â”€â”€ STATUS INDICATORS â”€â”€â”€ */
        .fill-bar { height: 4px; background: var(--gray-200); border-radius: 4px; overflow: hidden; width: 60px; display: inline-block; vertical-align: middle; margin-left: 6px; }
        .fill-bar__inner { height: 100%; border-radius: 4px; transition: width .3s; }
        .fill-bar__inner--low { background: var(--red); }
        .fill-bar__inner--mid { background: var(--yellow); }
        .fill-bar__inner--high { background: var(--green); }

        /* â”€â”€â”€ TOAST â”€â”€â”€ */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 24px; border-radius: 12px; color: #fff; font-weight: 600; font-size: .9rem; z-index: 1000; transform: translateY(80px); opacity: 0; transition: all .3s ease; display: flex; align-items: center; gap: 8px; box-shadow: 0 8px 24px rgba(0,0,0,.15); }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast--success { background: var(--green); }
        .toast--error { background: var(--red); }
        .toast--saving { background: var(--navy); }

        /* â”€â”€â”€ SAVE BAR (sticky bottom) â”€â”€â”€ */
        .save-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--navy); padding: 14px 24px; display: flex; align-items: center; justify-content: center; gap: 16px; z-index: 100; transform: translateY(100%); transition: transform .3s ease; box-shadow: 0 -4px 20px rgba(0,0,0,.15); }
        .save-bar.show { transform: translateY(0); }
        .save-bar__text { color: rgba(255,255,255,.7); font-size: .9rem; }
        .save-bar__text strong { color: var(--yellow); }
        .save-bar__btn { padding: 10px 28px; border-radius: 10px; font-weight: 700; font-size: .9rem; border: none; cursor: pointer; }
        .save-bar__btn--save { background: var(--teal); color: #fff; }
        .save-bar__btn--save:hover { background: #0c918c; }
        .save-bar__btn--discard { background: rgba(255,255,255,.1); color: rgba(255,255,255,.6); }
        .save-bar__btn--discard:hover { background: rgba(255,255,255,.15); color: #fff; }

        /* â”€â”€â”€ QUICK ADD MODAL â”€â”€â”€ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(11,37,69,.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-overlay.show { display: flex; }
        .modal { background: #fff; border-radius: 16px; max-width: 520px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,.2); }
        .modal__header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; }
        .modal__header h3 { font-family: var(--font-display); font-size: 1.2rem; color: var(--navy); }
        .modal__close { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--gray-400); padding: 4px; }
        .modal__body { padding: 24px; }
        .modal__footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 10px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: .85rem; font-weight: 600; color: var(--navy); margin-bottom: 5px; }
        .form-group select, .form-group input { width: 100%; padding: 10px 14px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: .9rem; font-family: var(--font-body); }
        .form-group select:focus, .form-group input:focus { outline: none; border-color: var(--teal); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
        .empty-hint { text-align: center; padding: 40px 24px; color: var(--gray-400); }
        .empty-hint__icon { font-size: 2.5rem; margin-bottom: 8px; display: block; }
        .empty-hint__text { font-size: .95rem; margin-bottom: 12px; }

        /* â”€â”€â”€ LOADING â”€â”€â”€ */
        .loading { text-align: center; padding: 48px; color: var(--gray-400); }
        .loading__spinner { width: 36px; height: 36px; border: 3px solid var(--gray-200); border-top-color: var(--teal); border-radius: 50%; animation: spin .7s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @media (max-width: 768px) {
            .cost-app { padding: 12px; }
            .cost-header { padding: 20px; flex-direction: column; text-align: center; }
            .cost-header__stats { justify-content: center; }
            .cost-toolbar { flex-direction: column; }
            .cost-search { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="cost-app">
        <!-- HEADER -->
        <div class="cost-header">
            <div class="cost-header__left">
                <h1>ğŸ’° Cost Manager</h1>
                <p>Manage treatment costs across all destinations â€” powers the Cost Calculator</p>
            </div>
            <div class="cost-header__stats">
                <div class="cost-stat"><div class="cost-stat__val" id="statTreatments">â€”</div><div class="cost-stat__label">Treatments</div></div>
                <div class="cost-stat"><div class="cost-stat__val" id="statFilled">â€”</div><div class="cost-stat__label">Costs Set</div></div>
                <div class="cost-stat"><div class="cost-stat__val" id="statCoverage">â€”</div><div class="cost-stat__label">Coverage</div></div>
            </div>
        </div>

        <!-- TOOLBAR -->
        <div class="cost-toolbar">
            <div class="cost-search">
                <span class="cost-search__icon">ğŸ”</span>
                <input type="text" id="searchInput" placeholder="Search treatments, specialties...">
            </div>
            <select class="cost-filter" id="filterSpec">
                <option value="">All Specialties</option>
            </select>
            <select class="cost-filter" id="filterStatus">
                <option value="">All Status</option>
                <option value="filled">Has Costs</option>
                <option value="empty">No Costs</option>
            </select>
            <button class="btn-sm btn-sm--teal" onclick="expandAll()">ğŸ“‚ Expand All</button>
            <button class="btn-sm btn-sm--outline" onclick="collapseAll()">ğŸ“ Collapse All</button>
        </div>

        <!-- CONTENT -->
        <div id="contentArea">
            <div class="loading">
                <div class="loading__spinner"></div>
                Loading treatments & costs...
            </div>
        </div>
    </div>

    <!-- SAVE BAR -->
    <div class="save-bar" id="saveBar">
        <div class="save-bar__text">You have <strong id="changeCount">0</strong> unsaved changes</div>
        <button class="save-bar__btn save-bar__btn--discard" onclick="discardChanges()">Discard</button>
        <button class="save-bar__btn save-bar__btn--save" onclick="saveAll()">ğŸ’¾ Save All Changes</button>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GINGER HEALTHCARE â€” COST MANAGER
   Spreadsheet-style admin for treatment_costs table.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let allDestinations = [];
let allSpecialties = [];
let allTreatments = [];       // flat list from API
let existingCosts = {};       // key: "treatmentId-destId" â†’ { id, cost_min_usd, cost_max_usd, usa_cost }
let pendingChanges = {};      // key: "treatmentId-destId" â†’ { treatment_id, destination_id, cost_min_usd, cost_max_usd, usa_cost }
let treatmentsBySpec = {};    // grouped for display

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
    try {
        const [destRes, specRes, treatRes, costRes] = await Promise.all([
            fetchJSON('/api/destinations'),
            fetchJSON('/api/specialties'),
            fetchJSON('/api/treatments'),
            fetchJSON('/api/costs')
        ]);
        allDestinations = destRes;
        allSpecialties = specRes;
        allTreatments = treatRes;

        // Index existing costs
        existingCosts = {};
        (costRes || []).forEach(c => {
            existingCosts[`${c.treatment_id}-${c.destination_id}`] = c;
        });

        // Group treatments by specialty
        treatmentsBySpec = {};
        allTreatments.forEach(t => {
            const specId = t.specialty_id || 'other';
            if (!treatmentsBySpec[specId]) treatmentsBySpec[specId] = [];
            treatmentsBySpec[specId].push(t);
        });

        // Populate specialty filter
        const filterSpec = document.getElementById('filterSpec');
        allSpecialties.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = `${s.icon || 'ğŸ¥'} ${s.name}`;
            filterSpec.appendChild(opt);
        });

        updateStats();
        render();
    } catch (err) {
        document.getElementById('contentArea').innerHTML = `
            <div class="empty-hint">
                <span class="empty-hint__icon">âš ï¸</span>
                <div class="empty-hint__text">Failed to load data: ${err.message}</div>
                <button class="btn-sm btn-sm--teal" onclick="init()">Retry</button>
            </div>`;
    }
}

async function fetchJSON(url) {
    const res = await fetch(url, { credentials: 'include' });
    if (res.status === 429) { showToast('Rate limited â€” please wait a moment', 'error'); return []; }
    if (!res.ok) throw new Error(`${url} returned ${res.status}`);
    const data = await res.json();
    return Array.isArray(data) ? data : (data.data || data.items || data.rows || []);
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    const container = document.getElementById('contentArea');
    const searchQ = document.getElementById('searchInput').value.toLowerCase();
    const filterSpecId = document.getElementById('filterSpec').value;
    const filterSt = document.getElementById('filterStatus').value;

    let html = '';
    let visibleSpecCount = 0;

    allSpecialties.forEach(spec => {
        if (filterSpecId && String(spec.id) !== filterSpecId) return;

        const treatments = treatmentsBySpec[spec.id] || [];
        if (treatments.length === 0) return;

        // Apply filters
        const filtered = treatments.filter(t => {
            if (searchQ && !t.name.toLowerCase().includes(searchQ) && !spec.name.toLowerCase().includes(searchQ)) return false;
            if (filterSt === 'filled') {
                return allDestinations.some(d => existingCosts[`${t.id}-${d.id}`] || pendingChanges[`${t.id}-${d.id}`]);
            }
            if (filterSt === 'empty') {
                return !allDestinations.some(d => existingCosts[`${t.id}-${d.id}`] || pendingChanges[`${t.id}-${d.id}`]);
            }
            return true;
        });

        if (filtered.length === 0) return;
        visibleSpecCount++;

        // Count how many have costs
        let filledCount = 0;
        filtered.forEach(t => {
            if (allDestinations.some(d => existingCosts[`${t.id}-${d.id}`] || pendingChanges[`${t.id}-${d.id}`])) filledCount++;
        });
        const fillPct = Math.round((filledCount / filtered.length) * 100);
        const fillClass = fillPct < 30 ? 'low' : fillPct < 70 ? 'mid' : 'high';

        html += `
        <div class="spec-group" id="spec-${spec.id}" data-spec-id="${spec.id}">
            <div class="spec-group__header" onclick="toggleGroup(${spec.id})">
                <span class="spec-group__icon">${spec.icon || 'ğŸ¥'}</span>
                <span class="spec-group__name">${spec.name}</span>
                <span class="spec-group__count">${filtered.length} treatments</span>
                <span class="spec-group__filled">${filledCount}/${filtered.length} priced</span>
                <div class="fill-bar"><div class="fill-bar__inner fill-bar__inner--${fillClass}" style="width:${fillPct}%"></div></div>
                <span class="spec-group__chevron">â–¼</span>
            </div>
            <div class="spec-group__body">
                <div class="table-scroll">
                <table class="cost-table">
                    <thead>
                        <tr>
                            <th style="min-width:200px">Treatment</th>
                            <th style="width:70px">Duration</th>
                            ${allDestinations.map(d => `<th class="dest-col"><span class="flag">${d.flag || 'ğŸŒ'}</span>${d.name}</th>`).join('')}
                            <th class="usa-col">ğŸ‡ºğŸ‡¸ USA Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(t => renderTreatmentRow(t)).join('')}
                    </tbody>
                </table>
                </div>
            </div>
        </div>`;
    });

    if (visibleSpecCount === 0) {
        html = `<div class="empty-hint">
            <span class="empty-hint__icon">ğŸ”</span>
            <div class="empty-hint__text">No treatments match your filters</div>
        </div>`;
    }

    container.innerHTML = html;
}

function renderTreatmentRow(t) {
    const destCells = allDestinations.map(d => {
        const key = `${t.id}-${d.id}`;
        const existing = existingCosts[key];
        const pending = pendingChanges[key];
        const minVal = pending ? pending.cost_min_usd : (existing ? existing.cost_min_usd || '' : '');
        const maxVal = pending ? pending.cost_max_usd : (existing ? existing.cost_max_usd || '' : '');
        const isEmpty = !minVal && !maxVal;
        const cls = isEmpty ? 'cost-cell cost-cell--empty' : 'cost-cell';

        return `<td>
            <div class="${cls}">
                <input type="number" placeholder="Min" value="${minVal}" min="0" step="100"
                    data-tid="${t.id}" data-did="${d.id}" data-field="cost_min_usd"
                    onchange="onCostChange(this)" onfocus="this.select()">
                <span class="cost-cell__sep">â€“</span>
                <input type="number" placeholder="Max" value="${maxVal}" min="0" step="100"
                    data-tid="${t.id}" data-did="${d.id}" data-field="cost_max_usd"
                    onchange="onCostChange(this)" onfocus="this.select()">
            </div>
        </td>`;
    }).join('');

    // USA price â€” use first destination's usa_cost if exists, or treatment-level
    const firstDest = allDestinations[0];
    const firstKey = firstDest ? `${t.id}-${firstDest.id}` : null;
    const firstCost = firstKey ? (pendingChanges[firstKey] || existingCosts[firstKey]) : null;
    const usaVal = firstCost ? (firstCost.usa_cost || '') : '';

    return `<tr data-tid="${t.id}">
        <td class="treat-name">${t.name}<small>${t.slug || ''}</small></td>
        <td class="treat-duration">${t.duration || 'â€”'}</td>
        ${destCells}
        <td>
            <div class="cost-cell cost-cell--usa">
                <input type="number" placeholder="USA $" value="${usaVal}" min="0" step="500"
                    data-tid="${t.id}" data-field="usa_cost"
                    onchange="onUsaCostChange(this)" onfocus="this.select()">
            </div>
        </td>
    </tr>`;
}

// â”€â”€â”€ CHANGE TRACKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onCostChange(input) {
    const tid = parseInt(input.dataset.tid);
    const did = parseInt(input.dataset.did);
    const field = input.dataset.field;
    const val = input.value ? parseInt(input.value) : null;
    const key = `${tid}-${did}`;

    if (!pendingChanges[key]) {
        const existing = existingCosts[key] || {};
        pendingChanges[key] = {
            id: existing.id || null,
            treatment_id: tid,
            destination_id: did,
            cost_min_usd: existing.cost_min_usd || null,
            cost_max_usd: existing.cost_max_usd || null,
            usa_cost: existing.usa_cost || null
        };
    }
    pendingChanges[key][field] = val;

    // Visual feedback
    input.classList.add('changed');
    input.classList.remove('saved');

    updateSaveBar();
}

function onUsaCostChange(input) {
    const tid = parseInt(input.dataset.tid);
    const val = input.value ? parseInt(input.value) : null;

    // Set USA cost on ALL destination entries for this treatment
    allDestinations.forEach(d => {
        const key = `${tid}-${d.id}`;
        if (!pendingChanges[key]) {
            const existing = existingCosts[key] || {};
            pendingChanges[key] = {
                id: existing.id || null,
                treatment_id: tid,
                destination_id: d.id,
                cost_min_usd: existing.cost_min_usd || null,
                cost_max_usd: existing.cost_max_usd || null,
                usa_cost: existing.usa_cost || null
            };
        }
        pendingChanges[key].usa_cost = val;
    });

    input.classList.add('changed');
    input.classList.remove('saved');
    updateSaveBar();
}

function updateSaveBar() {
    const count = Object.keys(pendingChanges).length;
    document.getElementById('changeCount').textContent = count;
    document.getElementById('saveBar').classList.toggle('show', count > 0);
}

function discardChanges() {
    pendingChanges = {};
    updateSaveBar();
    render();
    showToast('Changes discarded', 'error');
}

// â”€â”€â”€ SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAll() {
    const changes = Object.values(pendingChanges).filter(c => c.cost_min_usd || c.cost_max_usd);
    if (changes.length === 0) {
        showToast('No costs to save', 'error');
        return;
    }

    showToast('Saving...', 'saving');
    const saveBtn = document.querySelector('.save-bar__btn--save');
    saveBtn.disabled = true;
    saveBtn.textContent = 'â³ Saving...';

    let successCount = 0;
    let errorCount = 0;

    // Save in batches of 10
    for (let i = 0; i < changes.length; i += 10) {
        const batch = changes.slice(i, i + 10);
        const promises = batch.map(async (c) => {
            try {
                const url = c.id ? `/api/costs/${c.id}` : '/api/treatment-costs';
                const method = c.id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        treatment_id: c.treatment_id,
                        destination_id: c.destination_id,
                        cost_min_usd: c.cost_min_usd,
                        cost_max_usd: c.cost_max_usd,
                        usa_cost: c.usa_cost
                    })
                });
                if (res.ok) {
                    const data = await res.json();
                    const key = `${c.treatment_id}-${c.destination_id}`;
                    existingCosts[key] = { ...c, id: data.id || c.id };
                    delete pendingChanges[key];
                    successCount++;
                } else {
                    errorCount++;
                }
            } catch (e) {
                errorCount++;
            }
        });
        await Promise.all(promises);
    }

    saveBtn.disabled = false;
    saveBtn.textContent = 'ğŸ’¾ Save All Changes';
    updateSaveBar();
    updateStats();
    render();

    if (errorCount === 0) {
        showToast(`âœ“ Saved ${successCount} cost entries`, 'success');
    } else {
        showToast(`Saved ${successCount}, failed ${errorCount}`, 'error');
    }
}

// â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleGroup(specId) {
    const el = document.getElementById(`spec-${specId}`);
    el.classList.toggle('open');
}

function expandAll() {
    document.querySelectorAll('.spec-group').forEach(g => g.classList.add('open'));
}

function collapseAll() {
    document.querySelectorAll('.spec-group').forEach(g => g.classList.remove('open'));
}

function updateStats() {
    const totalTreatments = allTreatments.length;
    const totalSlots = totalTreatments * allDestinations.length;
    const filledSlots = Object.keys(existingCosts).length;
    const coverage = totalSlots > 0 ? Math.round((filledSlots / totalSlots) * 100) : 0;

    document.getElementById('statTreatments').textContent = totalTreatments;
    document.getElementById('statFilled').textContent = filledSlots;
    document.getElementById('statCoverage').textContent = coverage + '%';
}

function showToast(msg, type) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = `toast toast--${type} show`;
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => toast.classList.remove('show'), 3000);
}

// â”€â”€â”€ EVENT LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('searchInput').addEventListener('input', debounce(render, 250));
document.getElementById('filterSpec').addEventListener('change', render);
document.getElementById('filterStatus').addEventListener('change', render);

// Keyboard shortcut: Ctrl+S to save
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (Object.keys(pendingChanges).length > 0) saveAll();
    }
});

function debounce(fn, ms) {
    let t; return function(...a) { clearTimeout(t); t = setTimeout(() => fn.apply(this, a), ms); };
}

// â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
